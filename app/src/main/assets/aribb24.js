!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.aribb24=t():e.aribb24=t()}(this,()=>(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{ARIBB24BrazilianInitialParserState:()=>Xe,ARIBB24BrazilianJIS8Tokenizer:()=>St,ARIBB24JIS8Tokenizer:()=>ft,ARIBB24JapaneseInitialParserState:()=>Xe,ARIBB24JapaneseJIS8Encoder:()=>di,ARIBB24JapaneseJIS8Tokenizer:()=>Ut,ARIBB24Parser:()=>We,ARIBB24ParserOption:()=>He,ARIBB24UTF8Encoder:()=>ai,B36Feeder:()=>cr,CanvasMainThreadRenderer:()=>vr,CanvasRenderingOption:()=>dr,CanvasWebWorkerRenderer:()=>xr,Controller:()=>s,EOFError:()=>g,EventType:()=>a,ExhaustivenessError:()=>A,HLSFeeder:()=>er,HTMLFragmentRenderer:()=>ei,MPEGTSFeeder:()=>Qt,NotImplementedError:()=>m,SVGDOMRenderer:()=>Jr,SVGRenderingOption:()=>$r,SpeechRecognitionFeeder:()=>lr,TextRenderer:()=>qr,UnreachableError:()=>U,canvasRenderingStrategy:()=>br,demuxB36:()=>or,demuxDatagroup:()=>Et,demuxIndependentPES:()=>Dt,demuxMPEGTS:()=>Ii,muxB36:()=>Hi,muxDatagroup:()=>Ni,muxIndependentPES:()=>Li,regionerForARIBB24ParsedToken:()=>Ot,svgRenderingStrategy:()=>zr});var r={};e.r(r);class i{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){this.listeners.has(e)&&this.listeners.set(e,this.listeners.get(e).filter(e=>e!==t))}emit(e,t){(this.listeners.get(e)??[]).forEach(e=>{e(t)})}}const a={BuiltinSound:"BuiltinSound"},n=e=>({event:a.BuiltinSound,sound:e});class s{option;media=null;container=null;onContainerResizeHandler=this.onContainerResize.bind(this);resize_observer=null;onVideoResizeHandler=this.onVideoResize.bind(this);onTimeupdateHandler=this.onTimeupdate.bind(this);timer=null;onSeekingHandler=this.onSeeking.bind(this);onPlayHandler=this.onPlay.bind(this);onPauseHandler=this.onPause.bind(this);renderers=[];privious_pts=null;feeder=null;isShowing=!0;emitter=new i;constructor(e){this.option={...e}}attachMedia(e,t){this.container&&this.renderers.forEach(e=>e.onDetach()),this.media=e,this.container=t??e.parentElement,this.container&&this.renderers.forEach(e=>e.onAttach(this.container)),this.feeder?.prepare(this.media.currentTime),this.setupHandlers()}detachMedia(){this.container&&this.renderers.forEach(e=>e.onDetach()),this.cleanupHandlers(),this.media=this.container=null}setupHandlers(){this.media&&this.container&&(this.media.addEventListener("seeking",this.onSeekingHandler),this.media.addEventListener("resize",this.onVideoResizeHandler),this.media.addEventListener("play",this.onPlayHandler),this.media.addEventListener("pause",this.onPauseHandler),this.resize_observer=new ResizeObserver(this.onContainerResizeHandler),this.resize_observer.observe(this.container))}cleanupHandlers(){this.media?.removeEventListener("seeking",this.onSeekingHandler),this.media?.removeEventListener("resize",this.onVideoResizeHandler),this.media?.removeEventListener("play",this.onPlayHandler),this.media?.removeEventListener("pause",this.onPauseHandler),this.container&&this.resize_observer?.unobserve(this.container),this.resize_observer?.disconnect(),this.resize_observer=null}attachFeeder(e){this.detachFeeder(),this.feeder=e,this.feeder.onAttach(),null!=this.media&&this.feeder.prepare(this.media.currentTime)}detachFeeder(){this.feeder?.onDetach(),this.feeder=null}attachRenderer(e){e.onDetach(),this.renderers.push(e),this.container&&e.onAttach(this.container)}detachRenderer(e){e.onDetach(),this.renderers=this.renderers.filter(t=>t!==e)}on(e,t){this.emitter.on(e,t)}off(e,t){this.emitter.off(e,t)}onSeeking(){this.feeder?.onSeeking(),this.renderers.forEach(e=>e.onSeeking()),this.clear()}onContainerResize(e){if(!this.media||!this.container)return;const t=e.find(e=>e.target===this.container);if(!t)return;const r=null!=t.devicePixelContentBoxSize?t.devicePixelContentBoxSize[0].inlineSize:Math.floor(t.contentBoxSize[0].inlineSize*devicePixelRatio),i=null!=t.devicePixelContentBoxSize?t.devicePixelContentBoxSize[0].blockSize:Math.floor(t.contentBoxSize[0].blockSize*devicePixelRatio);this.renderers.forEach(e=>{e.onContainerResize(r,i)&&this.paint(!0)})}onVideoResize(){this.media&&this.container&&this.renderers.forEach(e=>{e.onVideoResize(this.media.videoWidth,this.media.videoHeight)&&this.paint(!0)})}onTimeupdate(){this.isShowing&&(this.registerRenderingLoop(),this.paint(!1))}registerRenderingLoop(){this.timer=requestAnimationFrame(this.onTimeupdateHandler)}unregisterRenderingLoop(){null!=this.timer&&(cancelAnimationFrame(this.timer),this.timer=null)}onPlay(){null!=this.media&&this.feeder?.prepare(this.media.currentTime),this.renderers.forEach(e=>{e.onPlay()}),null==this.timer&&this.registerRenderingLoop()}onPause(){this.renderers.forEach(e=>{e.onPause()}),this.unregisterRenderingLoop()}paint(e){if(!this.media)return;const t=this.media.currentTime,r=this.feeder?.content(t)??null;if(e)null==r||t>=r.pts+r.duration?this.renderers.forEach(e=>e.clear()):this.renderers.forEach(e=>e.render(r.state,structuredClone(r.data),r.info));else if(null==r){if(null==this.privious_pts)return;this.renderers.forEach(e=>e.clear()),this.privious_pts=null}else if(t>=r.pts+r.duration){const e=r.pts+r.duration;if(this.privious_pts===e)return;this.renderers.forEach(e=>e.clear()),this.privious_pts=e}else{if(this.privious_pts===r.pts)return;this.renderers.forEach(e=>e.render(structuredClone(r.state),structuredClone(r.data),structuredClone(r.info))),this.privious_pts=r.pts;for(const e of r.data.filter(e=>"BuiltinSoundReplay"===e.tag))this.emitter.emit(a.BuiltinSound,n(e.sound))}}clear(){this.renderers.forEach(e=>e.clear()),this.privious_pts=null}show(){this.isShowing=!0,null==this.timer&&this.registerRenderingLoop(),this.renderers.forEach(e=>e.show())}hide(){this.isShowing=!1,this.unregisterRenderingLoop(),this.renderers.forEach(e=>e.hide())}showing(){return this.isShowing}}function o(e,t,r){let i="";for(let a=t;a<r;a++)i+=`%${e[a].toString(16).padStart(2,"0")}`;return i}function c(e,t,r){if(TextDecoder){const i=new TextDecoder("utf-8",{fatal:!0}),a=new Uint8Array(e.slice(t,r));return i.decode(a)}return decodeURIComponent(o(e,t,r))}function l(e,t,r){if(TextDecoder){const i=new TextDecoder("iso-8859-1",{fatal:!0}),a=new Uint8Array(e.slice(t,r));return i.decode(a)}return unescape(o(e,t,r))}function d(e){const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r}const h=(e,t,r)=>{let i=0;for(let a=t;a<r;a++)i<<=7,i|=127&e[a];return i},u={from(e){const t=new Uint8Array(e);let r=0;for(;0!==t[r]&&r<t.byteLength;)r++;return{id:"PRIV",owner:l(t,0,r),data:e.slice(r+1)}}},f={from(e){const t=new Uint8Array(e);let r=0;const i=t[r+0],a=r+1;if(3===i){for(;0!==t[r]&&r<t.byteLength;)r++;const e=r;r+=1;const i=r;for(;0!==t[r]&&r<t.byteLength;)r++;const n=r;return{id:"TXXX",description:c(t,a,e),text:c(t,i,n)}}if(0===i){for(;0!==t[r]&&r<t.byteLength;)r++;const e=r;r+=1;const i=r;for(;0!==t[r]&&r<t.byteLength;)r++;const n=r;return{id:"TXXX",description:l(t,a,e),text:l(t,i,n)}}return null}},p=e=>{const t=new Uint8Array(e);let r=[];for(let i=0;i<t.length;){const a=i;if(i+3>t.length)break;if(73!==t[i+0]||68!==t[i+1]||51!==t[i+2]){if(0===i){i+=5;continue}break}if(i+=6,i+4>t.length)break;const n=h(t,i+0,i+4);i+=4;const s=a+3+2+1+4+n;if(s>t.length)break;for(let a=i;a<s;){const i=a;if(a+4>t.length)break;const n=l(t,a+0,a+4);if(a+=4,a+4>t.length)break;const s=h(t,a+0,a+4);a+=6;const o=i+4+4+2+s;if(o>t.length)break;switch(n){case"PRIV":r.push(u.from(e.slice(a,o)));break;case"TXXX":{const t=f.from(e.slice(a,o));null!=t&&r.push(t);break}}a=o}i=a+3+2+1+4+n,i+3>t.length||51===t[i+0]&&68===t[i+1]&&73===t[i+2]&&(i+=10)}return r};class g extends Error{constructor(e,t){super(e,t),this.name=this.constructor.name}}class m extends Error{constructor(e,t){super(e,t),this.name=this.constructor.name}}class b extends Error{constructor(e,t){super(e,t),this.name=this.constructor.name}}class w extends Error{constructor(e,t){super(e,t),this.name=this.constructor.name}}Error;class F extends Error{constructor(e,t){super(e,t),this.name=this.constructor.name}}class A extends Error{constructor(e,t,r){super(`${t}: ${e}}`,r),this.name=this.constructor.name}}class U extends Error{constructor(e,t){super(e,t),this.name=this.constructor.name}}class y{actual=null;compareKey;compareOrder;calculateOrder;constructor(e,t,r){this.compareKey=e,this.compareOrder=t,this.calculateOrder=r}get parent(){return null}get balanced(){return this.actual?.balanced??!0}get bias(){return this.actual?.bias??0}toString(){return`${this.actual}`}refresh(){}rotate(){}has(e){return this.actual?.has(e)??!1}get(e){return this.actual?.get(e)??void 0}floor(e){return this.actual?.floor(e)??void 0}ceil(e){return this.actual?.ceil(e)??void 0}insert(e,t){null==this.actual?this.actual=new C(e,t,this,this.compareKey,this.compareOrder,this.calculateOrder):this.actual.insert(e,t)}delete(e){this.actual?.delete(e)}replace(e,t){null!=e&&this.actual===e&&(e.parent=null,this.actual=t,null!=t&&(t.parent=this))}forEach(e){this.actual?.forEach(e)}*range(e,t){yield*this.actual?.range(e,t)??[]}}class C{key;value;order;parent;left=null;right=null;depth=1;compareKey;compareOrder;calculateOrder;constructor(e,t,r,i,a,n){this.key=e,this.value=t,this.parent=r,this.compareKey=i,this.compareOrder=a,this.calculateOrder=n,this.order=this.calculateOrder(this.key)}refresh(){this.depth=Math.max(this.left?.depth??0,this.right?.depth??0)+1}get balanced(){const e=Math.min(this.left?.depth??0,this.right?.depth??0);return Math.max(this.left?.depth??0,this.right?.depth??0)-e<=1}get bias(){return(this.left?.depth??0)-(this.right?.depth??0)}leftmost(){return null==this.left?this:this.left.leftmost()}rightmost(){return null==this.right?this:this.right.rightmost()}rotateL(){if(null==this.right)return;const e=this.right;this.replace(e,e.left),e.left=this,this.parent?.replace(this,e),this.parent=e,this.refresh(),this.parent?.refresh()}rotateR(){if(null==this.left)return;const e=this.left;this.replace(e,e.right),e.right=this,this.parent?.replace(this,e),this.parent=e,this.refresh(),this.parent?.refresh()}rotateLR(){null!=this.left&&(this.left.rotateL(),this.rotateR())}rotateRL(){null!=this.right&&(this.right.rotateR(),this.rotateL())}rotate(){2===this.bias?(this.left?.bias??0)>=0?this.rotateR():this.rotateLR():-2===this.bias&&((this.right?.bias??0)<=0?this.rotateL():this.rotateRL())}find(e,t="exact"){let r=this;e:for(;;){const i=this.compareKey(e,r.key);switch(i){case 0:return r;case-1:if(null!=r.left){r=r.left;continue e}return"ceil"===t?r:null;case 1:if(null!=r.right){r=r.right;continue e}return"floor"===t?r:null;default:throw new A(i,"Exhaustive check reached!")}}}has(e){return null!=this.find(e,"exact")}get(e){return this.find(e,"exact")?.value??void 0}floor(e){return this.find(e,"floor")?.value??void 0}ceil(e){return this.find(e,"ceil")?.value??void 0}insert(e,t){let r=this;e:for(;;){const i=this.compareKey(e,r.key);switch(i){case 0:return void(r.value=t);case-1:if(null!=r.left){r=r.left;continue e}r.left=new C(e,t,r,this.compareKey,this.compareOrder,this.calculateOrder),r=r.left;break e;case 1:if(null!=r.right){r=r.right;continue e}r.right=new C(e,t,r,this.compareKey,this.compareOrder,this.calculateOrder),r=r.right;break e;default:throw new A(i,"Exhaustive check reached!")}}for(let e=r;null!=e;e=e.parent)e.rotate(),e.refresh()}delete(e){let t=this.find(e);if(null==t)return;const r=t.left?.rightmost(),i=t.right?.leftmost();r?(r.parent?.replace(r,null),t.parent?.replace(t,r),r.right=t.right,null!=t.right&&(t.right.parent=r),r!==t.left&&(r.left=t.left,null!=t.left&&(t.left.parent=r))):i?(i.parent?.replace(i,null),t.parent?.replace(t,i),i.left=t.left,null!=t.left&&(t.left.parent=i),i!==t.right&&(i.right=t.right,null!=t.right&&(t.right.parent=i))):t.parent?.replace(t,null);for(let e=t;null!=e;e=e.parent)e.rotate(),e.refresh()}replace(e,t){this.left===e&&(e.parent===this.left&&(e.parent=null),null!=t&&(t.parent=this),this.left=t),this.right===e&&(e.parent===this.right&&(e.parent=null),null!=t&&(t.parent=this),this.right=t)}forEach(e){null!=this.left&&this.left.forEach(e),e(this.value),null!=this.right&&this.right.forEach(e)}*range(e,t){const r=this.compareOrder(e,this.order),i=this.compareOrder(t,this.order);r<=0&&(yield*this.left?.range(e,t)??[]),r<=0&&i>0&&(yield this.value),i>0&&(yield*this.right?.range(e,t)??[])}}class S{root;compareKey;compareOrder;calculateOrder;constructor(e,t,r){this.compareKey=e,this.compareOrder=t,this.calculateOrder=r,this.root=new y(this.compareKey,this.compareOrder,this.calculateOrder)}clear(){this.root=new y(this.compareKey,this.compareOrder,this.calculateOrder)}has(e){return this.root.has(e)}get(e){return this.root.get(e)}floor(e){return this.root.floor(e)}ceil(e){return this.root.ceil(e)}forEach(e){this.root.forEach(e)}*range(e,t){yield*this.root.range(e,t)}insert(e,t){this.root.insert(e,t)}delete(e){this.root.delete(e)}toString(){return`${this.root}`}}const k=(e,t=!1)=>({tag:"Character",character:e,non_spacing:t}),v=(e,t,r,i,a="")=>({tag:"DRCS",width:e,height:t,depth:r,binary:i,combining:a}),T=(e,t,r,i)=>({tag:"Bitmap",x_position:e,y_position:t,flc_colors:r,binary:i}),M=()=>({tag:"Null"}),_=()=>({tag:"Bell"}),D=()=>({tag:"ActivePositionBackward"}),I=()=>({tag:"ActivePositionForward"}),R=()=>({tag:"ActivePositionDown"}),B=()=>({tag:"ActivePositionUp"}),x=()=>({tag:"ClearScreen"}),E=()=>({tag:"ActivePositionReturn"}),N=e=>({tag:"ParameterizedActivePositionForward",x:e}),L=()=>({tag:"Cancel"}),$=(e,t)=>({tag:"ActivePositionSet",x:e,y:t}),P=()=>({tag:"RecordSeparator"}),z=()=>({tag:"UnitSeparator"}),O=()=>({tag:"Space"}),H=()=>({tag:"Delete"}),G=()=>({tag:"BlackForeground"}),V=()=>({tag:"RedForeground"}),j=()=>({tag:"GreenForeground"}),K=()=>({tag:"YellowForeground"}),J=()=>({tag:"BlueForeground"}),W=()=>({tag:"MagentaForeground"}),X=()=>({tag:"CyanForeground"}),Y=()=>({tag:"WhiteForeground"}),q=()=>({tag:"SmallSize"}),Z=()=>({tag:"MiddleSize"}),Q=()=>({tag:"NormalSize"}),ee=e=>({tag:"CharacterSizeControl",type:e}),te=e=>({tag:"ColorControlForeground",color:e}),re=e=>({tag:"ColorControlBackground",color:e}),ie=e=>({tag:"ColorControlHalfForeground",color:e}),ae=e=>({tag:"ColorControlHalfBackground",color:e}),ne=e=>({tag:"PalletControl",pallet:e}),se=e=>({tag:"FlashingControl",type:e}),oe=e=>({tag:"ConcealmentMode",type:e}),ce=e=>({tag:"SingleConcealmentMode",type:e}),le=e=>({tag:"ReplacingConcealmentMode",type:e}),de=e=>({tag:"PatternPolarityControl",type:e}),he=e=>({tag:"WritingModeModification",type:e}),ue=e=>({tag:"HilightingCharacterBlock",enclosure:e}),fe=e=>({tag:"RepeatCharacter",repeat:e}),pe=()=>({tag:"StartLining"}),ge=()=>({tag:"StopLining"}),me=e=>({tag:"TimeControlWait",seconds:e}),be=e=>({tag:"TimeControlMode",type:e}),we=e=>({tag:"SetWritingFormat",format:e}),Fe=(e,t)=>({tag:"SetDisplayFormat",horizontal:e,vertical:t}),Ae=(e,t)=>({tag:"SetDisplayPosition",horizontal:e,vertical:t}),Ue=(e,t)=>({tag:"CharacterCompositionDotDesignation",horizontal:e,vertical:t}),ye=e=>({tag:"SetHorizontalSpacing",spacing:e}),Ce=e=>({tag:"SetVerticalSpacing",spacing:e}),Se=(e,t)=>({tag:"ActiveCoordinatePositionSet",x:e,y:t}),ke=()=>({tag:"OrnamentControlNone"}),ve=e=>({tag:"OrnamentControlHemming",color:e}),Te=e=>({tag:"OrnamentControlShade",color:e}),Me=()=>({tag:"OrnamentControlHollow"}),_e=e=>({tag:"BuiltinSoundReplay",sound:e}),De=e=>({tag:"RasterColourCommand",color:e});function Ie(e,t=0,r=e.byteLength){let i=-1;for(let a=t;a<r;a++){i^=e[a];for(let e=0;e<8;e++)1&i?i=i>>>1^3988292384:i>>>=1}return~i}const Re="Small",Be="Middle",xe="Normal",Ee="Tiny",Ne="DoubleHeight",Le="DoubleWidth",$e="DoubleHeightAndWidth",Pe="Special1",ze="Special2",Oe=new Map([[Re,[.5,.5]],[Be,[.5,1]],[xe,[1,1]],[Ee,[1/4,1/6]],[Ne,[1,2]],[Le,[2,1]],[$e,[2,2]],[Pe,[Number.NaN,Number.NaN]],[ze,[Number.NaN,Number.NaN]]]),He={from:e=>({magnification:2,...e})},Ge={plane:[960,540],area:[960,540],margin:[0,0],fontsize:[36,36],hspace:4,vspace:24,position:[0,59],size:xe,pallet:0,foreground:7,halfforeground:0,halfbackground:0,background:8,underline:!1,highlight:0,ornament:null,flashing:79,elapsed_time:0},Ve=(e,t,r)=>({tag:"ClearScreen",state:structuredClone(t),option:structuredClone(r),time:e}),je=({character:e,non_spacing:t},r,i)=>({tag:"Character",state:structuredClone(r),option:structuredClone(i),character:e,non_spacing:t}),Ke=({width:e,height:t,depth:r,binary:i},a,n)=>({tag:"DRCS",state:structuredClone(a),option:structuredClone(n),width:e,height:t,depth:r,binary:i}),Je={from:({x_position:e,y_position:t,flc_colors:r,binary:i},a,n)=>({tag:"Bitmap",state:structuredClone(a),option:structuredClone(n),x_position:e,y_position:t,flc_colors:r,binary:i}),toDataURL(e,t){const r=new Uint8Array(e.binary),i=new Set(e.flc_colors),a=r.subarray(0,33),n=r.subarray(33,r.byteLength),s=new Uint8Array(a.byteLength+n.byteLength+396+140),o=new DataView(s.buffer);s.set(a,0),s.set(n,569);for(let e=0;e<t.length;e++){const r=t[e],a=Number.parseInt(r.substring(1,3),16),n=Number.parseInt(r.substring(3,5),16),o=Number.parseInt(r.substring(5,7),16),c=Number.parseInt(r.substring(7,9),16);s[41+3*e+0]=a,s[41+3*e+1]=n,s[41+3*e+2]=o,s[437+e]=i.has(e)?0:c}o.setInt32(33,384,!1),s[37]="P".charCodeAt(0),s[38]="L".charCodeAt(0),s[39]="T".charCodeAt(0),s[40]="E".charCodeAt(0),o.setInt32(429,128,!1),s[433]="t".charCodeAt(0),s[434]="R".charCodeAt(0),s[435]="N".charCodeAt(0),s[436]="S".charCodeAt(0),o.setInt32(425,Ie(s,37,425),!1),o.setInt32(565,Ie(s,433,565),!1);const c=o.getInt32(16,!1),l=o.getInt32(20,!1),d="data:image/png;base64,"+btoa(String.fromCharCode(...s));if(0===i.size)return{width:c,height:l,normal_dataurl:d};for(let e=0;e<t.length;e++){const r=t[e],a=Number.parseInt(r.substring(7,9),16);s[437+e]=i.has(e)?a:0}return o.setInt32(425,Ie(s,37,425),!1),o.setInt32(565,Ie(s,433,565),!1),{width:c,height:l,normal_dataurl:d,flashing_dataurl:"data:image/png;base64,"+btoa(String.fromCharCode(...s))}}};class We{state;option;non_spacings=[];constructor(e=Ge,t){this.state=structuredClone(e),this.option=He.from(t),this.state.plane=[this.state.plane[0]*this.option.magnification,this.state.plane[1]*this.option.magnification],this.state.area=[this.state.area[0]*this.option.magnification,this.state.area[1]*this.option.magnification],this.state.margin=[this.state.margin[0]*this.option.magnification,this.state.margin[1]*this.option.magnification],this.state.fontsize=[this.state.fontsize[0]*this.option.magnification,this.state.fontsize[1]*this.option.magnification],this.state.hspace=this.state.hspace*this.option.magnification,this.state.vspace=this.state.vspace*this.option.magnification,this.state.position=[this.state.position[0]*this.option.magnification,this.state.position[1]*this.option.magnification]}static box(e){return[Math.floor((e.fontsize[0]+e.hspace)*Oe.get(e.size)[0]),Math.floor((e.fontsize[1]+e.vspace)*Oe.get(e.size)[1])]}static offset(e){return[Math.floor(e.hspace*Oe.get(e.size)[0]/2),Math.floor(e.vspace*Oe.get(e.size)[1]/2)]}static scale(e){return Oe.get(e.size)}move_absolute_dot(e,t){this.state.position[0]=e-this.state.margin[0],this.state.position[1]=t-this.state.margin[1]}move_absolute_pos(e,t){this.state.position[0]=e*We.box(this.state)[0],this.state.position[1]=(t+1)*We.box(this.state)[1]-1*this.option.magnification}move_newline(){this.state.position[0]=0,this.move_relative_pos(0,1)}move_relative_pos(e,t){for(;e<0;)for(this.state.position[0]-=We.box(this.state)[0],e++;this.state.position[0]<0;)this.state.position[0]+=this.state.area[0],t--;for(;e>0;)for(this.state.position[0]+=We.box(this.state)[0],e--;this.state.position[0]>=this.state.area[0];)this.state.position[0]-=this.state.area[0],t++;for(;t<0;)this.state.position[1]-=We.box(this.state)[1],t++;for(;t>0;)this.state.position[1]+=We.box(this.state)[1],t--;for(;this.state.position[1]>=this.state.area[1];)this.state.position[1]-=this.state.area[1];for(;this.state.position[1]<0;)this.state.position[1]+=this.state.area[1]}currentState(){return structuredClone(this.state)}currentOption(){return structuredClone(this.option)}parseToken(e){switch(e.tag){case"Character":if(!e.non_spacing){const t=[je(e,this.state,this.option),...this.non_spacings];return this.non_spacings=[],this.move_relative_pos(1,0),t}this.non_spacings.push(je(e,this.state,this.option));break;case"DRCS":const t=[Ke(e,this.state,this.option),...""===e.combining?[]:[je(k("　"+e.combining,!0),this.state,this.option)],...this.non_spacings];return this.non_spacings=[],this.move_relative_pos(1,0),t;case"Space":{const e=[je(k("　"),this.state,this.option),...this.non_spacings];return this.non_spacings=[],this.move_relative_pos(1,0),e}case"SetWritingFormat":switch(e.format){case 0:case 2:case 4:default:break;case 5:this.state.plane=[1920*this.option.magnification,1080*this.option.magnification];break;case 7:this.state.plane=[960*this.option.magnification,540*this.option.magnification];break;case 9:this.state.plane=[720*this.option.magnification,480*this.option.magnification];break;case 11:this.state.plane=[1280*this.option.magnification,720*this.option.magnification]}break;case"SetDisplayFormat":this.state.area=[e.horizontal*this.option.magnification,e.vertical*this.option.magnification];break;case"SetDisplayPosition":this.state.margin=[e.horizontal*this.option.magnification,e.vertical*this.option.magnification];break;case"CharacterCompositionDotDesignation":this.state.fontsize=[e.horizontal*this.option.magnification,e.vertical*this.option.magnification];break;case"SetHorizontalSpacing":this.state.hspace=e.spacing*this.option.magnification;break;case"SetVerticalSpacing":this.state.vspace=e.spacing*this.option.magnification;break;case"ActivePositionBackward":this.move_relative_pos(-1,0);break;case"ActivePositionForward":this.move_relative_pos(1,0);break;case"ActivePositionDown":this.move_relative_pos(0,1);break;case"ActivePositionUp":this.move_relative_pos(0,-1);break;case"ActivePositionReturn":this.move_newline();break;case"ParameterizedActivePositionForward":this.move_relative_pos(e.x,0);break;case"ActivePositionSet":this.move_absolute_pos(e.x,e.y);break;case"ActiveCoordinatePositionSet":this.move_absolute_dot(e.x*this.option.magnification,e.y*this.option.magnification);break;case"SmallSize":this.state.size=Re;break;case"MiddleSize":this.state.size=Be;break;case"NormalSize":this.state.size=xe;break;case"CharacterSizeControl":switch(e.type){case 96:this.state.size=Ee;break;case 65:this.state.size=Ne;break;case 68:this.state.size=Le;break;case 69:this.state.size=$e;break;case 107:this.state.size=Pe;break;case 100:this.state.size=ze;break;default:throw new A(e,"Unexcepted Size Type in STD-B24 ARIB Caption Content")}break;case"PalletControl":this.state.pallet=e.pallet;break;case"BlackForeground":this.state.foreground=this.state.pallet<<4;break;case"RedForeground":this.state.foreground=this.state.pallet<<4|1;break;case"GreenForeground":this.state.foreground=this.state.pallet<<4|2;break;case"YellowForeground":this.state.foreground=this.state.pallet<<4|3;break;case"BlueForeground":this.state.foreground=this.state.pallet<<4|4;break;case"MagentaForeground":this.state.foreground=this.state.pallet<<4|5;break;case"CyanForeground":this.state.foreground=this.state.pallet<<4|6;break;case"WhiteForeground":this.state.foreground=this.state.pallet<<4|7;break;case"ColorControlForeground":this.state.foreground=this.state.pallet<<4|e.color;break;case"ColorControlHalfForeground":this.state.halfforeground=this.state.pallet<<4|e.color;break;case"ColorControlHalfBackground":this.state.halfbackground=this.state.pallet<<4|e.color;break;case"ColorControlBackground":this.state.background=this.state.pallet<<4|e.color;break;case"StartLining":this.state.underline=!0;break;case"StopLining":this.state.underline=!1;break;case"HilightingCharacterBlock":this.state.highlight=e.enclosure;break;case"OrnamentControlNone":this.state.ornament=null;break;case"OrnamentControlHemming":{const t=Math.floor(e.color/100),r=e.color%100;this.state.ornament=r<<4|t;break}case"FlashingControl":this.state.flashing=e.type;break;case"ClearScreen":return[Ve(this.state.elapsed_time,this.state,this.option)];case"TimeControlWait":this.state.elapsed_time+=e.seconds}return[]}parse(e){return e.flatMap(this.parseToken.bind(this))}}const Xe=Ge,Ye={...Ge,size:Be},qe=new Map([[33,"！"],[34,"＂"],[35,"＃"],[36,"＄"],[37,"％"],[38,"＆"],[39,"＇"],[40,"（"],[41,"）"],[42,"＊"],[43,"＋"],[44,"，"],[45,"－"],[46,"．"],[47,"／"],[48,"０"],[49,"１"],[50,"２"],[51,"３"],[52,"４"],[53,"５"],[54,"６"],[55,"７"],[56,"８"],[57,"９"],[58,"："],[59,"；"],[60,"＜"],[61,"＝"],[62,"＞"],[63,"？"],[64,"＠"],[65,"Ａ"],[66,"Ｂ"],[67,"Ｃ"],[68,"Ｄ"],[69,"Ｅ"],[70,"Ｆ"],[71,"Ｇ"],[72,"Ｈ"],[73,"Ｉ"],[74,"Ｊ"],[75,"Ｋ"],[76,"Ｌ"],[77,"Ｍ"],[78,"Ｎ"],[79,"Ｏ"],[80,"Ｐ"],[81,"Ｑ"],[82,"Ｒ"],[83,"Ｓ"],[84,"Ｔ"],[85,"Ｕ"],[86,"Ｖ"],[87,"Ｗ"],[88,"Ｘ"],[89,"Ｙ"],[90,"Ｚ"],[91,"［"],[92,"／"],[93,"］"],[94,"＾"],[95,"＿"],[96,"｀"],[97,"ａ"],[98,"ｂ"],[99,"ｃ"],[100,"ｄ"],[101,"ｅ"],[102,"ｆ"],[103,"ｇ"],[104,"ｈ"],[105,"ｉ"],[106,"ｊ"],[107,"ｋ"],[108,"ｌ"],[109,"ｍ"],[110,"ｎ"],[111,"ｏ"],[112,"ｐ"],[113,"ｑ"],[114,"ｒ"],[115,"ｓ"],[116,"ｔ"],[117,"ｕ"],[118,"ｖ"],[119,"ｗ"],[120,"ｘ"],[121,"ｙ"],[122,"ｚ"],[123,"｛"],[124,"｜"],[125,"｝"],[126,"～"]]);class Ze{view;offset;constructor(e){this.view=new DataView(e),this.offset=0}exists(e){return this.offset+e<=this.view.byteLength}isEmpty(){return this.offset===this.view.byteLength}read(e){if(!this.exists(e))throw new g("Detected EOF!");const t=this.view.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}peekU8(){if(!this.exists(1))throw new g("Detected EOF!");return this.view.getUint8(this.offset)}readU8(){const e=this.peekU8();return this.offset+=1,e}peekU16(){if(!this.exists(2))throw new g("Detected EOF!");return this.view.getUint16(this.offset,!1)}readU16(){const e=this.peekU16();return this.offset+=2,e}peekU24(){if(!this.exists(3))throw new g("Detected EOF!");return 256*this.view.getUint16(this.offset,!1)+this.view.getUint8(this.offset+2)}readU24(){const e=this.peekU24();return this.offset+=3,e}peekU32(){if(!this.exists(4))throw new g("Detected EOF!");return this.view.getUint32(this.offset,!1)}readU32(){const e=this.peekU32();return this.offset+=4,e}readAll(){const e=this.view.buffer.slice(this.offset,this.view.byteLength);return this.offset=this.view.byteLength,e}}const Qe=(e,t,r,i,a,n,s,o)=>{return 0|((c=t+e(r,i,a)+n+s|0)<<(l=o)|c>>>32-l)+r;var c,l},et=(e,t,r)=>e&t|~e&r,tt=(e,t,r)=>e&r|t&~r,rt=(e,t,r)=>e^t^r,it=(e,t,r)=>t^(e|~r),at=e=>{const t=15&e;return`${((240&e)>>4).toString(16)}${t.toString(16)}`},nt=e=>{const t=64*Math.floor((e.byteLength+8)/64+1),r=new Uint8Array(t);r.set(new Uint8Array(e),0);const i=new DataView(r.buffer);i.setUint8(e.byteLength,128),i.setUint32(t-8,8*e.byteLength%2**32,!0),i.setUint32(t-4,8*e.byteLength/2**32,!0);let a=1732584193,n=-271733879,s=-1732584194,o=271733878;for(let e=0;e<t;e+=64){let t=a,r=n,c=s,l=o;a=Qe(et,a,n,s,o,i.getUint32(e+0,!0),3614090360,7),o=Qe(et,o,a,n,s,i.getUint32(e+4,!0),3905402710,12),s=Qe(et,s,o,a,n,i.getUint32(e+8,!0),606105819,17),n=Qe(et,n,s,o,a,i.getUint32(e+12,!0),3250441966,22),a=Qe(et,a,n,s,o,i.getUint32(e+16,!0),4118548399,7),o=Qe(et,o,a,n,s,i.getUint32(e+20,!0),1200080426,12),s=Qe(et,s,o,a,n,i.getUint32(e+24,!0),2821735955,17),n=Qe(et,n,s,o,a,i.getUint32(e+28,!0),4249261313,22),a=Qe(et,a,n,s,o,i.getUint32(e+32,!0),1770035416,7),o=Qe(et,o,a,n,s,i.getUint32(e+36,!0),2336552879,12),s=Qe(et,s,o,a,n,i.getUint32(e+40,!0),4294925233,17),n=Qe(et,n,s,o,a,i.getUint32(e+44,!0),2304563134,22),a=Qe(et,a,n,s,o,i.getUint32(e+48,!0),1804603682,7),o=Qe(et,o,a,n,s,i.getUint32(e+52,!0),4254626195,12),s=Qe(et,s,o,a,n,i.getUint32(e+56,!0),2792965006,17),n=Qe(et,n,s,o,a,i.getUint32(e+60,!0),1236535329,22),a=Qe(tt,a,n,s,o,i.getUint32(e+4,!0),4129170786,5),o=Qe(tt,o,a,n,s,i.getUint32(e+24,!0),3225465664,9),s=Qe(tt,s,o,a,n,i.getUint32(e+44,!0),643717713,14),n=Qe(tt,n,s,o,a,i.getUint32(e+0,!0),3921069994,20),a=Qe(tt,a,n,s,o,i.getUint32(e+20,!0),3593408605,5),o=Qe(tt,o,a,n,s,i.getUint32(e+40,!0),38016083,9),s=Qe(tt,s,o,a,n,i.getUint32(e+60,!0),3634488961,14),n=Qe(tt,n,s,o,a,i.getUint32(e+16,!0),3889429448,20),a=Qe(tt,a,n,s,o,i.getUint32(e+36,!0),568446438,5),o=Qe(tt,o,a,n,s,i.getUint32(e+56,!0),3275163606,9),s=Qe(tt,s,o,a,n,i.getUint32(e+12,!0),4107603335,14),n=Qe(tt,n,s,o,a,i.getUint32(e+32,!0),1163531501,20),a=Qe(tt,a,n,s,o,i.getUint32(e+52,!0),2850285829,5),o=Qe(tt,o,a,n,s,i.getUint32(e+8,!0),4243563512,9),s=Qe(tt,s,o,a,n,i.getUint32(e+28,!0),1735328473,14),n=Qe(tt,n,s,o,a,i.getUint32(e+48,!0),2368359562,20),a=Qe(rt,a,n,s,o,i.getUint32(e+20,!0),4294588738,4),o=Qe(rt,o,a,n,s,i.getUint32(e+32,!0),2272392833,11),s=Qe(rt,s,o,a,n,i.getUint32(e+44,!0),1839030562,16),n=Qe(rt,n,s,o,a,i.getUint32(e+56,!0),4259657740,23),a=Qe(rt,a,n,s,o,i.getUint32(e+4,!0),2763975236,4),o=Qe(rt,o,a,n,s,i.getUint32(e+16,!0),1272893353,11),s=Qe(rt,s,o,a,n,i.getUint32(e+28,!0),4139469664,16),n=Qe(rt,n,s,o,a,i.getUint32(e+40,!0),3200236656,23),a=Qe(rt,a,n,s,o,i.getUint32(e+52,!0),681279174,4),o=Qe(rt,o,a,n,s,i.getUint32(e+0,!0),3936430074,11),s=Qe(rt,s,o,a,n,i.getUint32(e+12,!0),3572445317,16),n=Qe(rt,n,s,o,a,i.getUint32(e+24,!0),76029189,23),a=Qe(rt,a,n,s,o,i.getUint32(e+36,!0),3654602809,4),o=Qe(rt,o,a,n,s,i.getUint32(e+48,!0),3873151461,11),s=Qe(rt,s,o,a,n,i.getUint32(e+60,!0),530742520,16),n=Qe(rt,n,s,o,a,i.getUint32(e+8,!0),3299628645,23),a=Qe(it,a,n,s,o,i.getUint32(e+0,!0),4096336452,6),o=Qe(it,o,a,n,s,i.getUint32(e+28,!0),1126891415,10),s=Qe(it,s,o,a,n,i.getUint32(e+56,!0),2878612391,15),n=Qe(it,n,s,o,a,i.getUint32(e+20,!0),4237533241,21),a=Qe(it,a,n,s,o,i.getUint32(e+48,!0),1700485571,6),o=Qe(it,o,a,n,s,i.getUint32(e+12,!0),2399980690,10),s=Qe(it,s,o,a,n,i.getUint32(e+40,!0),4293915773,15),n=Qe(it,n,s,o,a,i.getUint32(e+4,!0),2240044497,21),a=Qe(it,a,n,s,o,i.getUint32(e+32,!0),1873313359,6),o=Qe(it,o,a,n,s,i.getUint32(e+60,!0),4264355552,10),s=Qe(it,s,o,a,n,i.getUint32(e+24,!0),2734768916,15),n=Qe(it,n,s,o,a,i.getUint32(e+52,!0),1309151649,21),a=Qe(it,a,n,s,o,i.getUint32(e+16,!0),4149444226,6),o=Qe(it,o,a,n,s,i.getUint32(e+44,!0),3174756917,10),s=Qe(it,s,o,a,n,i.getUint32(e+8,!0),718787259,15),n=Qe(it,n,s,o,a,i.getUint32(e+36,!0),3951481745,21),a=t+a|0,n=r+n|0,s=c+s|0,o=l+o|0}let c="";return c+=at((255&a)>>>0),c+=at((65280&a)>>>8),c+=at((16711680&a)>>>16),c+=at((4278190080&a)>>>24),c+=at((255&n)>>>0),c+=at((65280&n)>>>8),c+=at((16711680&n)>>>16),c+=at((4278190080&n)>>>24),c+=at((255&s)>>>0),c+=at((65280&s)>>>8),c+=at((16711680&s)>>>16),c+=at((4278190080&s)>>>24),c+=at((255&o)>>>0),c+=at((65280&o)>>>8),c+=at((16711680&o)>>>16),c+=at((4278190080&o)>>>24),c},st=27,ot=127,ct=144,lt=e=>{switch(e.readU8()){case 0:return M();case 7:return _();case 8:return D();case 9:return I();case 10:return R();case 11:return B();case 12:return x();case 13:return E();case 22:return N(63&e.readU8());case 24:return L();case 28:{const t=63&e.readU8(),r=63&e.readU8();return $(r,t)}case 30:return P();case 31:return z();case 32:return O();case ot:return H();default:throw new U("Undefined C0 detected")}},dt=e=>{switch(e.readU8()){case 128:return G();case 129:return V();case 130:return j();case 131:return K();case 132:return J();case 133:return W();case 134:return X();case 135:return Y();case 136:return q();case 137:return Z();case 138:return Q();case 139:{const t=e.readU8();switch(t){case 96:case 65:case 68:case 69:case 107:case 100:return ee(t)}throw new U("Undefined SZX")}case ct:{const t=e.readU8(),r=15&t;switch(112&t){case 32:return ne(15&e.readU8());case 64:return te(r);case 80:return re(r);case 96:return ie(r);case 112:return ae(r)}throw new U("Undefined COL")}case 145:{const t=e.readU8();switch(t){case 64:case 71:case 79:return se(t)}throw new U("Undefined FLC")}case 146:{const t=e.readU8();if(32===t){const t=e.readU8();switch(t){case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 72:case 73:case 74:return le(t)}}else{if(64===t)return ce(t);if(79===t)return oe(t)}throw new U("Undefined CDC")}case 147:{const t=e.readU8();switch(t){case 64:case 65:case 66:return de(t)}throw new U("Undefined POL")}case 148:{const t=e.readU8();switch(t){case 64:case 68:case 69:return he(t)}throw new U("Undefined WMM")}case 149:throw new m("MACRO is Not Implemeted!");case 151:{const t=15&e.readU8();return ue(t)}case 152:{const t=63&e.readU8();return fe(t)}case 153:return ge();case 154:return pe();case 155:{const t=[0];let r=0;for(;!e.isEmpty();){const i=e.readU8();if(32!==i&&59!=i){if(64&i){r=i;break}t[t.length-1]*=10,t[t.length-1]+=15&i}else t.push(0)}switch(r){case 66:throw new m("GSM is Not Implemented!");case 83:return we(t[0]);case 84:throw new m("CCC is Not Implemented!");case 86:return Fe(t[0],t[1]);case 87:return Ue(t[0],t[1]);case 88:return ye(t[0]);case 89:return Ce(t[0]);case 91:throw new m("PLD is Not Implemented!");case 92:throw new m("PLU is Not Implemented!");case 93:throw new m("GAA is Not Implemented!");case 94:throw new m("SRC is Not Implemented!");case 95:return Ae(t[0],t[1]);case 97:return Se(t[0],t[1]);case 98:throw new m("TCC is Not Implemented!");case 99:switch(t[0]){case 0:return ke();case 1:return ve(t[1]);case 2:return Te(t[1]);case 3:return Me()}throw new U("Undefined ORN");case 100:throw new m("MDF is Not Implemented!");case 101:throw new m("CFS is Not Implemented!");case 102:throw new m("XCS is Not Implemented!");case 103:throw new m("SCR is Not Implemented!");case 104:return _e(t[0]);case 105:throw new m("ACS is Not Implemented!");case 106:throw new m("UED is Not Implemented!");case 110:return De(t[0]);case 111:throw new m("SCS is Not Implemented!");default:throw new U(`Unhandled CSI Code in STD-B24 ARIB Caption (0x${r.toString(16)})`)}}case 157:switch(e.readU8()){case 32:{const t=(63&e.readU8())/10;return me(t)}case 40:{const t=e.readU8();switch(t){case 64:case 65:case 66:case 67:return be(t)}throw new U("Undefined TIME")}case 41:throw new w("TIME 0x29 (Specify Time) is Not Used by Specification");default:throw new U("Undefined TIME")}default:throw new U("Undefined C1/CSI")}};class ht{tokenize(e){return this.tokenizeDataUnits(e.units)}tokenizeDataUnits(e){const t=[];for(const r of e)switch(r.tag){case"Statement":t.push(...this.tokenizeStatement(r.data));break;case"DRCS":this.processDRCS(r.bytes,r.data);break;case"Bitmap":t.push(...this.tokenizeBitmap(r.data));break;default:throw new A(r,"Unexpected DataUnit in STD-B24 ARIB Caption")}return t}tokenizeBitmap(e){const t=new Uint8Array(e);let r=0;const i=(t[r]<<8|t[r+1])<<16>>16;r+=2;const a=(t[r]<<8|t[r+1])<<16>>16;r+=2;const n=t[r];r+=1;const s=Array.from(t.subarray(r,r+n));return r+=n,r+33>t.byteLength?[]:[T(i,a,s,e.slice(r))]}}const ut=126;class ft extends ht{GL;GR;GB;character_dicts;drcs_dicts;non_spacing;constructor(e,t,r,i,a,n){super(),this.GL=e,this.GR=t,this.GB=r,this.character_dicts=i,this.drcs_dicts=structuredClone(a),this.non_spacing=n}tokenizeStatement(e){const t=new Ze(e),r=[];for(;!t.isEmpty();){if(32<t.peekU8()&&t.peekU8()<127){let e=0;for(let r=0;r<this.GB[this.GL].bytes;r++)e<<=8,e|=127&t.readU8();const{type:i,dict:a}=this.GB[this.GL];switch(i){case"Character":if(a.has(e)){const t=a.get(e),i=this.non_spacing.has(t);r.push(k(t,i))}break;case"DRCS":if(a.has(e)){const{width:t,height:i,depth:n,binary:s}=a.get(e);r.push(v(t,i,n,s))}break;case"MACRO":a.has(e)&&r.push(...this.tokenizeStatement(a.get(e)));break;default:throw new A(i,"Undefined Dict Type in STD-B24 ARIB Caption")}continue}if(160<t.peekU8()&&t.peekU8()<255){let e=0;for(let r=0;r<this.GB[this.GR].bytes;r++)e<<=8,e|=127&t.readU8();const{type:i,dict:a}=this.GB[this.GR];switch(i){case"Character":if(a.has(e)){const t=a.get(e),i=this.non_spacing.has(t);r.push(k(t,i))}break;case"DRCS":if(a.has(e)){const{width:t,height:i,depth:n,binary:s}=a.get(e);r.push(v(t,i,n,s))}break;case"MACRO":a.has(e)&&r.push(...this.tokenizeStatement(a.get(e)));break;default:throw new A(i,"Undefined Dict Type in STD-B24 ARIB Caption")}continue}const e=t.peekU8();switch(e){case 14:t.readU8(),this.GL=1;break;case 15:t.readU8(),this.GL=0;break;case 25:{t.readU8();let e=0;for(let r=0;r<this.GB[2].bytes;r++)e<<=8,e|=127&t.readU8();const{type:i,dict:a}=this.GB[2];switch(i){case"Character":if(a.has(e)){const t=a.get(e),i=this.non_spacing.has(t);r.push(k(t,i))}break;case"DRCS":if(a.has(e)){const{width:t,height:i,depth:n,binary:s}=a.get(e);r.push(v(t,i,n,s))}break;case"MACRO":a.has(e)&&r.push(...this.tokenizeStatement(a.get(e)));break;default:throw new A(i,"Undefined Dict Type in STD-B24 ARIB Caption")}break}case st:{t.readU8();const e=t.readU8();switch(e){case 110:this.GL=2;break;case 111:this.GL=3;break;case ut:this.GR=1;break;case 125:this.GR=2;break;case 124:this.GR=3;break;case 36:{const e=t.readU8();if(40<=e&&e<=43){const r=t.readU8();if(32===r){const r=t.readU8();this.GB[e-40]=Object.values(this.drcs_dicts).find(({code:e})=>e===r)}else this.GB[e-40]=Object.values(this.character_dicts).find(({code:e})=>e===r)}else this.GB[0]=Object.values(this.character_dicts).find(({code:t})=>t===e);break}default:if(!(40<=e&&e<=43))throw new Error(`Undefined ESC Code in STD-B24 ARIB Caption (0x${e.toString(16)})`);{const r=t.readU8();if(32===r){const r=t.readU8();this.GB[e-40]=Object.values(this.drcs_dicts).find(({code:e})=>e===r)}else this.GB[e-40]=Object.values(this.character_dicts).find(({code:e})=>e===r)}}break}case 29:{t.readU8();let e=0;for(let r=0;r<this.GB[3].bytes;r++)e<<=8,e|=127&t.readU8();const{type:i,dict:a}=this.GB[3];switch(i){case"Character":if(a.has(e)){const t=a.get(e),i=this.non_spacing.has(t);r.push(k(t,i))}break;case"DRCS":if(a.has(e)){const{width:t,height:i,depth:n,binary:s}=a.get(e);r.push(v(t,i,n,s))}break;case"MACRO":a.has(e)&&r.push(...this.tokenizeStatement(a.get(e)));break;default:throw new A(i,"Undefined Dict Type in STD-B24 ARIB Caption")}break}default:if(0<=e&&e<=32||e===ot)r.push(lt(t));else{if(!(128<=e&&e<=159))throw new U("Undefined Conrtol Code in STD-B24 ARIB Caption");r.push(dt(t))}}}return r}processDRCS(e,t){const r=new Uint8Array(t);let i=0,a=r.byteLength;for(r[i+0],i+=1;i<a;){const t=r[i+0]<<8|r[i+1],a=r[i+2];i+=3;for(let n=0;n<a;n++){r[i+0];const a=15&r[i+0];if(0!==a&&1!==a)return;{const a=r[i+1]+2,n=r[i+2],s=r[i+3],o=[0,1,6,2,7,5,4,3][29*a>>5],c=Math.floor(n*s*o/8),l=r.slice(i+4,i+4+c).buffer;if(1===e){const e=(65280&t)>>8,r=127&t,i=Object.values(this.drcs_dicts).find(t=>t.code===e);if(null==i||"DRCS"!==i.type)continue;i.dict.set(r,v(n,s,o,l))}else{const e=64,r=32639&t,i=Object.values(this.drcs_dicts).find(t=>t.code===e);if(null==i||"DRCS"!==i.type)continue;i.dict.set(r,v(n,s,o,l))}i+=4+c}}}}}const pt=new Map([[33,"ぁ"],[34,"あ"],[35,"ぃ"],[36,"い"],[37,"ぅ"],[38,"う"],[39,"ぇ"],[40,"え"],[41,"ぉ"],[42,"お"],[43,"か"],[44,"が"],[45,"き"],[46,"ぎ"],[47,"く"],[48,"ぐ"],[49,"け"],[50,"げ"],[51,"こ"],[52,"ご"],[53,"さ"],[54,"ざ"],[55,"し"],[56,"じ"],[57,"す"],[58,"ず"],[59,"せ"],[60,"ぜ"],[61,"そ"],[62,"ぞ"],[63,"た"],[64,"だ"],[65,"ち"],[66,"ぢ"],[67,"っ"],[68,"つ"],[69,"づ"],[70,"て"],[71,"で"],[72,"と"],[73,"ど"],[74,"な"],[75,"に"],[76,"ぬ"],[77,"ね"],[78,"の"],[79,"は"],[80,"ば"],[81,"ぱ"],[82,"ひ"],[83,"び"],[84,"ぴ"],[85,"ふ"],[86,"ぶ"],[87,"ぷ"],[88,"へ"],[89,"べ"],[90,"ぺ"],[91,"ほ"],[92,"ぼ"],[93,"ぽ"],[94,"ま"],[95,"み"],[96,"む"],[97,"め"],[98,"も"],[99,"ゃ"],[100,"や"],[101,"ゅ"],[102,"ゆ"],[103,"ょ"],[104,"よ"],[105,"ら"],[106,"り"],[107,"る"],[108,"れ"],[109,"ろ"],[110,"ゎ"],[111,"わ"],[112,"ゐ"],[113,"ゑ"],[114,"を"],[115,"ん"],[119,"ゝ"],[120,"ゞ"],[121,"ー"],[122,"。"],[123,"「"],[124,"」"],[125,"、"],[126,"・"]]),gt=new Map([[33,"ァ"],[34,"ア"],[35,"ィ"],[36,"イ"],[37,"ゥ"],[38,"ウ"],[39,"ェ"],[40,"エ"],[41,"ォ"],[42,"オ"],[43,"カ"],[44,"ガ"],[45,"キ"],[46,"ギ"],[47,"ク"],[48,"グ"],[49,"ケ"],[50,"ゲ"],[51,"コ"],[52,"ゴ"],[53,"サ"],[54,"ザ"],[55,"シ"],[56,"ジ"],[57,"ス"],[58,"ズ"],[59,"セ"],[60,"ゼ"],[61,"ソ"],[62,"ゾ"],[63,"タ"],[64,"ダ"],[65,"チ"],[66,"ヂ"],[67,"ッ"],[68,"ツ"],[69,"ヅ"],[70,"テ"],[71,"デ"],[72,"ト"],[73,"ド"],[74,"ナ"],[75,"ニ"],[76,"ヌ"],[77,"ネ"],[78,"ノ"],[79,"ハ"],[80,"バ"],[81,"パ"],[82,"ヒ"],[83,"ビ"],[84,"ピ"],[85,"フ"],[86,"ブ"],[87,"プ"],[88,"ヘ"],[89,"ベ"],[90,"ペ"],[91,"ホ"],[92,"ボ"],[93,"ポ"],[94,"マ"],[95,"ミ"],[96,"ム"],[97,"メ"],[98,"モ"],[99,"ャ"],[100,"ヤ"],[101,"ュ"],[102,"ユ"],[103,"ョ"],[104,"ヨ"],[105,"ラ"],[106,"リ"],[107,"ル"],[108,"レ"],[109,"ロ"],[110,"ヮ"],[111,"ワ"],[112,"ヰ"],[113,"ヱ"],[114,"ヲ"],[115,"ン"],[116,"ヴ"],[117,"ヵ"],[118,"ヶ"],[119,"ヽ"],[120,"ヾ"],[121,"ー"],[122,"。"],[123,"「"],[124,"」"],[125,"、"],[126,"・"]]),mt=new Map([[29985,"㐂"],[29986,"𠅘"],[29987,"份"],[29988,"仿"],[29989,"侚"],[29990,"俉"],[29991,"傜"],[29992,"儞"],[29993,"冼"],[29994,"㔟"],[29995,"匇"],[29996,"卡"],[29997,"卬"],[29998,"詹"],[29999,"𠮷"],[3e4,"呍"],[30001,"咖"],[30002,"咜"],[30003,"咩"],[30004,"唎"],[30005,"啊"],[30006,"噲"],[30007,"囤"],[30008,"圳"],[30009,"圴"],[30010,"塚"],[30011,"墀"],[30012,"姤"],[30013,"娣"],[30014,"婕"],[30015,"寬"],[30016,"﨑"],[30017,"㟢"],[30018,"庬"],[30019,"弴"],[30020,"彅"],[30021,"德"],[30022,"怗"],[30023,"恵"],[30024,"愰"],[30025,"昤"],[30026,"曈"],[30027,"曙"],[30028,"曺"],[30029,"曻"],[30030,"桒"],[30031,"鿄"],[30032,"椑"],[30033,"椻"],[30034,"橅"],[30035,"檑"],[30036,"櫛"],[30037,"𣏌"],[30038,"𣏾"],[30039,"𣗄"],[30040,"毱"],[30041,"泠"],[30042,"洮"],[30043,"海"],[30044,"涿"],[30045,"淊"],[30046,"淸"],[30047,"渚"],[30048,"潞"],[30049,"濹"],[30050,"灤"],[30051,"𤋮"],[30052,"𤋮"],[30053,"煇"],[30054,"燁"],[30055,"爀"],[30056,"玟"],[30057,"玨"],[30058,"珉"],[30059,"珖"],[30060,"琛"],[30061,"琡"],[30062,"琢"],[30063,"琦"],[30064,"琪"],[30065,"琬"],[30066,"琹"],[30067,"瑋"],[30068,"㻚"],[30069,"畵"],[30070,"疁"],[30071,"睲"],[30072,"䂓"],[30073,"磈"],[30074,"磠"],[30075,"祇"],[30076,"禮"],[30077,"鿆"],[30078,"䄃"],[30241,"鿅"],[30242,"秚"],[30243,"稞"],[30244,"筿"],[30245,"簱"],[30246,"䉤"],[30247,"綋"],[30248,"羡"],[30249,"脘"],[30250,"脺"],[30251,"舘"],[30252,"芮"],[30253,"葛"],[30254,"蓜"],[30255,"蓬"],[30256,"蕙"],[30257,"藎"],[30258,"蝕"],[30259,"蟬"],[30260,"蠋"],[30261,"裵"],[30262,"角"],[30263,"諶"],[30264,"跎"],[30265,"辻"],[30266,"迶"],[30267,"郝"],[30268,"鄧"],[30269,"鄭"],[30270,"醲"],[30271,"鈳"],[30272,"銈"],[30273,"錡"],[30274,"鍈"],[30275,"閒"],[30276,"雞"],[30277,"餃"],[30278,"饀"],[30279,"髙"],[30280,"鯖"],[30281,"鷗"],[30282,"麴"],[30283,"麵"],[31265,"⛌"],[31266,"⛍"],[31267,"❗"],[31268,"⛏"],[31269,"⛐"],[31270,"⛑"],[31272,"⛒"],[31273,"⛕"],[31274,"⛓"],[31275,"⛔"],[31280,""],[31281,""],[31284,"⛖"],[31285,"⛗"],[31286,"⛘"],[31287,"⛙"],[31288,"⛚"],[31289,"⛛"],[31290,"⛜"],[31291,"⛝"],[31292,"⛞"],[31293,"⛟"],[31294,"⛠"],[31295,"⛡"],[31296,"⭕"],[31297,"㉈"],[31298,"㉉"],[31299,"㉊"],[31300,"㉋"],[31301,"㉌"],[31302,"㉍"],[31303,"㉎"],[31304,"㉏"],[31309,"⒑"],[31310,"⒒"],[31311,"⒓"],[31312,""],[31313,""],[31314,""],[31315,""],[31316,""],[31317,""],[31318,""],[31319,""],[31320,""],[31321,""],[31322,""],[31323,""],[31324,""],[31325,""],[31326,""],[31327,""],[31328,"⬛"],[31329,"⬤"],[31330,""],[31331,""],[31332,""],[31333,""],[31334,""],[31335,"⚿"],[31336,""],[31337,""],[31338,""],[31339,""],[31340,""],[31341,""],[31342,""],[31343,""],[31344,""],[31345,""],[31346,""],[31347,"㊙"],[31348,""],[31521,"⛣"],[31522,"⭖"],[31523,"⭗"],[31524,"⭘"],[31525,"⭙"],[31526,"☓"],[31527,"㊋"],[31528,"〒"],[31529,"⛨"],[31530,"㉆"],[31531,"㉅"],[31532,"⛩"],[31533,"࿖"],[31534,"⛪"],[31535,"⛫"],[31536,"⛬"],[31537,"♨"],[31538,"⛭"],[31539,"⛮"],[31540,"⛯"],[31541,"⚓"],[31542,"✈"],[31543,"⛰"],[31544,"⛱"],[31545,"⛲"],[31546,"⛳"],[31547,"⛴"],[31548,"⛵"],[31549,""],[31550,"Ⓓ"],[31551,"Ⓢ"],[31552,"⛶"],[31553,""],[31554,""],[31555,""],[31556,""],[31557,""],[31558,"⛷"],[31559,"⛸"],[31560,"⛹"],[31561,"⛺"],[31562,""],[31563,"☎"],[31564,"⛻"],[31565,"⛼"],[31566,"⛽"],[31567,"⛾"],[31568,""],[31569,"⛿"],[31777,"➡"],[31778,"⬅"],[31779,"⬆"],[31780,"⬇"],[31781,"⬯"],[31782,"⬮"],[31783,"年"],[31784,"月"],[31785,"日"],[31786,"円"],[31787,"㎡"],[31788,"㎥"],[31789,"㎝"],[31790,"㎠"],[31791,"㎤"],[31792,""],[31793,"⒈"],[31794,"⒉"],[31795,"⒊"],[31796,"⒋"],[31797,"⒌"],[31798,"⒍"],[31799,"⒎"],[31800,"⒏"],[31801,"⒐"],[31802,""],[31803,""],[31804,""],[31805,""],[31806,""],[31807,""],[31808,""],[31809,""],[31810,""],[31811,""],[31812,""],[31813,""],[31814,""],[31815,""],[31816,""],[31817,""],[31818,"㈳"],[31819,"㈶"],[31820,"㈲"],[31821,"㈱"],[31822,"㈹"],[31823,"㉄"],[31824,"▶"],[31825,"◀"],[31826,"〖"],[31827,"〗"],[31828,"⟐"],[31829,"²"],[31830,"³"],[31831,""],[31832,""],[31833,""],[31834,""],[31835,""],[31836,""],[31837,""],[31838,""],[31839,""],[31840,""],[31841,""],[31842,""],[31843,""],[31844,""],[31845,""],[31846,""],[31847,""],[31848,""],[31849,""],[31850,""],[31851,""],[31852,""],[31853,""],[31854,""],[31855,""],[31856,""],[31857,""],[31858,""],[31859,""],[31860,""],[31861,""],[31862,""],[31863,""],[31864,"㉇"],[31865,""],[31866,""],[31867,"℻"],[32033,"㈪"],[32034,"㈫"],[32035,"㈬"],[32036,"㈭"],[32037,"㈮"],[32038,"㈯"],[32039,"㈰"],[32040,"㈷"],[32041,"㍾"],[32042,"㍽"],[32043,"㍼"],[32044,"㍻"],[32045,"№"],[32046,"℡"],[32047,"〶"],[32048,"⚾"],[32049,""],[32050,""],[32051,""],[32052,""],[32053,""],[32054,""],[32055,""],[32056,""],[32057,""],[32058,""],[32059,""],[32060,""],[32061,""],[32062,""],[32063,""],[32064,""],[32065,""],[32066,""],[32067,""],[32068,""],[32069,""],[32070,""],[32071,"ℓ"],[32072,"㎏"],[32073,"㎐"],[32074,"㏊"],[32075,"㎞"],[32076,"㎢"],[32077,"㍱"],[32080,"½"],[32081,"↉"],[32082,"⅓"],[32083,"⅔"],[32084,"¼"],[32085,"¾"],[32086,"⅕"],[32087,"⅖"],[32088,"⅗"],[32089,"⅘"],[32090,"⅙"],[32091,"⅚"],[32092,"⅐"],[32093,"⅛"],[32094,"⅑"],[32095,"⅒"],[32096,"☀"],[32097,"☁"],[32098,"☂"],[32099,"⛄"],[32100,"☖"],[32101,"☗"],[32102,"⛉"],[32103,"⛊"],[32104,"♦"],[32105,"♥"],[32106,"♣"],[32107,"♠"],[32108,"⛋"],[32109,"⨀"],[32110,"‼"],[32111,"⁉"],[32112,"⛅"],[32113,"☔"],[32114,"⛆"],[32115,"☃"],[32116,"⛇"],[32117,"⚡"],[32118,"⛈"],[32120,"⚞"],[32121,"⚟"],[32122,"♬"],[32123,"☎"],[32289,"Ⅰ"],[32290,"Ⅱ"],[32291,"Ⅲ"],[32292,"Ⅳ"],[32293,"Ⅴ"],[32294,"Ⅵ"],[32295,"Ⅶ"],[32296,"Ⅷ"],[32297,"Ⅸ"],[32298,"Ⅹ"],[32299,"Ⅺ"],[32300,"Ⅻ"],[32301,"⑰"],[32302,"⑱"],[32303,"⑲"],[32304,"⑳"],[32305,"⑴"],[32306,"⑵"],[32307,"⑶"],[32308,"⑷"],[32309,"⑸"],[32310,"⑹"],[32311,"⑺"],[32312,"⑻"],[32313,"⑼"],[32314,"⑽"],[32315,"⑾"],[32316,"⑿"],[32317,"㉑"],[32318,"㉒"],[32319,"㉓"],[32320,"㉔"],[32321,""],[32322,""],[32323,""],[32324,""],[32325,""],[32326,""],[32327,""],[32328,""],[32329,""],[32330,""],[32331,""],[32332,""],[32333,""],[32334,""],[32335,""],[32336,""],[32337,""],[32338,""],[32339,""],[32340,""],[32341,""],[32342,""],[32343,""],[32344,""],[32345,""],[32346,""],[32347,"㉕"],[32348,"㉖"],[32349,"㉗"],[32350,"㉘"],[32351,"㉙"],[32352,"㉚"],[32353,"①"],[32354,"②"],[32355,"③"],[32356,"④"],[32357,"⑤"],[32358,"⑥"],[32359,"⑦"],[32360,"⑧"],[32361,"⑨"],[32362,"⑩"],[32363,"⑪"],[32364,"⑫"],[32365,"⑬"],[32366,"⑭"],[32367,"⑮"],[32368,"⑯"],[32369,"❶"],[32370,"❷"],[32371,"❸"],[32372,"❹"],[32373,"❺"],[32374,"❻"],[32375,"❼"],[32376,"❽"],[32377,"❾"],[32378,"❿"],[32379,"⓫"],[32380,"⓬"],[32381,"㉛"]]),bt=new Map([[29985,"㐂"],[29986,"𠅘"],[29987,"份"],[29988,"仿"],[29989,"侚"],[29990,"俉"],[29991,"傜"],[29992,"儞"],[29993,"冼"],[29994,"㔟"],[29995,"匇"],[29996,"卡"],[29997,"卬"],[29998,"詹"],[29999,"𠮷"],[3e4,"呍"],[30001,"咖"],[30002,"咜"],[30003,"咩"],[30004,"唎"],[30005,"啊"],[30006,"噲"],[30007,"囤"],[30008,"圳"],[30009,"圴"],[30010,"塚"],[30011,"墀"],[30012,"姤"],[30013,"娣"],[30014,"婕"],[30015,"寬"],[30016,"﨑"],[30017,"㟢"],[30018,"庬"],[30019,"弴"],[30020,"彅"],[30021,"德"],[30022,"怗"],[30023,"恵"],[30024,"愰"],[30025,"昤"],[30026,"曈"],[30027,"曙"],[30028,"曺"],[30029,"曻"],[30030,"桒"],[30031,"鿄"],[30032,"椑"],[30033,"椻"],[30034,"橅"],[30035,"檑"],[30036,"櫛"],[30037,"𣏌"],[30038,"𣏾"],[30039,"𣗄"],[30040,"毱"],[30041,"泠"],[30042,"洮"],[30043,"海"],[30044,"涿"],[30045,"淊"],[30046,"淸"],[30047,"渚"],[30048,"潞"],[30049,"濹"],[30050,"灤"],[30051,"𤋮"],[30052,"𤋮"],[30053,"煇"],[30054,"燁"],[30055,"爀"],[30056,"玟"],[30057,"玨"],[30058,"珉"],[30059,"珖"],[30060,"琛"],[30061,"琡"],[30062,"琢"],[30063,"琦"],[30064,"琪"],[30065,"琬"],[30066,"琹"],[30067,"瑋"],[30068,"㻚"],[30069,"畵"],[30070,"疁"],[30071,"睲"],[30072,"䂓"],[30073,"磈"],[30074,"磠"],[30075,"祇"],[30076,"禮"],[30077,"鿆"],[30078,"䄃"],[30241,"鿅"],[30242,"秚"],[30243,"稞"],[30244,"筿"],[30245,"簱"],[30246,"䉤"],[30247,"綋"],[30248,"羡"],[30249,"脘"],[30250,"脺"],[30251,"舘"],[30252,"芮"],[30253,"葛"],[30254,"蓜"],[30255,"蓬"],[30256,"蕙"],[30257,"藎"],[30258,"蝕"],[30259,"蟬"],[30260,"蠋"],[30261,"裵"],[30262,"角"],[30263,"諶"],[30264,"跎"],[30265,"辻"],[30266,"迶"],[30267,"郝"],[30268,"鄧"],[30269,"鄭"],[30270,"醲"],[30271,"鈳"],[30272,"銈"],[30273,"錡"],[30274,"鍈"],[30275,"閒"],[30276,"雞"],[30277,"餃"],[30278,"饀"],[30279,"髙"],[30280,"鯖"],[30281,"鷗"],[30282,"麴"],[30283,"麵"],[31265,"⛌"],[31266,"⛍"],[31267,"❗"],[31268,"⛏"],[31269,"⛐"],[31270,"⛑"],[31272,"⛒"],[31273,"⛕"],[31274,"⛓"],[31275,"⛔"],[31280,"🅿"],[31281,"🆊"],[31284,"⛖"],[31285,"⛗"],[31286,"⛘"],[31287,"⛙"],[31288,"⛚"],[31289,"⛛"],[31290,"⛜"],[31291,"⛝"],[31292,"⛞"],[31293,"⛟"],[31294,"⛠"],[31295,"⛡"],[31296,"⭕"],[31297,"㉈"],[31298,"㉉"],[31299,"㉊"],[31300,"㉋"],[31301,"㉌"],[31302,"㉍"],[31303,"㉎"],[31304,"㉏"],[31309,"⒑"],[31310,"⒒"],[31311,"⒓"],[31312,"🅊"],[31313,"🅌"],[31314,"🄿"],[31315,"🅆"],[31316,"🅋"],[31317,"🈐"],[31318,"🈑"],[31319,"🈒"],[31320,"🈓"],[31321,"🅂"],[31322,"🈔"],[31323,"🈕"],[31324,"🈖"],[31325,"🅍"],[31326,"🄱"],[31327,"🄽"],[31328,"⬛"],[31329,"⬤"],[31330,"🈗"],[31331,"🈘"],[31332,"🈙"],[31333,"🈚"],[31334,"🈛"],[31335,"⚿"],[31336,"🈜"],[31337,"🈝"],[31338,"🈞"],[31339,"🈟"],[31340,"🈠"],[31341,"🈡"],[31342,"🈢"],[31343,"🈣"],[31344,"🈤"],[31345,"🈥"],[31346,"🅎"],[31347,"㊙"],[31348,"🈀"],[31521,"⛣"],[31522,"⭖"],[31523,"⭗"],[31524,"⭘"],[31525,"⭙"],[31526,"☓"],[31527,"㊋"],[31528,"〒"],[31529,"⛨"],[31530,"㉆"],[31531,"㉅"],[31532,"⛩"],[31533,"࿖"],[31534,"⛪"],[31535,"⛫"],[31536,"⛬"],[31537,"♨"],[31538,"⛭"],[31539,"⛮"],[31540,"⛯"],[31541,"⚓"],[31542,"✈"],[31543,"⛰"],[31544,"⛱"],[31545,"⛲"],[31546,"⛳"],[31547,"⛴"],[31548,"⛵"],[31549,"🅗"],[31550,"Ⓓ"],[31551,"Ⓢ"],[31552,"⛶"],[31553,"🅟"],[31554,"🆋"],[31555,"🆍"],[31556,"🆌"],[31557,"🅹"],[31558,"⛷"],[31559,"⛸"],[31560,"⛹"],[31561,"⛺"],[31562,"🅻"],[31563,"☎"],[31564,"⛻"],[31565,"⛼"],[31566,"⛽"],[31567,"⛾"],[31568,"🅼"],[31569,"⛿"],[31777,"➡"],[31778,"⬅"],[31779,"⬆"],[31780,"⬇"],[31781,"⬯"],[31782,"⬮"],[31783,"年"],[31784,"月"],[31785,"日"],[31786,"円"],[31787,"㎡"],[31788,"㎥"],[31789,"㎝"],[31790,"㎠"],[31791,"㎤"],[31792,"🄀"],[31793,"⒈"],[31794,"⒉"],[31795,"⒊"],[31796,"⒋"],[31797,"⒌"],[31798,"⒍"],[31799,"⒎"],[31800,"⒏"],[31801,"⒐"],[31802,""],[31803,""],[31804,""],[31805,""],[31806,""],[31807,""],[31808,"🄁"],[31809,"🄂"],[31810,"🄃"],[31811,"🄄"],[31812,"🄅"],[31813,"🄆"],[31814,"🄇"],[31815,"🄈"],[31816,"🄉"],[31817,"🄊"],[31818,"㈳"],[31819,"㈶"],[31820,"㈲"],[31821,"㈱"],[31822,"㈹"],[31823,"㉄"],[31824,"▶"],[31825,"◀"],[31826,"〖"],[31827,"〗"],[31828,"⟐"],[31829,"²"],[31830,"³"],[31831,"🄭"],[31832,""],[31833,""],[31834,""],[31835,""],[31836,""],[31837,""],[31838,""],[31839,""],[31840,""],[31841,""],[31842,""],[31843,""],[31844,""],[31845,""],[31846,""],[31847,""],[31848,""],[31849,""],[31850,""],[31851,""],[31852,""],[31853,""],[31854,""],[31855,""],[31856,""],[31857,""],[31858,""],[31859,""],[31860,""],[31861,""],[31862,"🄬"],[31863,"🄫"],[31864,"㉇"],[31865,"🆐"],[31866,"🈦"],[31867,"℻"],[32033,"㈪"],[32034,"㈫"],[32035,"㈬"],[32036,"㈭"],[32037,"㈮"],[32038,"㈯"],[32039,"㈰"],[32040,"㈷"],[32041,"㍾"],[32042,"㍽"],[32043,"㍼"],[32044,"㍻"],[32045,"№"],[32046,"℡"],[32047,"〶"],[32048,"⚾"],[32049,"🉀"],[32050,"🉁"],[32051,"🉂"],[32052,"🉃"],[32053,"🉄"],[32054,"🉅"],[32055,"🉆"],[32056,"🉇"],[32057,"🉈"],[32058,"🄪"],[32059,"🈧"],[32060,"🈨"],[32061,"🈩"],[32062,"🈔"],[32063,"🈪"],[32064,"🈫"],[32065,"🈬"],[32066,"🈭"],[32067,"🈮"],[32068,"🈯"],[32069,"🈰"],[32070,"🈱"],[32071,"ℓ"],[32072,"㎏"],[32073,"㎐"],[32074,"㏊"],[32075,"㎞"],[32076,"㎢"],[32077,"㍱"],[32080,"½"],[32081,"↉"],[32082,"⅓"],[32083,"⅔"],[32084,"¼"],[32085,"¾"],[32086,"⅕"],[32087,"⅖"],[32088,"⅗"],[32089,"⅘"],[32090,"⅙"],[32091,"⅚"],[32092,"⅐"],[32093,"⅛"],[32094,"⅑"],[32095,"⅒"],[32096,"☀"],[32097,"☁"],[32098,"☂"],[32099,"⛄"],[32100,"☖"],[32101,"☗"],[32102,"⛉"],[32103,"⛊"],[32104,"♦"],[32105,"♥"],[32106,"♣"],[32107,"♠"],[32108,"⛋"],[32109,"⨀"],[32110,"‼"],[32111,"⁉"],[32112,"⛅"],[32113,"☔"],[32114,"⛆"],[32115,"☃"],[32116,"⛇"],[32117,"⚡"],[32118,"⛈"],[32120,"⚞"],[32121,"⚟"],[32122,"♬"],[32123,"☎"],[32289,"Ⅰ"],[32290,"Ⅱ"],[32291,"Ⅲ"],[32292,"Ⅳ"],[32293,"Ⅴ"],[32294,"Ⅵ"],[32295,"Ⅶ"],[32296,"Ⅷ"],[32297,"Ⅸ"],[32298,"Ⅹ"],[32299,"Ⅺ"],[32300,"Ⅻ"],[32301,"⑰"],[32302,"⑱"],[32303,"⑲"],[32304,"⑳"],[32305,"⑴"],[32306,"⑵"],[32307,"⑶"],[32308,"⑷"],[32309,"⑸"],[32310,"⑹"],[32311,"⑺"],[32312,"⑻"],[32313,"⑼"],[32314,"⑽"],[32315,"⑾"],[32316,"⑿"],[32317,"㉑"],[32318,"㉒"],[32319,"㉓"],[32320,"㉔"],[32321,"🄐"],[32322,"🄑"],[32323,"🄒"],[32324,"🄓"],[32325,"🄔"],[32326,"🄕"],[32327,"🄖"],[32328,"🄗"],[32329,"🄘"],[32330,"🄙"],[32331,"🄚"],[32332,"🄛"],[32333,"🄜"],[32334,"🄝"],[32335,"🄞"],[32336,"🄟"],[32337,"🄠"],[32338,"🄡"],[32339,"🄢"],[32340,"🄣"],[32341,"🄤"],[32342,"🄥"],[32343,"🄦"],[32344,"🄧"],[32345,"🄨"],[32346,"🄩"],[32347,"㉕"],[32348,"㉖"],[32349,"㉗"],[32350,"㉘"],[32351,"㉙"],[32352,"㉚"],[32353,"①"],[32354,"②"],[32355,"③"],[32356,"④"],[32357,"⑤"],[32358,"⑥"],[32359,"⑦"],[32360,"⑧"],[32361,"⑨"],[32362,"⑩"],[32363,"⑪"],[32364,"⑫"],[32365,"⑬"],[32366,"⑭"],[32367,"⑮"],[32368,"⑯"],[32369,"❶"],[32370,"❷"],[32371,"❸"],[32372,"❹"],[32373,"❺"],[32374,"❻"],[32375,"❼"],[32376,"❽"],[32377,"❾"],[32378,"❿"],[32379,"⓫"],[32380,"⓬"],[32381,"㉛"]]),wt=new Map([[96,Uint8Array.from([27,36,66,27,41,74,27,42,48,27,43,32,112,15,27,125]).buffer],[97,Uint8Array.from([27,36,66,27,41,49,27,42,48,27,43,32,112,15,27,125]).buffer],[98,Uint8Array.from([27,36,66,27,41,32,65,27,42,48,27,43,32,112,15,27,125]).buffer],[99,Uint8Array.from([27,40,50,27,41,52,27,42,53,27,43,32,112,15,27,125]).buffer],[100,Uint8Array.from([27,40,50,27,41,51,27,42,53,27,43,32,112,15,27,125]).buffer],[101,Uint8Array.from([27,40,50,27,41,32,65,27,42,53,27,43,32,112,15,27,125]).buffer],[102,Uint8Array.from([27,40,32,65,27,41,32,66,27,42,32,67,27,43,32,112,15,27,125]).buffer],[103,Uint8Array.from([27,40,32,68,27,41,32,69,27,42,32,70,27,43,32,112,15,27,125]).buffer],[104,Uint8Array.from([27,40,32,71,27,41,32,72,27,42,32,73,27,43,32,112,15,27,125]).buffer],[105,Uint8Array.from([27,40,32,74,27,41,32,75,27,42,32,75,27,43,32,112,15,27,125]).buffer],[106,Uint8Array.from([27,40,32,77,27,41,32,78,27,42,32,79,27,43,32,112,15,27,125]).buffer],[107,Uint8Array.from([27,36,66,27,41,32,66,27,42,48,27,43,32,112,15,27,125]).buffer],[108,Uint8Array.from([27,36,66,27,41,32,67,27,42,48,27,43,32,112,15,27,125]).buffer],[109,Uint8Array.from([27,36,66,27,41,32,68,27,42,48,27,43,32,112,15,27,125]).buffer],[110,Uint8Array.from([27,40,49,27,41,48,27,42,74,27,43,32,112,15,27,125]).buffer],[111,Uint8Array.from([27,40,74,27,41,50,27,42,32,65,27,43,32,112,15,27,125]).buffer]]),Ft={KANJI:{type:"Character",code:66,bytes:2,dict:new Map},ASCII:{type:"Character",code:74,bytes:1,dict:qe},HIRAGANA:{type:"Character",code:48,bytes:1,dict:pt},KATANAKA:{type:"Character",code:49,bytes:1,dict:gt},MOSAIC_A:{type:"Character",code:50,bytes:1,dict:new Map},MOSAIC_B:{type:"Character",code:51,bytes:1,dict:new Map},MOSAIC_C:{type:"Character",code:52,bytes:1,dict:new Map},MOSAIC_D:{type:"Character",code:53,bytes:1,dict:new Map},P_ASCII:{type:"Character",code:54,bytes:1,dict:new Map},P_HIRAGANA:{type:"Character",code:55,bytes:1,dict:new Map},P_KATANAKA:{type:"Character",code:56,bytes:1,dict:new Map},JIS_X_0201_KATAKANA:{type:"Character",code:73,bytes:1,dict:new Map},JIS_X_0213_2004_KANJI_1:{type:"Character",code:57,bytes:2,dict:new Map},JIS_X_0213_2004_KANJI_2:{type:"Character",code:58,bytes:2,dict:new Map},ADDITIONAL_SYMBOLS:{type:"Character",code:59,bytes:2,dict:new Map}},At={DRCS_0:{type:"DRCS",code:64,bytes:2,dict:new Map},DRCS_1:{type:"DRCS",code:65,bytes:1,dict:new Map},DRCS_2:{type:"DRCS",code:66,bytes:1,dict:new Map},DRCS_3:{type:"DRCS",code:67,bytes:1,dict:new Map},DRCS_4:{type:"DRCS",code:68,bytes:1,dict:new Map},DRCS_5:{type:"DRCS",code:69,bytes:1,dict:new Map},DRCS_6:{type:"DRCS",code:70,bytes:1,dict:new Map},DRCS_7:{type:"DRCS",code:71,bytes:1,dict:new Map},DRCS_8:{type:"DRCS",code:72,bytes:1,dict:new Map},DRCS_9:{type:"DRCS",code:73,bytes:1,dict:new Map},DRCS_10:{type:"DRCS",code:74,bytes:1,dict:new Map},DRCS_11:{type:"DRCS",code:75,bytes:1,dict:new Map},DRCS_12:{type:"DRCS",code:76,bytes:1,dict:new Map},DRCS_13:{type:"DRCS",code:77,bytes:1,dict:new Map},DRCS_14:{type:"DRCS",code:78,bytes:1,dict:new Map},DRCS_15:{type:"DRCS",code:79,bytes:1,dict:new Map},MACRO:{type:"MACRO",code:112,bytes:1,dict:wt}};class Ut extends ft{static NORMAL_DICT_USE_PUA={...Ft};static NORMAL_DICT_USE_UNICODE={...Ft};static{const e=new Map,t=new Map,r=new TextDecoder("euc-jp",{fatal:!0});for(let i=33;i<117;i++)for(let a=33;a<127;a++)try{const n=i<<8|a,s=r.decode(Uint8Array.from([128|i,128|a]));e.set(n,s),t.set(n,s)}catch(e){}for(let t=117;t<127;t++)for(let r=33;r<127;r++){const i=t<<8|r;mt.has(i)&&e.set(i,mt.get(i))}for(let e=117;e<127;e++)for(let r=33;r<127;r++){const i=e<<8|r;bt.has(i)&&t.set(i,bt.get(i))}this.NORMAL_DICT_USE_PUA={...Ft,KANJI:{...Ft.KANJI,dict:e},ADDITIONAL_SYMBOLS:{...Ft.ADDITIONAL_SYMBOLS,dict:e}},this.NORMAL_DICT_USE_UNICODE={...Ft,KANJI:{...Ft.KANJI,dict:t},ADDITIONAL_SYMBOLS:{...Ft.ADDITIONAL_SYMBOLS,dict:t}}}constructor(e){const t=e?.usePUA?Ut.NORMAL_DICT_USE_PUA:Ut.NORMAL_DICT_USE_UNICODE;super(0,2,[t.KANJI,t.ASCII,t.HIRAGANA,At.MACRO],t,At,new Set(["´","`","｀","¨","^","＾","‾","￣","_","＿","◯"]))}}const yt={ASCII:{type:"Character",code:74,bytes:1,dict:qe},LATIN_EXTENSION:{type:"Character",code:75,bytes:1,dict:new Map([[33,"¡"],[34,"¢"],[35,"£"],[36,"¤"],[37,"¥"],[38,"¦"],[39,"§"],[40,"¨"],[41,"©"],[42,"ª"],[43,"«"],[44,"¬"],[45,"Ÿ"],[46,"®"],[47,"¯"],[48,"°"],[49,"±"],[50,"²"],[51,"³"],[52,"´"],[53,"µ"],[54,"¶"],[55,"·"],[56,"¸"],[57,"¹"],[58,"º"],[59,"»"],[60,"¼"],[61,"½"],[62,"¾"],[63,"¿"],[64,"À"],[65,"Á"],[66,"Â"],[67,"Ã"],[68,"Ä"],[69,"Å"],[70,"Æ"],[71,"Ç"],[72,"È"],[73,"É"],[74,"Ê"],[75,"Ë"],[76,"Ì"],[77,"Í"],[78,"Î"],[79,"Ï"],[80,"Ð"],[81,"Ñ"],[82,"Ò"],[83,"Ó"],[84,"Ô"],[85,"Õ"],[86,"Ö"],[87,"×"],[88,"Ø"],[89,"Ù"],[90,"Ú"],[91,"Û"],[92,"Ü"],[93,"Ý"],[94,"Þ"],[95,"ß"],[96,"à"],[97,"á"],[98,"â"],[99,"ã"],[100,"ä"],[101,"å"],[102,"æ"],[103,"ç"],[104,"è"],[105,"é"],[106,"ê"],[107,"ë"],[108,"ì"],[109,"í"],[110,"î"],[111,"ï"],[112,"ð"],[113,"ñ"],[114,"ò"],[115,"ó"],[116,"ô"],[117,"õ"],[118,"ö"],[119,"÷"],[120,"ø"],[121,"ù"],[122,"ú"],[123,"û"],[124,"ü"],[125,"ý"],[126,"þ"]])},SPECIAL_CHARACTERS:{type:"Character",code:76,bytes:1,dict:new Map([[33,"♪"],[48,"¤"],[49,"¦"],[50,"¨"],[51,"´"],[52,"¸"],[53,"¼"],[54,"½"],[55,"¾"],[64,"…"],[65,"█"],[66,"‘"],[67,"’"],[68,"“"],[69,"”"],[70,"•"],[71,"™"],[72,"⅛"],[73,"⅜"],[74,"⅝"],[75,"⅞"]])}},Ct={};class St extends ft{constructor(){super(0,2,[yt.ASCII,yt.ASCII,yt.LATIN_EXTENSION,yt.SPECIAL_CHARACTERS],yt,Ct,new Set([]))}}const kt=(e,t,r,i)=>({width:e,height:t,depth:r,binary:i}),vt=e=>{if(e.exists(1)){const t=e.peekU8();if(0<=t&&t<=32||127==t)return!0}if(e.exists(2)){const t=e.peekU16();if(49792<=t&&t<=49823)return!0}return!1};class Tt extends ht{segmenter=new Intl.Segmenter(void 0,{granularity:"grapheme"});decoder=new TextDecoder("utf-8",{fatal:!0});drcs=new Map;tokenizeStatement(e){const t=new Ze(e),r=[];for(;!t.isEmpty();){if(!vt(t)){const e=[];for(;!t.isEmpty()&&!vt(t);)e.push(t.readU8());for(const t of Array.from(this.segmenter.segment(this.decoder.decode(Uint8Array.from(e))),({segment:e})=>e)){const[e,...i]=Array.from(t);if(this.drcs.has(e)){const{width:t,height:a,depth:n,binary:s}=this.drcs.get(e);r.push(v(t,a,n,s,i.join("")))}else r.push(k(t))}continue}const e=t.peekU8();if(t.exists(1)&&0<=e&&e<=32||e===ot){switch(e){case 15:case 14:case 25:case 29:throw new w("Single/Locking Shift is Not used in UTF-8");case st:throw new m("ESC in UTF-8 is Not Implemented")}r.push(lt(t))}else{if(!(t.exists(2)&&49792<=t.peekU16()&&t.peekU16()<=49823))throw new U("Undefined Conrtol Code in STD-B24 ARIB Caption");t.readU8(),r.push(dt(t))}}return r}processDRCS(e,t){if(1===e)throw new w("Not used 1-byte DRCS in UTF-8");const r=new Uint8Array(t);let i=0,a=r.byteLength;for(r[i+0],i+=1;i<a;){const e=r[i+0]<<8|r[i+1],t=r[i+2];i+=3;for(let a=0;a<t;a++){r[i+0];const t=15&r[i+0];if(0!==t&&1!==t)return;{const t=r[i+1]+2,a=r[i+2],n=r[i+3],s=[0,1,6,2,7,5,4,3][29*t>>5],o=Math.floor(a*n*s/8),c=r.slice(i+4,i+4+o).buffer;this.drcs.set(String.fromCodePoint(e),kt(a,n,s,c)),i+=4+o}}}}}const Mt=e=>({...e,recieve:{association:null,type:"Caption",language:0,...e?.recieve},tokenizer:{pua:!1,...e?.tokenizer},offset:{time:0,...e?.offset}}),_t=(e,t,r)=>{if(1===t)return["ARIB",new Tt,Xe];if(0!==t)throw new w("not Supported TCS");switch(r.recieve.association){case"ARIB":return["ARIB",new Ut({usePUA:r.tokenizer.pua}),Xe];case"SBTVD":return["SBTVD",new St,Ye]}switch(e){case"jpn":case"eng":return["ARIB",new Ut({usePUA:r.tokenizer.pua}),Xe];case"spa":case"por":return["SBTVD",new St,Ye]}return["UNKNOWN",new Ut({usePUA:r.tokenizer.pua}),Xe]},Dt=e=>{const t=new Uint8Array(e);if(t.byteLength<=0)return null;const r=t[0];if(128!==r&&129!==r)return null;const i=128===r?"Caption":"Superimpose";if(t.byteLength<=2)return null;const a=3+(15&t[2]);return t.byteLength<a?null:{tag:i,data:e.slice(a)}},It=e=>({tag:"Statement",data:e}),Rt=(e,t)=>({tag:"DRCS",data:e,bytes:t}),Bt=e=>{const t=e.readU8();return[(240&t)>>4,15&t]},xt=e=>{const t=[Bt(e),Bt(e),Bt(e),Bt(e),Bt(e)].flatMap(e=>e);return[10*t[0]+t[1],10*t[2]+t[3],10*t[4]+t[5],100*t[6]+10*t[7]+t[8]]},Et=e=>{const t=new Ze(e),r=(252&t.readU8())>>2,i=(32&r)>>5,a=15&r;if(t.readU8(),t.readU8(),t.readU16(),0===a){const e=(192&t.readU8())>>6,r=2===e?{timeControlMode:e,offsetTime:xt(t)}:{timeControlMode:e},a=t.readU8(),n=[];for(let e=0;e<a;e++){const e=t.readU8(),r=(224&e)>>5,i=15&e,a=12===i||13===i||14===i?{displayMode:i,displayConditionDesignation:t.readU8()}:{displayMode:i},s=String.fromCharCode(t.readU8(),t.readU8(),t.readU8()),o=t.readU8(),c=(240&o)>>4,l=(12&o)>>2,d=3&o;n.push({...a,lang:r,iso_639_language_code:s,TCS:l,format:c,rollup:d})}const s=t.readU24(),o=[];let c=0;for(;c<s;){t.readU8();const e=t.readU8(),r=t.readU24();switch(e){case 32:o.push({tag:"Statement",data:t.read(r)});break;case 48:o.push({tag:"DRCS",bytes:1,data:t.read(r)});break;case 49:o.push({tag:"DRCS",bytes:2,data:t.read(r)});break;case 53:o.push({tag:"Bitmap",data:t.read(r)});break;default:t.read(r)}c+=5+r}return t.readU16(),{...r,tag:"CaptionManagement",group:i,languages:n,units:o}}{const e=(192&t.readU8())>>6,r=1===e||2===e?{timeControlMode:e,presentationStartTime:xt(t)}:{timeControlMode:e},n=t.readU24(),s=[];let o=0;for(;o<n;){t.readU8();const e=t.readU8(),r=t.readU24();switch(e){case 32:s.push({tag:"Statement",data:t.read(r)});break;case 48:s.push({tag:"DRCS",bytes:1,data:t.read(r)});break;case 49:s.push({tag:"DRCS",bytes:2,data:t.read(r)});break;case 53:s.push({tag:"Bitmap",data:t.read(r)});break;default:t.read(r)}o+=5+r}return t.readU16(),{...r,tag:"CaptionStatement",group:i,lang:a-1,units:s}}},Nt=(e,t)=>({tag:"Script",sup:e,sub:t}),Lt=e=>({tag:"Normal",text:e}),$t=(e,t)=>({tag:"Ruby",text:e,ruby:t}),Pt=e=>"Middle"===e?"Normal":e,zt="GUESS_RUBY",Ot=(e,t,r)=>{const i=e.filter(e=>"Character"===e.tag||"DRCS"===e.tag).toSorted((e,t)=>e.state.position[1]!==t.state.position[1]?Math.sign(e.state.position[1]-e.state.position[1]):Math.sign(e.state.position[0]-e.state.position[0])),a=[];for(const e of i){const t=a.find(t=>{const r=t.position[0]+t.area[0],i=t.position[1],a=e.state.position[0],n=e.state.position[1]+1-We.box(e.state)[1];return r==a&&i==n}),r=null!=t&&t.background===e.state.background,i=null!=t&&t.highlight===(0!==e.state.highlight),n=null!=t&&Pt(t.size)===Pt(e.state.size);r&&i&&n?(t.area=[t.area[0]+We.box(e.state)[0],t.area[1]],t.spans.push(Lt([e]))):a.push({plane:[...e.state.plane],margin:[...e.state.margin],position:[e.state.position[0],e.state.position[1]-(We.box(e.state)[1]-1)],area:[We.box(e.state)[0],We.box(e.state)[1]],size:Pt(e.state.size),fontsize:e.state.fontsize,background:e.state.background,highlight:0!==e.state.highlight,spans:[Lt([e])]})}for(const{spans:e}of a)for(let t=0;t<e.length-1;t++){const r=e[t+0],i=e[t+1];"Normal"===r.tag&&r.tag===i.tag&&(r.text.push(...i.text),e.splice(t+1,1),t--)}if("ARIB"!==t.association)return a;for(;;){let e=!1;e:for(const t of a.filter(({size:e})=>e===xe)){const r=t.position[0]+t.area[0],i=t.position[1]+0,n=t.position[1]+t.area[1];for(let s=0;s<a.length;s++){const o=a[s];if(o.size!==Re)continue;const c=o.position[0],l=o.position[1];if(r===c&&i===l)for(let i=0;i<a.length;i++){if(i===s)continue;const c=a[i];if(c.size!==Re)continue;const l=c.position[0],d=c.position[1]+c.area[1];if(r!==l||n!==d)continue;t.area[0]+=Math.min(o.area[0],c.area[0]);const h=Math.min(o.spans[0].text.length,c.spans[0].text.length),u=[];for(let e=0;e<h;e++){let t=o.spans.at(0)?.text.at(e)??null,r=c.spans.at(0)?.text.at(e)??null;null!=t&&"Script"!=t.tag&&null!=r&&"Script"!=r.tag&&u.push(Nt(t,r))}t.spans.push(Lt(u)),a.splice(Math.max(s,i),1),a.splice(Math.min(s,i),1),e=!0;break e}}}if(!e)break}for(;;){let e=!1;e:for(let t=0;t<a.length;t++){const r=a[t].position[0]+a[t].area[0],i=a[t].position[1]+0,n=a[t].position[1]+a[t].area[1];for(let s=t+1;s<a.length;s++){const o=a[s].position[0],c=a[s].position[1]+0,l=a[s].position[1]+a[s].area[1];if(r===o&&i===c&&n===l){a[t].area[0]+=a[s].area[0],a[t].spans.push(...a[s].spans),a.splice(s,1),e=!0;break e}}}if(!e)break}if(r===zt)for(;;){let e=!1;e:for(const t of a.filter(({size:e})=>e===xe)){const r=t.position[0]+0,i=t.position[0]+t.area[0],n=t.position[1];let s=null,o=0;for(let e=0;e<a.length;e++){const t=a[e];if(t.size!==Re)continue;const c=t.position[0]+0,l=t.position[0]+t.area[0];if(n!==t.position[1]+t.area[1])continue;if(r>=l||i<=c)continue;const d=Math.min(i,l)-Math.max(r,c);d>o&&(o=d,s=e)}if(null!=s){const r=a[s];if(r.size!==Re)continue;const i=r.position[0]+0,n=r.position[0]+r.area[0],o=t.spans.flatMap(e=>e.text),c=o.filter(e=>{const t="Script"===e.tag?e.sup:e;return t.state.position[0],t.state.position[0]+We.box(t.state)[0]<=i}),l=o.filter(e=>{const t="Script"===e.tag?e.sup:e,r=t.state.position[0],a=t.state.position[0]+We.box(t.state)[0];return i<a&&r<n}),d=o.filter(e=>{const t="Script"===e.tag?e.sup:e,r=t.state.position[0];return t.state.position[0],We.box(t.state)[0],n<=r}),h=r.spans.flatMap(e=>e.text);t.spans=[Lt(c),$t(l,h),Lt(d)],a.splice(s,1),e=!0;break e}}if(!e)break}return"PRESERVE"===r?a:a.filter(e=>e.size!==Re)},Ht={async from(e,t){const r=new Uint8Array(e.binary),i=new Set(e.flc_colors),a=r.subarray(0,33),n=r.subarray(33,r.byteLength),s=new Uint8Array(a.byteLength+n.byteLength+396+140),o=new DataView(s.buffer);s.set(a,0),s.set(n,569);for(let e=0;e<t.length;e++){const r=t[e],a=Number.parseInt(r.substring(1,3),16),n=Number.parseInt(r.substring(3,5),16),o=Number.parseInt(r.substring(5,7),16),c=Number.parseInt(r.substring(7,9),16);s[41+3*e+0]=a,s[41+3*e+1]=n,s[41+3*e+2]=o,s[437+e]=i.has(e)?0:c}o.setInt32(33,384,!1),s[37]="P".charCodeAt(0),s[38]="L".charCodeAt(0),s[39]="T".charCodeAt(0),s[40]="E".charCodeAt(0),o.setInt32(429,128,!1),s[433]="t".charCodeAt(0),s[434]="R".charCodeAt(0),s[435]="N".charCodeAt(0),s[436]="S".charCodeAt(0),o.setInt32(425,Ie(s,37,425),!1),o.setInt32(565,Ie(s,433,565),!1);const c=o.getInt32(16,!1),l=o.getInt32(20,!1),d=new Image(c,l);d.src="data:image/png;base64,"+btoa(String.fromCharCode(...s)),await d.decode();const h=await createImageBitmap(d);if(0===i.size)return{tag:"Bitmap",x_position:e.x_position,y_position:e.y_position,width:c,height:l,normal_dataurl:d.src,normal_bitmap:h};for(let e=0;e<t.length;e++){const r=t[e],a=Number.parseInt(r.substring(7,9),16);s[437+e]=i.has(e)?a:0}o.setInt32(425,Ie(s,37,425),!1),o.setInt32(565,Ie(s,433,565),!1);const u=new Image(c,l);u.src="data:image/png;base64,"+btoa(String.fromCharCode(...s)),await u.decode();const f=await createImageBitmap(u);return{tag:"Bitmap",x_position:e.x_position,y_position:e.y_position,width:c,height:l,normal_dataurl:d.src,normal_bitmap:h,flashing_dataurl:u.src,flashing_bitmap:f}}},Gt=(e,t,r)=>({tag:"Bitmap",state:structuredClone(t),option:structuredClone(r),x_position:e.x_position*r.magnification,y_position:e.y_position*r.magnification,width:e.width*r.magnification,height:e.height*r.magnification,normal_dataurl:e.normal_dataurl,normal_bitmap:e.normal_bitmap,flashing_dataurl:e.flashing_dataurl,flashing_bitmap:e.flashing_bitmap}),Vt=async(e,t)=>{let r=[];for(const i of e)"Bitmap"===i.tag?r.push(await Ht.from(i,t)):r.push(i);return r};class jt{praser;constructor(e,t){this.praser=new We(e,t)}currentState(){return this.praser.currentState()}currentOption(){return this.praser.currentOption()}parseBitmapOrInherit(e){return"Bitmap"!==e.tag?this.praser.parseToken(e):[Gt(e,this.praser.currentState(),this.praser.currentOption())]}parse(e){return e.flatMap(this.parseBitmapOrInherit.bind(this))}}const Kt=(e,t)=>((e,t)=>e.map(e=>{if("DRCS"!==e.tag)return e;const r=nt(e.binary);return t.has(r.toLowerCase())||t.has(r.toUpperCase())?k(t.get(r)+e.combining):e}))(e,t),Jt=["#000000FF","#FF0000FF","#00FF00FF","#FFFF00FF","#0000FFFF","#FF00FFFF","#00FFFFFF","#FFFFFFFF","#00000000","#AA0000FF","#00AA00FF","#AAAA00FF","#0000AAFF","#AA00AAFF","#00AAAAFF","#AAAAAAFF","#000055FF","#005500FF","#005555FF","#0055AAFF","#0055FFFF","#00AA55FF","#00AAFFFF","#00FF55FF","#00FFAAFF","#550000FF","#550055FF","#5500AAFF","#5500FFFF","#555500FF","#555555FF","#5555AAFF","#5555FFFF","#55AA00FF","#55AA55FF","#55AAAAFF","#55AAFFFF","#55FF00FF","#55FF55FF","#55FFAAFF","#55FFFFFF","#AA0055FF","#AA00FFFF","#AA5500FF","#AA5555FF","#AA55AAFF","#AA55FFFF","#AAAA55FF","#AAAAFFFF","#AAFF00FF","#AAFF55FF","#AAFFAAFF","#AAFFFFFF","#FF0055FF","#FF00AAFF","#FF5500FF","#FF5555FF","#FF55AAFF","#FF55FFFF","#FFAA00FF","#FFAA55FF","#FFAAAAFF","#FFAAFFFF","#FFFF55FF","#FFFFAAFF","#00000080","#FF000080","#00FF0080","#FFFF0080","#0000FF80","#FF00FF80","#00FFFF80","#FFFFFF80","#AA000080","#00AA0080","#AAAA0080","#0000AA80","#AA00AA80","#00AAAA80","#AAAAAA80","#00005580","#00550080","#00555580","#0055AA80","#0055FF80","#00AA5580","#00AAFF80","#00FF5580","#00FFAA80","#55000080","#55005580","#5500AA80","#5500FF80","#55550080","#55555580","#5555AA80","#5555FF80","#55AA0080","#55AA5580","#55AAAA80","#55AAFF80","#55FF0080","#55FF5580","#55FFAA80","#55FFFF80","#AA005580","#AA00FF80","#AA550080","#AA555580","#AA55AA80","#AA55FF80","#AAAA5580","#AAAAFF80","#AAFF0080","#AAFF5580","#AAFFAA80","#AAFFFF80","#FF005580","#FF00AA80","#FF550080","#FF555580","#FF55AA80","#FF55FF80","#FFAA0080","#FFAA5580","#FFAAAA80","#FFAAFF80","#FFFF5580"],Wt=({dts:e})=>e,Xt=(e,t)=>Math.sign(e-t),Yt=(e,t)=>0!==Xt(e.dts,t.dts)?Xt(e.dts,t.dts):Xt(e.lang??-1,t.lang??-1),qt=e=>{for(const t of e.data)"Bitmap"===t.tag&&(t.normal_bitmap.close(),t.flashing_bitmap?.close())};class Zt{option;priviousTime=null;priviousManagementData=null;desiredLang=null;decoder=new S(Yt,Xt,Wt);decoderBuffer=[];decodingPromise;decodingNotify=Promise.resolve;abortController=new AbortController;present=new S(Xt,Xt,e=>e);isDestroyed=!1;constructor(e){this.option=Mt(e),this.decodingPromise=new Promise(e=>{this.decodingNotify=e}),this.pump()}notify(e){null!=e?this.decoderBuffer.push(e):(this.abortController.abort(),this.abortController=new AbortController),this.decodingNotify?.()}async*generator(e){for(;;){if(await this.decodingPromise,this.decodingPromise=new Promise(e=>{this.decodingNotify=e}),e.aborted)return void(this.decoderBuffer=[]);const t=[...this.decoderBuffer];this.decoderBuffer=[],yield*t}}async pump(){for(;!this.isDestroyed;)for await(const{pts:e,caption:t}of this.generator(this.abortController.signal)){if("CaptionManagement"===t.tag){if(this.priviousManagementData?.group===t.group)continue;if("number"==typeof this.option.recieve.language)this.desiredLang=this.option.recieve.language;else{const e="string"==typeof this.option.recieve.language?this.option.recieve.language:this.option.recieve.language[0],r="string"==typeof this.option.recieve.language?0:this.option.recieve.language[1],i=[...t.languages].sort(({lang:e},{lang:t})=>e-t).filter(({iso_639_language_code:t})=>t===e);this.desiredLang=i?.[r]?.lang??null}this.priviousManagementData=t,this.present.insert(e,{pts:e,duration:Number.POSITIVE_INFINITY,state:Ge,info:{association:"UNKNOWN",language:"und"},data:[x()]});continue}if(null==this.priviousManagementData)continue;const r=this.priviousManagementData.languages.find(e=>e.lang===t.lang);if(null==r)continue;if(this.desiredLang!==t.lang)continue;const i=_t(r.iso_639_language_code,r.TCS,this.option);if(null==i)continue;const[a,n,s]=i,o=await Vt(n.tokenize(t),Jt);let c=Number.POSITIVE_INFINITY,l=0;for(const e of o)if("ClearScreen"===e.tag){if(0===l)continue;c=l}else"TimeControlWait"===e.tag&&(l+=e.seconds);this.present.insert(e,{pts:e,duration:c,state:s,info:{association:a,language:r.iso_639_language_code},data:o})}}feed(e,t,r){const i=Dt(e);if(null==i)return;if(i.tag!==this.option.recieve.type)return;const a=Et(i.data);if(null==a)return;const n="CaptionStatement"===a.tag?a.lang+1:0;t+=this.option.offset.time,r+=this.option.offset.time,this.decoder.insert({dts:r,lang:n},{pts:t,caption:a})}prepare(e){this.priviousTime=e}content(e){if(null!=this.priviousTime)for(const t of this.decoder.range(this.priviousTime,e))this.notify(t);return this.priviousTime=e,this.present.floor(e)??null}clear(){this.decoder.clear(),this.disappearance()}disappearance(){this.present.forEach(qt),this.present.clear(),this.priviousTime=null,this.priviousManagementData=null,this.notify(null)}onAttach(){this.disappearance()}onDetach(){this.disappearance()}onSeeking(){this.disappearance()}destroy(){this.isDestroyed=!0,this.disappearance()}}class Qt extends Zt{constructor(e){super(e)}feedB24(e,t,r){this.feed(e,t,r??t)}feedID3(e,t,r){for(const i of p(e))switch(i.id){case"PRIV":if("aribb24.js"!==i.owner)break;this.feed(i.data,t,r??t);break;case"TXXX":if("aribb24.js"!==i.description)break;this.feed(d(i.text).buffer,t,r??t)}}}class er extends Zt{media=null;timer=null;privious_time=null;id3Tracks=[];onAddTrackHandler=this.onAddTrack.bind(this);onRemoveTrackHandler=this.onRemoveTrack.bind(this);onPlayHandler=this.onPlay.bind(this);onPauseHandler=this.onPause.bind(this);introspectHandler=this.introspect.bind(this);constructor(e){super(e)}attachMedia(e){this.detachMedia(),this.media=e,this.setupHandlers(),this.registerID3Track()}detachMedia(){this.unregisterID3Track(),this.cleanupHandlers(),this.media=null,this.privious_time=null}static isID3Track(e){return"metadata"===e.kind&&("com.apple.streaming"===e.inBandMetadataTrackDispatchType||"id3"===e.label||"Timed Metadata"===e.label)}setupHandlers(){null!=this.media&&(this.media.textTracks.addEventListener("addtrack",this.onAddTrackHandler),this.media.textTracks.addEventListener("removetrack",this.onRemoveTrackHandler),this.media.addEventListener("play",this.onPlayHandler),this.media.addEventListener("pause",this.onPauseHandler))}cleanupHandlers(){null!=this.media&&(this.media.textTracks.removeEventListener("addtrack",this.onAddTrackHandler),this.media.textTracks.removeEventListener("removetrack",this.onRemoveTrackHandler),this.media.removeEventListener("play",this.onPlayHandler),this.media.removeEventListener("pause",this.onPauseHandler))}destroy(){this.detachMedia()}registerID3Track(){if(null!=this.media)for(const e of Array.from(this.media.textTracks))er.isID3Track(e)&&this.id3Tracks.push(e)}unregisterID3Track(){this.id3Tracks=[]}onAddTrack(e){const t=e.track;er.isID3Track(t)&&this.id3Tracks.push(t)}onRemoveTrack(e){const t=e.track;er.isID3Track(t)&&(this.id3Tracks=this.id3Tracks.filter(e=>e!=e))}introspect(){if(this.registerRenderingLoop(),null==this.media)return;const e=this.media.currentTime;if(null!=this.privious_time){for(const t of this.id3Tracks){const r=Array.from(t.cues??[]);if(0===r.length)continue;let i=null,a=null;{let t=0,a=r.length;for(;t+1<a;){const i=Math.floor((t+a)/2);e<r[i].startTime?a=i:t=i}i=t}{let t=0,i=r.length;for(;t+1<i;){const a=Math.floor((t+i)/2);e<r[a].startTime?i=a:t=a}a=t}if(null!==i&&null!==a&&i!==a)if(i<a)for(let e=a;e>i;e--)this.feedID3v2Cue(r[e]);else for(let e=i;e<a;e++)this.feedID3v2Cue(r[e])}this.privious_time=e}else this.privious_time=e}registerRenderingLoop(){this.timer=requestAnimationFrame(this.introspectHandler)}unregisterRenderingLoop(){null!=this.timer&&(cancelAnimationFrame(this.timer),this.timer=null)}onPlay(){null==this.timer&&this.registerRenderingLoop()}onPause(){this.unregisterRenderingLoop()}feedID3v2Cue(e){if(null==e.track)return;const t=e;"com.apple.streaming"===e.track.inBandMetadataTrackDispatchType||"id3"===e.track.label?"PRIV"===t.value.key&&"aribb24.js"===t.value.info?this.feed(t.value.data,e.startTime,e.startTime):"TXXX"===t.value.key&&"aribb24.js"===t.value.info&&this.feed(d(t.value.data).buffer,e.startTime,e.startTime):"Timed Metadata"===e.track.label&&("PRIV"===t.frame.key&&"aribb24.js"===t.frame.owner?this.feed(t.frame.data,e.startTime,e.startTime):"TXXX"===t.frame.key&&"aribb24.js"===t.frame.description&&this.feed(d(t.frame.data).buffer,e.startTime,e.startTime))}feedB24(e,t,r){this.feed(e,t,r??t)}feedID3(e,t,r){for(const i of p(e))switch(i.id){case"PRIV":if("aribb24.js"!==i.owner)break;this.feed(i.data,t,r??t);break;case"TXXX":if("aribb24.js"!==i.description)break;this.feed(d(i.text).buffer,t,r??t)}}}const tr=/^(\d\d):(\d\d):(\d\d);(\d\d)$/,rr=e=>(e=>{const t=Math.floor(e/107892),r=Math.floor((e+2*Math.floor((e-107892*t)/1800)-2*Math.floor((e-107892*t)/18e3)-107892*t)/1800),i=Math.floor((e-1798*r-2*Math.floor(r/10)-107892*t)/30),a=e-30*i-1798*r-2*Math.floor(r/10)-107892*t;return`${t.toString(10).padStart(2,"0")}:${r.toString(10).padStart(2,"0")}:${i.toString(10).padStart(2,"0")};${a.toString(10).padStart(2,"0")}`})((e=>Math.floor(3e4*e/1001+1e-5))(e)),ir=e=>{return t=(e=>{const t=e.match(tr);if(null==t)throw new F("Unexpected TimeCode");const r=Number.parseInt(t[1],10),i=Number.parseInt(t[2],10),a=60*r+i;return 30*(60*(60*r+i)+Number.parseInt(t[3],10))+Number.parseInt(t[4],10)-2*(a-Math.floor(a/10))})(e),Math.ceil(1001*t/3e4*1e3)/1e3;var t},ar=e=>{const t=new Ze(e),r=(252&t.readU8())>>2,i=(32&r)>>5,a=15&r;if(t.readU8(),t.readU8(),t.readU16(),0===a){const e=(192&t.readU8())>>6,r=xt(t),a=2===e?{timeControlMode:e,offsetTime:r}:{timeControlMode:e},n=(t.readU8(),[]);for(let e=0;e<1;e++){const e=t.readU8(),r=(224&e)>>5,i=15&e,a=t.readU8(),s=12===i||13===i||14===i?{displayMode:i,displayConditionDesignation:a}:{displayMode:i},o=String.fromCharCode(t.readU8(),t.readU8(),t.readU8()),c=t.readU8(),l=(240&c)>>4,d=(12&c)>>2,h=3&c;n.push({...s,lang:r,iso_639_language_code:o,TCS:d,format:l,rollup:h})}return{...a,tag:"CaptionManagement",group:i,languages:n,units:[]}}{const e=(192&t.readU8())>>6,r=xt(t),n=1===e||2===e?{timeControlMode:e,presentationStartTime:r}:{timeControlMode:e},s=t.readU24(),o=[];let c=0;for(;c<s;){t.readU8();const e=t.readU8(),r=t.readU24();switch(e){case 32:o.push({tag:"Statement",data:t.read(r)});break;case 48:o.push({tag:"DRCS",bytes:1,data:t.read(r)});break;case 49:o.push({tag:"DRCS",bytes:2,data:t.read(r)});break;case 53:o.push({tag:"Bitmap",data:t.read(r)});break;default:t.read(r)}c+=5+r}return{...n,tag:"CaptionStatement",group:i,lang:a-1,units:o}}},nr="T",sr="F",or=e=>{const t=256,r=new TextDecoder("shift-jis",{fatal:!0}),i=new Ze(e),a=r.decode(i.read(8));if("DCAPTION"!==a&&"BCAPTION"!==a&&"MCAPTION"!==a)throw new b(`Undefined CaptionDataLabel: ${a}`);i.read(248);const n=i.readU32(),s=new Ze(i.read(Math.floor((4+n+255)/t)*t-4)),o=r.decode(s.read(6)).trim(),c=r.decode(s.read(27)).trim(),l=r.decode(s.read(40)).trim(),d=r.decode(s.read(40)).trim(),h=String.fromCharCode(s.readU8());switch(h){case"0":case"1":case"2":case"3":break;default:throw new b(`Undefined programMaterialType: ${h}`)}const u=String.fromCharCode(s.readU8());switch(u){case"N":case"R":case"A":case" ":break;default:throw new b(`Undefined registrationMode: ${u}`)}const f=r.decode(s.read(3)),p=String.fromCharCode(s.readU8());switch(p){case"0":case"1":case"2":case"3":break;default:throw new b(`Undefined displayMode: ${p}`)}const g=String.fromCharCode(s.readU8());switch(g){case"0":case"1":case"2":case"3":break;default:throw new b(`Undefined displayMode: ${g}`)}const m=`${p}${g}`,w=String.fromCharCode(s.readU8());switch(w){case" ":case"T":case"C":break;default:throw new b(`Undefined programType: ${w}`)}const F=String.fromCharCode(s.readU8());if("*"!==F&&" "!==F)throw new b(`Undefined sound: ${F}`);const A="*"===F,U=Number.parseInt(String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8()),10),y=Number.parseInt(String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8()),10),C=String.fromCharCode(s.readU8());if("*"!==F&&" "!==F)throw new b(`Undefined sound: ${F}`);const S="*"===C,k=String.fromCharCode(s.readU8(),s.readU8());switch(k){case"TC":case"TU":case"LT":case"JS":break;default:throw new b(`Undefined realtimeTimingType: ${k}`)}const v=String.fromCharCode(s.readU8());switch(v){case nr:case sr:break;default:throw new b(`Undefined TimingUnitType: ${v}`)}const T=String.fromCharCode(s.readU8(),s.readU8()),M=String.fromCharCode(s.readU8(),s.readU8()),_=String.fromCharCode(s.readU8(),s.readU8()),D=String.fromCharCode(s.readU8(),s.readU8());s.readU8();const I="F"===v?ir(`${T}:${M}:${_};${D}`):60*(60*Number.parseInt(T,10)+Number.parseInt(M,10))+Number.parseInt(_,10)+Number.parseInt(D,10)/100,R=String.fromCharCode(s.readU8());switch(R){case"A":case"P":case"T":break;default:throw new b(`Undefined syncronizationMode: ${R}`)}const B=String.fromCharCode(s.readU8(),s.readU8());switch(B){case"FR":case"RT":case"OF":break;default:throw new b(`Undefined timeControlMode: ${B}`)}const x=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8());if(/[^* ]/.test(x))throw new b(`Undefined extensible: ${x}`);const E=["*"===x[0],"*"===x[1],"*"===x[2],"*"===x[3],"*"===x[4],"*"===x[5],"*"===x[6],"*"===x[7]],N=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8());if(/[^* ]/.test(N))throw new b(`Undefined extensible: ${N}`);const L=["*"===N[0],"*"===N[1],"*"===N[2],"*"===N[3],"*"===N[4],"*"===N[5],"*"===N[6],"*"===N[7]],$=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8()),P="        "!==$?[Number.parseInt($.slice(0,4),10),Number.parseInt($.slice(4,6),10),Number.parseInt($.slice(6,8),10)]:null,z=r.decode(s.read(20)).trim(),O=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8()),H="            "!==O?[Number.parseInt(O.slice(0,4),10),Number.parseInt(O.slice(4,6),10),Number.parseInt(O.slice(6,8),10),Number.parseInt(O.slice(8,10),10),Number.parseInt(O.slice(10,12),10)]:null,G=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8()),V="        "!==G?[Number.parseInt(G.slice(0,4),10),Number.parseInt(G.slice(4,6),10),Number.parseInt(G.slice(6,8),10)]:null,j=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8()),K="        "!==j?[Number.parseInt(j.slice(0,4),10),Number.parseInt(j.slice(4,6),10),Number.parseInt(j.slice(6,8),10)]:null,J=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8());if(/[^* ]/.test(J))throw new b(`Undefined broadcastDaysOfWeek: ${J}`);const W=["*"===J[0],"*"===J[1],"*"===J[2],"*"===J[3],"*"===J[4],"*"===J[5],"*"===J[6]],X=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8()),Y="      "!==X?[Number.parseInt(X.slice(0,2),10),Number.parseInt(X.slice(2,4),10),Number.parseInt(X.slice(4,6),10)]:null,q=String.fromCharCode(s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8(),s.readU8()),Z="      "!==q?[Number.parseInt(q.slice(0,2),10),Number.parseInt(q.slice(2,4),10),Number.parseInt(q.slice(4,6),10)]:null,Q=r.decode(s.read(60)).trim();s.read(45);const ee=String.fromCharCode(s.readU8());if("*"!==ee&&" "!==ee)throw new b(`Undefined completed: ${ee}`);const te="*"===ee,re=String.fromCharCode(s.readU8());if("*"!==re&&" "!==re)throw new b(`Undefined usersAreaUsed: ${re}`);const ie="*"===re,ae=ie?{usersAreaUsed:ie,writingFormatConversionMode:s.readU8(),drcsConversionMode:(192&s.readU8())>>6}:{usersAreaUsed:ie},ne=[];for(;!i.isEmpty();){const e=i.readU32(),a=i.read(Math.floor((4+e+255)/t)*t-4),n=new DataView(a.slice(0,4+e));let s=0;if(n.byteLength<s+1+2)continue;const o=n.getUint16(s+1,!1);if(s+=3,n.byteLength<s+o)continue;const c=new Ze(n.buffer.slice(s,s+o)),l=String.fromCharCode(c.readU8(),c.readU8(),c.readU8(),c.readU8(),c.readU8(),c.readU8()),d=String.fromCharCode(c.readU8());switch(d){case"0":case"1":case"2":case"3":break;default:throw new b(`Undefined PageMaterialType: ${d}`)}const h=String.fromCharCode(c.readU8(),c.readU8());switch(h){case"RT":case"DT":case"UT":case"  ":break;default:throw new b(`Undefined DisplayTimingType: ${h}`)}const u=String.fromCharCode(c.readU8());switch(u){case nr:case sr:break;default:throw new b(`Undefined TimingUnitType: ${u}`)}const f=String.fromCharCode(c.readU8(),c.readU8()),p=String.fromCharCode(c.readU8(),c.readU8()),g=String.fromCharCode(c.readU8(),c.readU8()),m=String.fromCharCode(c.readU8(),c.readU8());c.readU8();const w="F"===u?ir(`${f}:${p}:${g};${m}`):60*(60*Number.parseInt(f,10)+Number.parseInt(p,10))+Number.parseInt(g,10)+Number.parseInt(m,10)/100,F=String.fromCharCode(c.readU8(),c.readU8()),A=String.fromCharCode(c.readU8(),c.readU8()),U=String.fromCharCode(c.readU8(),c.readU8()),y=String.fromCharCode(c.readU8(),c.readU8()),C=`${F}${A}${U}${y}`;c.readU8();const S="        "===C?Number.POSITIVE_INFINITY:"F"===u?ir(`${F}:${A}:${U};${y}`):60*(60*Number.parseInt(F,10)+Number.parseInt(A,10))+Number.parseInt(U,10)+Number.parseInt(y,10)/100,k=String.fromCharCode(c.readU8(),c.readU8());switch(k){case"FR":case"RT":case"OF":break;default:throw new b(`Undefined timeControlMode: ${k}`)}const v=String.fromCharCode(c.readU8(),c.readU8(),c.readU8());if("OFF"!==v&&"   "!==v)throw new b(`Undefined clearScreen: ${v}`);const T="OFF"===v,M=String.fromCharCode(c.readU8(),c.readU8());switch(M){case"ST":case"DB":case"EL":case"H2":case"H1":case"HD":case"SD":case"MB":break;default:throw new b(`Undefined formatDensity: ${M}`)}const _=String.fromCharCode(c.readU8());switch(_){case"H":case"V":break;default:throw new b(`Undefined formatWritingMode: ${_}`)}const D=`${M}${_}`,I=String.fromCharCode(c.readU8());switch(I){case" ":case"*":break;default:throw new b(`Undefined displayAspectRatio: ${I}`)}const R=String.fromCharCode(c.readU8(),c.readU8(),c.readU8(),c.readU8()),B=String.fromCharCode(c.readU8(),c.readU8(),c.readU8(),c.readU8()),x=String.fromCharCode(c.readU8(),c.readU8(),c.readU8(),c.readU8()),E=String.fromCharCode(c.readU8(),c.readU8(),c.readU8(),c.readU8()),N="    "!==R&&"    "!==B&&"    "!==x&&"    "!==E?[[Number.parseInt(R,10),Number.parseInt(B,10)],[Number.parseInt(x,10),Number.parseInt(E,10)]]:null,L=String.fromCharCode(c.readU8());switch(L){case"F":case"S":case"R":break;default:throw new b(`Undefined scrollType: ${L}`)}const $=String.fromCharCode(c.readU8());switch($){case"H":case"V":break;default:throw new b(`Undefined scrollDirectionType: ${$}`)}const P=String.fromCharCode(c.readU8());if("*"!==P&&" "!==P)throw new b(`Undefined sound: ${P}`);const z="*"===P,O=Number.parseInt(String.fromCharCode(c.readU8(),c.readU8(),c.readU8(),c.readU8(),c.readU8()),10),H=String.fromCharCode(c.readU8(),c.readU8(),c.readU8());if("ERS"!==H&&"   "!==H)throw new b(`Undefined deleted: ${H}`);const G="ERS"===H,V=r.decode(c.read(20)).trim();c.read(32);const j=String.fromCharCode(c.readU8());if("*"!==j&&" "!==j)throw new b(`Undefined completed: ${j}`);const K="*"===j,J=String.fromCharCode(c.readU8());if("*"!==J&&" "!==J)throw new b(`Undefined sound: ${J}`);const W="*"===J,X=W?{usersAreaUsed:W,writingFormatConversionMode:c.readU8(),drcsConversionMode:(192&c.readU8())>>6}:{usersAreaUsed:W},Y={pageMaterialType:d,displayTimingType:h,timingUnitType:u,displayTiming:w,clearTiming:S,timeControlMode:k,clearScreen:T,displayFormat:D,displayAspectRatio:I,displayWindowArea:N,scrollType:L,scrollDirectionType:$,sound:z,pageDataBytes:O,deleted:G,memo:V,completed:K};if(s+=o,n.byteLength<s+1+2)continue;const q=n.getUint16(s+1,!1);if(s+=3,n.byteLength<s+q)continue;const Z=ar(n.buffer.slice(s,s+q));if(null==Z||"CaptionManagement"!==Z.tag)continue;if("000000"===l){ne.push({...Y,...X,pageNumber:l,tag:"ReservedPage",management:Z});continue}if(s+=q,n.byteLength<s+1+3)continue;const Q=n.getUint16(s+1,!1)<<8|n.getUint8(s+3);if(s+=4,n.byteLength<s+Q)continue;const ee=ar(n.buffer.slice(s,s+Q));null!=ee&&"CaptionStatement"===ee.tag&&ne.push({...Y,...X,tag:"ActualPage",pageNumber:l,management:Z,statement:ee})}return{label:a,broadcasterIdentification:o,materialNumber:c,programTitle:l,programSubtitle:d,programMaterialType:h,registrationMode:u,languageCode:f,displayMode:m,programType:w,sound:A,totalPages:U,totalBytes:y,untime:S,realtimeTimingType:k,timingUnitType:v,initialTime:I,syncronizationMode:R,timeControlMode:B,extensible:E,compatible:L,expireDate:P,author:z,creationDateTime:H,broadcastStartDate:V,broadcastEndDate:K,broadcastDaysOfWeek:W,broadcastStartTime:Y,broadcastEndTime:Z,memo:Q,completed:te,...ae,pages:ne}};class cr{option;captions;constructor(e,t){this.option=Mt(t);const{initialTime:r,pages:i}=or(e);this.captions=i.filter(e=>"ActualPage"===e.tag).flatMap(e=>{const t=e.displayTiming-r+this.option.offset.time,i=e.clearTiming-r+this.option.offset.time-t,a=e.statement,n=e.management.languages.find(e=>e.lang===a.lang);if(null==n)return[];const s=_t(n.iso_639_language_code,n.TCS,this.option);if(null==s)return[];const[o,c,l]=s,d=c.tokenize(a).filter(e=>"Bitmap"!==e.tag);return[{pts:t,duration:i,state:l,info:{association:o,language:n.iso_639_language_code},data:d}]})}prepare(e){}content(e){{const t=this.captions[0];if(!t)return null;if(e<t.pts)return null}let t=0,r=this.captions.length;for(;t+1<r;){const i=Math.floor((t+r)/2);this.captions[i].pts<=e?t=i:r=i}return this.captions[t]??null}clear(){this.captions=[]}onAttach(){}onDetach(){}onSeeking(){}destroy(){this.clear()}}class lr{media=null;track=null;recognition;recognitionTime=null;interim="";privious="";endedHandler=this.capture.bind(this);clearHandler=this.clear.bind(this);recognitionEndHandler=this.recognitionEnd.bind(this);recognitionResultHandler=this.recognitionResult.bind(this);constructor(e="ja-JP"){this.recognition=new(globalThis.SpeechRecognition||globalThis.webkitSpeechRecognition),this.recognition.lang=e,this.recognition.interimResults=!0,this.recognition.mode="ondevice-only",this.recognition.addEventListener("end",this.recognitionEndHandler),this.recognition.addEventListener("error",this.clearHandler),this.recognition.addEventListener("result",this.recognitionResultHandler)}attachMedia(e){this.detachMedia(),this.media=e,this.media.addEventListener("ended",this.endedHandler),this.media.readyState>=HTMLMediaElement.HAVE_METADATA?this.capture():this.media.addEventListener("loadedmetadata",this.endedHandler,{once:!0})}detachMedia(){null!=this.media&&(this.media.removeEventListener("ended",this.endedHandler),this.media=null)}abort(){this.recognition.abort()}recognitionEnd(){null!=this.track&&(""!==this.interim&&(this.privious=this.interim,this.interim=""),this.recognition.start(this.track))}recognitionResult(e){if(null==this.media)return;const t=e.results;this.interim=Array.from(t).map(e=>e[0].transcript).join(""),this.recognitionTime=this.media.currentTime}capture(){if(null==this.media)return;const e=this.media.captureStream();this.track=e.getAudioTracks()[0],this.recognition.start(this.track)}clear(){this.recognitionTime=null,this.privious="",this.interim=""}onAttach(){this.clear()}onDetach(){this.clear()}onSeeking(){this.abort(),this.clear()}destroy(){this.abort(),this.recognition.removeEventListener("end",this.recognitionEndHandler),this.recognition.removeEventListener("error",this.clearHandler),this.recognition.removeEventListener("result",this.recognitionResultHandler),this.clear()}prepare(e){}content(e){if(null==this.media)return null;if(null==this.recognitionTime)return null;const t=this.privious+(""!==this.privious?"\n":"")+this.interim,r=[""];for(const e of t)r[r.length-1].length>=18&&r.push(""),"\n"==e?r.push(""):r[r.length-1]+=e;const i=(r.length>=2?r[r.length-2]:"").trim(),a=(r.length>=1?r[r.length-1]:"").trim(),n=[x(),we(7),Fe(780,480),Ae(118,29),ye(4),Ce(24),Ue(36,36),Z(),$(0,6),Y(),ne(4),re(1),Q(),...Array.from(i).map(e=>k(e)),...""!==i?[E()]:[],...Array.from(a).map(e=>k(e))];return{pts:this.recognitionTime,duration:Number.POSITIVE_INFINITY,state:Xe,info:{association:"ARIB",language:"und"},data:n}}}const dr={from:e=>({font:{normal:"'Hiragino Maru Gothic Pro', 'BIZ UDGothic', 'Yu Gothic Medium', sans-serif",...e?.font},replace:{half:!0,drcs:new Map,glyph:new Map,...e?.replace},color:{stroke:null,foreground:null,background:null,...e?.color},resize:{target:"container",objectFit:"contain",...e?.resize}})};class hr{option;canvas;constructor(e){this.option=dr.from(e),this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top=this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.width="100%",this.canvas.style.height="100%"}hide(){this.canvas.style.visibility="hidden"}show(){this.canvas.style.visibility="visible"}onAttach(e){e.appendChild(this.canvas)}onDetach(){this.canvas.remove()}onContainerResize(e,t){return"container"===this.option.resize.target&&(this.clear(),this.resize(e,t),!0)}onVideoResize(e,t){return"video"===this.option.resize.target&&(this.clear(),this.resize(e,t),!0)}onPlay(){}onPause(){}onSeeking(){this.clear()}}const ur=new Map([["０","0"],["１","1"],["２","2"],["３","3"],["４","4"],["５","5"],["６","6"],["７","7"],["８","8"],["９","9"],["ａ","a"],["ｂ","b"],["ｃ","c"],["ｄ","d"],["ｅ","e"],["ｆ","f"],["ｇ","g"],["ｈ","h"],["ｉ","i"],["ｊ","h"],["ｋ","k"],["ｌ","l"],["ｍ","m"],["ｎ","n"],["ｏ","o"],["ｐ","p"],["ｑ","q"],["ｒ","r"],["ｓ","s"],["ｔ","t"],["ｕ","u"],["ｖ","v"],["ｗ","w"],["ｘ","x"],["ｙ","y"],["ｚ","z"],["Ａ","A"],["Ｂ","B"],["Ｃ","C"],["Ｄ","D"],["Ｅ","E"],["Ｆ","F"],["Ｇ","G"],["Ｈ","H"],["Ｉ","I"],["Ｊ","J"],["Ｋ","K"],["Ｌ","L"],["Ｍ","M"],["Ｎ","N"],["Ｏ","O"],["Ｐ","P"],["Ｑ","Q"],["Ｒ","R"],["Ｓ","S"],["Ｔ","T"],["Ｕ","U"],["Ｖ","V"],["Ｗ","W"],["Ｘ","X"],["Ｙ","Y"],["Ｚ","Z"],["　"," "],["！","!"],["＂",'"'],["＃","#"],["＄","$"],["％","%"],["＆","&"],["＇","'"],["（","("],["）",")"],["＊","*"],["＋","+"],["，",","],["－","-"],["．","."],["／","/"],["：",":"],["；",";"],["＜","<"],["＝","="],["＞",">"],["？","?"],["＠","@"],["［","["],["＼","\\"],["］","]"],["＾","^"],["＿","_"],["｀","`"],["｛","{"],["｜","|"],["｝","}"],["～","~"],["ー","ｰ"],["、","､"],["。","｡"],["・","･"],["「","｢"],["」","｣"],["｟","⦅"],["｠","⦆"],["￠","¢"],["￡","£"],["￢","¬"],["￣","¯"],["￤","¦"],["￥","¥"],["￦","₩"],["│","￨"],["←","￩"],["↑","￪"],["→","￫"],["↓","￬"],["■","￭"],["○","￮"]]),fr=new Map([["black","#000000FF"],["silver","#C0C0C0FF"],["gray","#808080FF"],["white","#FFFFFFFF"],["maroon","#800000FF"],["red","#FF0000FF"],["purple","#800080FF"],["fuchsia","#FF00FFFF"],["green","#008000FF"],["lime","#00FF00FF"],["olive","#808000FF"],["yellow","#FFFF00FF"],["navy","#000080FF"],["blue","#0000FFFF"],["teal","#008080FF"],["aqua","#00FFFFFF"],["orange","#FFA500FF"],["aliceblue","#F0F8FFFF"],["antiquewhite","#FAEBD7FF"],["aquamarine","#7FFFD4FF"],["azure","#F0FFFFFF"],["beige","#F5F5DCFF"],["bisque","#FFE4C4FF"],["blanchedalmond","#FFEBCDFF"],["blueviolet","#8A2BE2FF"],["brown","#A52A2AFF"],["burlywood","#DEB887FF"],["cadetblue","#5F9EA0FF"],["chartreuse","#7FFF00FF"],["chocolate","#D2691EFF"],["coral","#FF7F50FF"],["cornflowerblue","#6495EDFF"],["cornsilk","#FFF8DCFF"],["crimson","#DC143CFF"],["cyan","#00FFFFFF"],["aqua","#00FFFFFF"],["darkblue","#00008BFF"],["darkcyan","#008B8BFF"],["darkgoldenrod","#B8860BFF"],["darkgray","#A9A9A9FF"],["darkgreen","#006400FF"],["darkgrey","#A9A9A9FF"],["darkkhaki","#BDB76BFF"],["darkmagenta","#8B008BFF"],["darkolivegreen","#556B2FFF"],["darkorange","#FF8C00FF"],["darkorchid","#9932CCFF"],["darkred","#8B0000FF"],["darksalmon","#E9967AFF"],["darkseagreen","#8FBC8FFF"],["darkslateblue","#483D8BFF"],["darkslategray","#2F4F4FFF"],["darkslategrey","#2F4F4FFF"],["darkturquoise","#00CED1FF"],["darkviolet","#9400D3FF"],["deeppink","#FF1493FF"],["deepskyblue","#00BFFFFF"],["dimgray","#696969FF"],["dimgrey","#696969FF"],["dodgerblue","#1E90FFFF"],["firebrick","#B22222FF"],["floralwhite","#FFFAF0FF"],["forestgreen","#228B22FF"],["gainsboro","#DCDCDCFF"],["ghostwhite","#F8F8FFFF"],["gold","#FFD700FF"],["goldenrod","#DAA520FF"],["greenyellow","#ADFF2FFF"],["grey","#808080FF"],["honeydew","#F0FFF0FF"],["hotpink","#FF69B4FF"],["indianred","#CD5C5CFF"],["indigo","#4B0082FF"],["ivory","#FFFFF0FF"],["khaki","#F0E68CFF"],["lavender","#E6E6FAFF"],["lavenderblush","#FFF0F5FF"],["lawngreen","#7CFC00FF"],["lemonchiffon","#FFFACDFF"],["lightblue","#ADD8E6FF"],["lightcoral","#F08080FF"],["lightcyan","#E0FFFFFF"],["lightgoldenrodyellow","#FAFAD2FF"],["lightgray","#D3D3D3FF"],["lightgreen","#90EE90FF"],["lightgrey","#D3D3D3FF"],["lightpink","#FFB6C1FF"],["lightsalmon","#FFA07AFF"],["lightseagreen","#20B2AAFF"],["lightskyblue","#87CEFAFF"],["lightslategray","#778899FF"],["lightslategrey","#778899FF"],["lightsteelblue","#B0C4DEFF"],["lightyellow","#FFFFE0FF"],["limegreen","#32CD32FF"],["linen","#FAF0E6FF"],["magenta","#FF00FFFF"],["fuchsia","#FF00FFFF"],["mediumaquamarine","#66CDAAFF"],["mediumblue","#0000CDFF"],["mediumorchid","#BA55D3FF"],["mediumpurple","#9370DBFF"],["mediumseagreen","#3CB371FF"],["mediumslateblue","#7B68EEFF"],["mediumspringgreen","#00FA9AFF"],["mediumturquoise","#48D1CCFF"],["mediumvioletred","#C71585FF"],["midnightblue","#191970FF"],["mintcream","#F5FFFAFF"],["mistyrose","#FFE4E1FF"],["moccasin","#FFE4B5FF"],["navajowhite","#FFDEADFF"],["oldlace","#FDF5E6FF"],["olivedrab","#6B8E23FF"],["orangered","#FF4500FF"],["orchid","#DA70D6FF"],["palegoldenrod","#EEE8AAFF"],["palegreen","#98FB98FF"],["paleturquoise","#AFEEEEFF"],["palevioletred","#DB7093FF"],["papayawhip","#FFEFD5FF"],["peachpuff","#FFDAB9FF"],["peru","#CD853FFF"],["pink","#FFC0CBFF"],["plum","#DDA0DDFF"],["powderblue","#B0E0E6FF"],["rosybrown","#BC8F8FFF"],["royalblue","#4169E1FF"],["saddlebrown","#8B4513FF"],["salmon","#FA8072FF"],["sandybrown","#F4A460FF"],["seagreen","#2E8B57FF"],["seashell","#FFF5EEFF"],["sienna","#A0522DFF"],["skyblue","#87CEEBFF"],["slateblue","#6A5ACDFF"],["slategray","#708090FF"],["slategrey","#708090FF"],["snow","#FFFAFAFF"],["springgreen","#00FF7FFF"],["steelblue","#4682B4FF"],["tan","#D2B48CFF"],["thistle","#D8BFD8FF"],["tomato","#FF6347FF"],["turquoise","#40E0D0FF"],["violet","#EE82EEFF"],["wheat","#F5DEB3FF"],["whitesmoke","#F5F5F5FF"],["yellowgreen","#9ACD32FF"],["rebeccapurple","#663399FF"],["transparent","#00000000"]]),pr=(e,t)=>"SBTVD"===t.association&&e===Re||e===Be,gr=new Set([]);for(let e=122;e<127;e++)for(let t=33;t<127;t++){const r=e<<8|t;if(!mt.has(r))continue;const i=mt.get(r);switch(i){case"年":case"月":case"日":case"円":break;default:gr.add(i)}}for(let e=122;e<127;e++)for(let t=33;t<127;t++){const r=e<<8|t;if(!bt.has(r))continue;const i=bt.get(r);switch(i){case"年":case"月":case"日":case"円":break;default:gr.add(i)}}const mr=e=>!!gr.has(e),br=(e,t,r,i,a,n)=>{const s=e.getContext("2d");if(null!=s)for(const o of i)switch(o.tag){case"Character":yr(s,o,t,r,a,n);break;case"DRCS":Cr(s,o,t,r,a,n);break;case"ClearScreen":0===o.time&&s.clearRect(0,0,e.width,e.height);break;case"Bitmap":break;default:throw new A(o,"Unexpected ARIB Parsed Token in CanvasRenderingStrategy")}},wr=(e,t,r,i,a)=>{const{state:n}=t;e.clearRect((n.margin[0]+(n.position[0]+0)-0)*r[0],(n.margin[1]+(n.position[1]+1)-We.box(n)[1])*r[1],We.box(n)[0]*r[0],We.box(n)[1]*r[1])},Fr=(e,t,r,i,a)=>{const{state:n}=t;e.fillStyle=a.color.background??Jt[n.background],e.fillRect((n.margin[0]+(n.position[0]+0)-0)*r[0],(n.margin[1]+(n.position[1]+1)-We.box(n)[1])*r[1],We.box(n)[0]*r[0],We.box(n)[1]*r[1])},Ar=(e,t,r,i,a)=>{const{state:n,option:s}=t,o=(n.margin[0]+(n.position[0]+0)+0)*r[0],c=(n.margin[1]+(n.position[1]+1)-We.box(n)[1])*r[1];e.translate(o,c),e.scale(r[0],r[1]),e.fillStyle=a.color.foreground??Jt[n.foreground],1&n.highlight&&e.fillRect(0,We.box(n)[1]-1*s.magnification,We.box(n)[0],1*s.magnification),2&n.highlight&&e.fillRect(We.box(n)[0]-1*s.magnification,0,1*s.magnification,We.box(n)[1]),4&n.highlight&&e.fillRect(0,0,We.box(n)[0],1*s.magnification),8&n.highlight&&e.fillRect(0,0,1*s.magnification,We.box(n)[1]),e.setTransform(1,0,0,1,0,0)},Ur=(e,t,r,i,a)=>{const{state:n,option:s}=t;if(!n.underline)return;const o=(n.margin[0]+(n.position[0]+0)+0)*r[0],c=(n.margin[1]+(n.position[1]+1)-We.box(n)[1])*r[1];e.translate(o,c),e.scale(r[0],r[1]),e.fillStyle=a.color.foreground??Jt[n.foreground],e.fillRect(0,We.box(n)[1]-1*s.magnification,We.box(n)[0],1*s.magnification),e.setTransform(1,0,0,1,0,0)},yr=(e,t,r,i,a,n)=>{const{state:s,option:o,character:c,non_spacing:l}=t,d=pr(s.size,a),h=n.replace.half&&d&&ur.has(c)?ur.get(c):c;l||(wr(e,t,i),Fr(e,t,i,0,n),Ar(e,t,i,0,n),Ur(e,t,i,0,n));const u=(null!=n.color.stroke?fr.get(n.color.stroke)??n.color.stroke:null)??(null!=s.ornament?Jt[s.ornament]:null),f=n.color.foreground??Jt[s.foreground];if(n.replace.glyph.has(h)){const t=Math.floor((s.margin[0]+(s.position[0]+0)+0+We.offset(s)[0])*i[0]),a=Math.floor((s.margin[1]+(s.position[1]+1)-We.box(s)[1]+We.offset(s)[1])*i[1]);e.translate(t,a);const{viewBox:c,path:l}=n.replace.glyph.get(h),d=new r(l),[p,g,m,b]=c,w=m-p,F=b-g;return e.scale(s.fontsize[0]/w,s.fontsize[1]/F),e.translate(p,g),null!==u&&u!==f&&(e.strokeStyle=u,e.lineJoin="round",e.lineWidth=4*Math.max(w/s.fontsize[0],F/s.fontsize[1])*o.magnification,e.stroke(d)),e.fillStyle=f,e.fill(d),void e.setTransform(1,0,0,1,0,0)}const p=Math.floor((s.margin[0]+(s.position[0]+0)+We.box(s)[0]/2)*i[0]),g=Math.floor((s.margin[1]+(s.position[1]+1)-We.box(s)[1]/2)*i[1]);e.translate(p,g);const m=mr(h)?n.font.arib??n.font.normal:n.font.normal;e.scale(1*i[0],We.scale(s)[1]*i[1]),null!==u&&u!==f&&(e.font=`${s.fontsize[0]}px ${m}`,e.strokeStyle=u,e.lineJoin="round",e.textBaseline="middle",e.textAlign="center",e.lineWidth=4*o.magnification,e.strokeText(h,0,0,s.fontsize[0]*We.scale(s)[0])),e.font=`${s.fontsize[0]}px ${m}`,e.fillStyle=f,e.textBaseline="middle",e.textAlign="center",e.fillText(h,0,0,s.fontsize[0]*We.scale(s)[0]),e.setTransform(1,0,0,1,0,0)},Cr=(e,t,r,i,a,n)=>{const{state:s}=t;wr(e,t,i),Fr(e,t,i,0,n),Ar(e,t,i,0,n),Ur(e,t,i,0,n);const o=(null!=n.color.stroke?fr.get(n.color.stroke)??n.color.stroke:null)??(null!=s.ornament?Jt[s.ornament]:null);n.color.foreground??s.foreground,((e,t,r,i,a,n)=>{const{state:s,option:o,width:c,height:l,depth:d,binary:h}=t,u=new Uint8Array(h),f=(s.margin[0]+s.position[0]+(0+We.offset(s)[0]))*i[0],p=(s.margin[1]+s.position[1]+(1-We.box(s)[1]+We.offset(s)[1]))*i[1];e.translate(f,p),e.scale(o.magnification*i[0],o.magnification*i[1]);let g="";for(let e=0;e<l;e++)for(let t=0;t<c;t++){let r=0;for(let i=0;i<d;i++){const a=7-((e*c+t)*d+i)%8;r*=2,r+=(u[Math.floor(((e*c+t)*d+i)/8)]&1<<a)>>a}0!==r&&(g+=(""===g?"":" ")+`M ${t} ${e} h 1 v 1 H ${t} Z`)}const m=new r(g);null!=n&&(e.strokeStyle=n,e.lineJoin="round",e.lineWidth=2*o.magnification,e.stroke(m)),e.fill(m),e.setTransform(1,0,0,1,0,0)})(e,t,r,i,0,o)},Sr=(e,t,r,i,a,n)=>{let s=[1,1];{const o=t.getContext("2d");if(null==o)return;const c=new jt(r),l=c.parse(i),{plane:[d,h]}=c.currentState();null!=e&&(s=[Math.ceil(e.width/d),Math.ceil(e.height/h)]),t.width===d&&t.height===h||(t.width=d,t.height=h,o.clearRect(0,0,t.width,t.height));for(const e of l)switch(e.tag){case"Character":yr(o,e,globalThis.Path2D,s,a,n);break;case"DRCS":Cr(o,e,globalThis.Path2D,s,a,n);break;case"Bitmap":kr(o,e,globalThis.Path2D,s,a,n);break;case"ClearScreen":0===e.time&&o.clearRect(0,0,t.width,t.height);break;default:throw new A(e,"Unhandled ARIB Parsed Token in CanvasRendererStrategy")}}if(null!=e){const r=e.getContext("2d");if(null==r)return;switch(r.clearRect(0,0,e.width,e.height),n.resize.objectFit){case"none":r.drawImage(t,0,0,e.width,e.height);break;default:{const i=e.width/(t.width/s[0]),a=e.height/(t.height/s[1]),n=Math.min(i,a),o=t.width*n/s[0],c=t.height*n/s[1],l=(e.width-o)/2,d=(e.height-c)/2;r.drawImage(t,0,0,t.width,t.height,l,d,o,c);break}}}},kr=(e,t,r,i,a,n)=>{const{x_position:s,y_position:o,width:c,height:l}=t;e.drawImage(t.normal_bitmap,s*i[0],o*i[1],c*i[0],l*i[1]),t.normal_bitmap.close(),t.flashing_bitmap?.close()};class vr extends hr{buffer;constructor(e){super(e),this.buffer=document.createElement("canvas")}resize(e,t){this.canvas.width=e,this.canvas.height=t}destroy(){this.resize(0,0),this.buffer.width=this.buffer.height=0}clear(){{const e=this.buffer.getContext("2d");if(null==e)return;e.clearRect(0,0,this.buffer.width,this.buffer.height)}{const e=this.canvas.getContext("2d");if(null==e)return;e.clearRect(0,0,this.canvas.width,this.canvas.height)}}render(e,t,r){Sr(this.canvas,this.buffer,e,Kt(t,this.option.replace.drcs),r,this.option)}getPresentationCanvas(){return this.canvas}}const Tr=(e,t)=>({type:"initialize",present:e,buffer:t}),Mr=()=>({type:"clear"}),_r=(e,t)=>({type:"resize",width:e,height:t}),Dr=(e,t,r,i)=>({type:"render",state:e,tokens:t,info:r,option:i}),Ir=e=>({type:"imagebitmap",bitmap:e??null});let Rr=null,Br=null;self.addEventListener("message",e=>{switch(e.data.type){case"initialize":Rr=e.data.present,Br=e.data.buffer;break;case"resize":{const{width:t,height:r}=e.data;if(null==Rr)break;Rr.width=t,Rr.height=r;break}case"terminate":null!=Rr&&(Rr.width=Rr.height=0,Rr=null),null!=Br&&(Br.width=Br.height=0,Br=null);break;case"clear":if(Rr){const e=Rr.getContext("2d");e&&e.clearRect(0,0,Rr.width,Rr.height)}if(Br){const e=Br.getContext("2d");e&&e.clearRect(0,0,Br.width,Br.height)}break;case"render":{if(null==Rr)break;if(null==Br)break;const{state:t,tokens:r,info:i,option:a}=e.data;Sr(Rr,Br,t,r,i,a);break}case"imagebitmap":if(null==Rr)break;createImageBitmap(Rr).then(e=>{self.postMessage(Ir(e))});break;default:throw new A(e.data,"Exhaustive check failed in CanvasRenderingWorker")}});class xr extends hr{buffer;present;worker;waitPromise=null;waitResolve=()=>{};constructor(e){super(e),this.present=this.canvas.transferControlToOffscreen(),this.buffer=new OffscreenCanvas(0,0),this.worker=new r.default,this.worker.postMessage(Tr(this.present,this.buffer),[this.present,this.buffer])}resize(e,t){this.worker.postMessage(_r(e,t))}destroy(){this.worker.postMessage(_r(0,0)),this.worker.terminate()}clear(){this.worker.postMessage(Mr())}render(e,t,r){this.worker.postMessage(Dr(e,Kt(t,this.option.replace.drcs),r,this.option))}async getPresentationImageBitmap(){for(;null!=this.waitPromise&&(await this.waitPromise,null!=this.waitPromise););return this.waitPromise=new Promise(e=>{this.waitResolve=()=>{this.waitPromise=null,this.waitResolve=()=>{},e()}}),this.worker.postMessage(Ir()),new Promise(e=>{this.worker.addEventListener("message",t=>{if("imagebitmap"===t.data.type)return e(t.data.bitmap),void this.waitResolve()},{once:!0})})}}const Er=e=>"SBTVD"===e.association,Nr=e=>"SBTVD"===e.association,Lr=(e,t)=>"ARIB"===t.association&&"jpn"===t.language&&e===Re,$r={from:e=>({font:{normal:"'Hiragino Maru Gothic Pro', 'BIZ UDGothic', 'Yu Gothic Medium', sans-serif",arib:"'Hiragino Maru Gothic Pro', 'BIZ UDGothic', 'Yu Gothic Medium', sans-serif",...e?.font},replace:{half:!0,drcs:new Map,glyph:new Map,...e?.replace},color:{stroke:null,foreground:null,background:null,...e?.color},animation:{pause:!0,...e?.animation}})},Pr=(e,t,r={},i=[])=>({name:t,xmlns:e,attributes:r,children:i}),zr=(e,t,r,i)=>{const a=Pr("http://www.w3.org/2000/svg","svg"),n=Pr("http://www.w3.org/2000/svg","svg"),s=[],o=[],c=new Map;for(const i of e)switch(a.attributes.viewBox=`0 0 ${i.state.plane[0]} ${i.state.plane[1]}`,n.attributes.viewBox=`0 0 ${i.state.area[0]} ${i.state.area[1]}`,n.attributes.x=`${i.state.margin[0]}`,n.attributes.y=`${i.state.margin[1]}`,n.attributes.width=`${i.state.area[0]}`,n.attributes.height=`${i.state.area[1]}`,i.tag){case"Character":{if(!i.non_spacing){const[e,a]=Gr(i,t,r);c.set(e,`${c.get(e)??""}${c.has(e)?" ":""}${a}`)}const e=Pr("http://www.w3.org/2000/svg","g");e.children.push(Vr(i,t,r)),e.children.push(Or(i,t,r));const a=Hr(i,t,r);a&&e.children.push(a),s.push(e);break}case"DRCS":{const[e,a]=Gr(i,t,r);c.set(e,`${c.get(e)??""}${c.has(e)?" ":""}${a}`);const n=Pr("http://www.w3.org/2000/svg","g");for(const e of jr(i,t,r))n.children.push(e);n.children.push(Or(i,t,r));const o=Hr(i,t,r);o&&n.children.push(o),s.push(n);break}case"Bitmap":{const{width:e,height:t,normal_dataurl:r,flashing_dataurl:a}=Je.toDataURL(i,Jt);{const a=Pr("http://www.w3.org/2000/svg","image");a.attributes.href=r,a.attributes.x=`${i.x_position}`,a.attributes.y=`${i.y_position}`,a.attributes.width=`${e}`,a.attributes.height=`${t}`,o.push(a)}if(null!=a){const r=Pr("http://www.w3.org/2000/svg","image");r.attributes.href=a,r.attributes.x=`${i.x_position}`,r.attributes.y=`${i.y_position}`,r.attributes.width=`${e}`,r.attributes.height=`${t}`;const n=Pr("http://www.w3.org/2000/svg","animate");n.attributes.attributeName="opacity",n.attributes.values="1;0",n.attributes.dur="1s",n.attributes.calcMode="discrete",n.attributes.repeatCount="indefinite",r.children.push(n),o.push(r)}break}case"ClearScreen":if(0===i.time){n.children=[];break}break;default:throw new A(i,"Unexpected ARIB Parsed Token in SVGRenderingStrategy")}for(const[e,t]of c.entries()){const r=Pr("http://www.w3.org/2000/svg","path");r.attributes["shape-rendering"]="crispEdges",r.attributes.d=t,r.attributes.fill=e,n.children.push(r)}return n.children.push(...s),n.children.push(...o),i?(a.children.push(n),a):n},Or=(e,t,r)=>{const{state:i,option:a}=e,n=r.color.foreground??Jt[i.foreground],s=i.position[0]+0+0,o=i.position[1]+1-We.box(i)[1];let c="";1&i.highlight&&(c+=(""===c?"":" ")+`M ${s} ${o+We.box(i)[1]-1*a.magnification} h ${We.box(i)[0]} v ${a.magnification} H ${s} Z`),2&i.highlight&&(c+=(""===c?"":" ")+`M ${s+We.box(i)[0]-1*a.magnification} ${o} h ${a.magnification} v ${We.box(i)[1]} H ${s+We.box(i)[0]-1*a.magnification} Z`),4&i.highlight&&(c+=(""===c?"":" ")+`M ${s} ${o} h ${We.box(i)[0]} v ${a.magnification} H ${s} Z`),8&i.highlight&&(c+=(""===c?"":" ")+`M ${s} ${o} h ${a.magnification} v ${We.box(i)[1]} H ${s} Z`),i.underline&&(c+=(""===c?"":" ")+`M ${s} ${o+We.box(i)[1]-1*a.magnification} h ${We.box(i)[0]} v ${a.magnification} H ${s} Z`);const l=Pr("http://www.w3.org/2000/svg","path");return l.attributes["shape-rendering"]="crispEdges",""!==c&&(l.attributes.d=c),l.attributes.fill=n,l},Hr=(e,t,r)=>{const{state:i}=e;switch(i.flashing){case 79:return null;case 64:case 71:{const e=Pr("http://www.w3.org/2000/svg","animate");return e.attributes.attributeName="opacity",e.attributes.values=64===i.flashing?"1;0":"0;1",e.attributes.dur="1s",e.attributes.calcMode="discrete",e.attributes.repeatCount="indefinite",e}default:throw new A(i.flashing,"Unhandled Flasing Token in SVGDOMRenderingStrategy")}},Gr=(e,t,r)=>{const{state:i}=e,a=r.color.background??Jt[i.background],n=Math.floor(i.position[0]+0+0);return[a,`M ${n} ${Math.floor(i.position[1]+1-We.box(i)[1])} h ${We.box(i)[0]} v ${We.box(i)[1]} H ${n} Z`]},Vr=(e,t,r)=>{const{state:i,option:a,character:n}=e,s=pr(i.size,t),o=r.replace.half&&s,c=ur.has(n),l=o&&c?ur.get(n):n,d=Math.floor(i.position[0]+0+We.box(i)[0]/2),h=Math.floor(i.position[1]+1-We.box(i)[1]/2),u=We.scale(i)[0],f=We.scale(i)[1],p=(null!=r.color.stroke?fr.get(r.color.stroke)??r.color.stroke:null)??(null!=i.ornament?Jt[i.ornament]:null),g=r.color.foreground??Jt[i.foreground],m=Pr("http://www.w3.org/2000/svg","text");return m.attributes.x=`${d}`,m.attributes.y=`${h}`,m.attributes.transform=`scale(1 ${f})`,m.attributes["transform-origin"]=`${d} ${h}`,m.attributes["font-size"]=`${i.fontsize[0]}`,m.attributes["font-family"]=mr(l)?r.font.arib??r.font.normal:r.font.normal,m.attributes["dominant-baseline"]="central",m.attributes["text-anchor"]="middle",m.attributes.fill=g,m.attributes["paint-order"]="stroke",m.attributes["stroke-linejoin"]="round",m.attributes["stroke-width"]=null!=p?""+4*a.magnification:"0",m.attributes.stroke=null!=p?p:"transparent",m.attributes["data-width"]=""+i.fontsize[0]*u,m.attributes.textLength=""+i.fontsize[0]*u,m.attributes.lengthAdjust="spacingAndGlyphs",m.children.push(l),m},jr=(e,t,r)=>{const{state:i,option:a,width:n,height:s,depth:o,binary:c}=e,l=new Uint8Array(c),d=(null!=r.color.stroke?fr.get(r.color.stroke)??r.color.stroke:null)??(null!=i.ornament?Jt[i.ornament]:null),h=r.color.foreground??Jt[i.foreground],u=i.position[0]+(0+We.offset(i)[0]),f=i.position[1]+(1-We.box(i)[1]+We.offset(i)[1]);let p="";for(let e=0;e<s;e++)for(let t=0;t<n;t++){const r=u+t*a.magnification,i=f+e*a.magnification;let s=0;for(let r=0;r<o;r++){const i=7-((e*n+t)*o+r)%8;s*=2,s+=(l[Math.floor(((e*n+t)*o+r)/8)]&1<<i)>>i}0!==s&&(p+=(""===p?"":" ")+`M ${r} ${i} h ${a.magnification} v ${a.magnification} H ${r} Z`)}const g=Pr("http://www.w3.org/2000/svg","path"),m=Pr("http://www.w3.org/2000/svg","path");return g.attributes["shape-rendering"]="crispEdges",m.attributes["shape-rendering"]="crispEdges",g.attributes.d=p,m.attributes.d=p,g.attributes.stroke=d??"transparent",m.attributes.stroke="transparent",g.attributes.fill="transparent",m.attributes.fill=h,g.attributes["stroke-width"]=null!=d?""+4*a.magnification:"0",g.attributes["stroke-linejoin"]="round",[g,m]},Kr=e=>{if("string"==typeof e)return document.createTextNode(e);const t=document.createElementNS(e.xmlns,e.name);for(const[r,i]of Object.entries(e.attributes))t.setAttribute(r,i);for(const r of e.children)t.appendChild(Kr(r));return t};class Jr{option;svg;constructor(e){this.option=$r.from(e),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.style.position="absolute",this.svg.style.top=this.svg.style.left="0",this.svg.style.pointerEvents="none",this.svg.style.width="100%",this.svg.style.height="100%"}resize(e,t){}destroy(){this.clear()}clear(){for(;this.svg.firstChild;)this.svg.removeChild(this.svg.firstChild)}hide(){this.svg.style.visibility="hidden"}show(){this.svg.style.visibility="visible"}render(e,t,r){Nr(r)&&this.clear(),((e,t,r,i,a)=>{const n=new jt(t),s=n.parse(r),o=s.filter(e=>"Bitmap"!==e.tag),c=s.filter(e=>"Bitmap"===e.tag),l=s.find(e=>"ClearScreen"===e.tag);if(l&&0===l.time)for(;null!=e.lastChild;)e.removeChild(e.lastChild);const d=zr(o,i,a);for(const e of c){{const t=Pr("http://www.w3.org/2000/svg","image");t.attributes.href=e.normal_dataurl,t.attributes.x=`${e.x_position}`,t.attributes.y=`${e.y_position}`,t.attributes.width=`${e.width}`,t.attributes.height=`${e.height}`,d.children.push(t)}if(null!=e.flashing_dataurl){const t=Pr("http://www.w3.org/2000/svg","image");t.attributes.href=e.flashing_dataurl,t.attributes.x=`${e.x_position}`,t.attributes.y=`${e.y_position}`,t.attributes.width=`${e.width}`,t.attributes.height=`${e.height}`;const r=Pr("http://www.w3.org/2000/svg","animate");r.attributes.attributeName="opacity",r.attributes.values="1;0",r.attributes.dur="1s",r.attributes.calcMode="discrete",r.attributes.repeatCount="indefinite",t.children.push(r),d.children.push(t)}}const h=Kr(d);h.style.visibility="hidden",e.setAttribute("viewBox",`0 0 ${n.currentState().plane[0]} ${n.currentState().plane[1]}`),e.appendChild(h);for(const t of Array.from(e.getElementsByTagNameNS("http://www.w3.org/2000/svg","text"))){const e=t.getComputedTextLength();t.setAttribute("textLength",`${Math.min(e,Number.parseInt(t.dataset.width,10))}`),delete t.dataset.width,t.setAttribute("lengthAdjust","spacingAndGlyphs")}for(const t of Array.from(e.getElementsByTagNameNS("http://www.w3.org/2000/svg","animate")))t.beginElement();h.style.visibility="visible"})(this.svg,e,Kt(t,this.option.replace.drcs),r,this.option)}onAttach(e){e.appendChild(this.svg)}onDetach(){this.svg.remove()}onContainerResize(e,t){return!1}onVideoResize(e,t){return!1}onPlay(){this.option.animation.pause&&this.svg.unpauseAnimations()}onPause(){this.option.animation.pause&&this.svg.pauseAnimations()}onSeeking(){this.clear()}getPresentationSVGElement(){return this.svg}}const Wr=e=>({replace:{half:!0,drcs:new Map,...e?.replace}}),Xr=structuredClone(ur);Xr.set("ア","ｱ"),Xr.set("イ","ｲ"),Xr.set("ウ","ｳ"),Xr.set("エ","ｴ"),Xr.set("オ","ｵ"),Xr.set("カ","ｶ"),Xr.set("キ","ｷ"),Xr.set("ク","ｸ"),Xr.set("ケ","ｹ"),Xr.set("コ","ｺ"),Xr.set("サ","ｻ"),Xr.set("シ","ｼ"),Xr.set("ス","ｽ"),Xr.set("セ","ｾ"),Xr.set("ソ","ｿ"),Xr.set("タ","ﾀ"),Xr.set("チ","ﾁ"),Xr.set("ツ","ﾂ"),Xr.set("テ","ﾃ"),Xr.set("ト","ﾄ"),Xr.set("ナ","ﾅ"),Xr.set("ニ","ﾆ"),Xr.set("ヌ","ﾇ"),Xr.set("ネ","ﾈ"),Xr.set("ノ","ﾉ"),Xr.set("ハ","ﾊ"),Xr.set("ヒ","ﾋ"),Xr.set("フ","ﾌ"),Xr.set("ヘ","ﾍ"),Xr.set("ホ","ﾎ"),Xr.set("マ","ﾏ"),Xr.set("ミ","ﾐ"),Xr.set("ム","ﾑ"),Xr.set("メ","ﾒ"),Xr.set("モ","ﾓ"),Xr.set("ヤ","ﾔ"),Xr.set("ユ","ﾕ"),Xr.set("ヨ","ﾖ"),Xr.set("ラ","ﾗ"),Xr.set("リ","ﾘ"),Xr.set("ル","ﾙ"),Xr.set("レ","ﾚ"),Xr.set("ロ","ﾛ"),Xr.set("ワ","ﾜ"),Xr.set("ヲ","ｦ"),Xr.set("ン","ﾝ"),Xr.set("ヴ","ｳﾞ"),Xr.set("ガ","ｶﾞ"),Xr.set("ギ","ｷﾞ"),Xr.set("グ","ｸﾞ"),Xr.set("ゲ","ｹﾞ"),Xr.set("ゴ","ｺﾞ"),Xr.set("ザ","ｻﾞ"),Xr.set("ジ","ｼﾞ"),Xr.set("ズ","ｽﾞ"),Xr.set("ゼ","ｾﾞ"),Xr.set("ゾ","ｿﾞ"),Xr.set("ダ","ﾀﾞ"),Xr.set("ヂ","ﾁﾞ"),Xr.set("ヅ","ﾂﾞ"),Xr.set("デ","ﾃﾞ"),Xr.set("ド","ﾄﾞ"),Xr.set("バ","ﾊﾞ"),Xr.set("ビ","ﾋﾞ"),Xr.set("ブ","ﾌﾞ"),Xr.set("ベ","ﾍﾞ"),Xr.set("ボ","ﾎﾞ"),Xr.set("パ","ﾊﾟ"),Xr.set("ピ","ﾋﾟ"),Xr.set("プ","ﾌﾟ"),Xr.set("ペ","ﾍﾟ"),Xr.set("ポ","ﾎﾟ"),Xr.set("ァ","ｧ"),Xr.set("ィ","ｨ"),Xr.set("ゥ","ｩ"),Xr.set("ェ","ｪ"),Xr.set("ォ","ｫ"),Xr.set("ャ","ｬ"),Xr.set("ュ","ｭ"),Xr.set("ョ","ｮ"),Xr.set("ッ","ｯ"),Xr.set("◌゙"," ﾞ"),Xr.set("◌゚"," ﾟ");const Yr=Xr;class qr{option;text=null;constructor(e){this.option=Wr(e)}resize(e,t){}destroy(){this.text=null}clear(){this.text=null}hide(){}show(){}render(e,t,r){Nr(r)&&(this.text="");let i=null;const a=new jt(e);for(const e of a.parse(Kt(t,this.option.replace.drcs)))switch(e.tag){case"Character":{const{state:t,character:a}=e;if(null==this.text)break;if((" "===a||"　"===a)&&8===t.background&&Er(r))break;if(Lr(t.size,r))break;null!=i&&t.position[1]!==i&&(this.text+="\n"),i=t.position[1],this.option.replace.half&&pr(t.size,r)?this.text+=Yr.get(a):this.text+=a;break}case"DRCS":{const{state:t}=e;if(null==this.text)break;null!=i&&t.position[1]!==i&&(this.text+="\n"),i=t.position[1],this.text+="〓";break}case"Bitmap":e.normal_bitmap.close(),e.flashing_bitmap?.close();break;case"ClearScreen":0===e.time&&(this.text="");break;default:throw new A(e,"Unexpected ARIB Parsed Token in TextRenderer")}}onAttach(e){}onDetach(){}onContainerResize(e,t){return!1}onVideoResize(e,t){return!1}onPlay(){}onPause(){}onSeeking(){this.clear()}}const Zr=e=>({replace:{drcs:new Map,...e?.replace},color:{foreground:!0,background:null,stroke:!1,...e?.color}}),Qr=(e,t,r)=>{switch(e.tag){case"Character":{const i=document.createElement("div");return i.style.display="inline-block",i.style.whiteSpace="pre",r.color.foreground&&(i.style.color=Jt[e.state.foreground]),r.color.stroke&&(i.style.webkitTextStroke="0.1em black",i.style.paintOrder="stroke fill"),i.textContent=pr(e.state.size,t)&&Yr.get(e.character)||e.character,i}case"DRCS":{const t=document.createElementNS("http://www.w3.org/2000/svg","svg"),{state:i,width:a,height:n,depth:s,binary:o}=e,c=new Uint8Array(o),l=Jt[i.foreground];let d="";for(let e=0;e<n;e++)for(let t=0;t<a;t++){let r=0;for(let i=0;i<s;i++){const n=7-((e*a+t)*s+i)%8;r*=2,r+=(c[Math.floor(((e*a+t)*s+i)/8)]&1<<n)>>n}0!==r&&(d+=(""===d?"":" ")+`M ${t} ${e} h 1 v 1 H ${t} Z`)}const h=document.createElementNS("http://www.w3.org/2000/svg","path");if(r.color.stroke){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d",d),e.setAttribute("stroke","black"),e.setAttribute("fill","transparent"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-linejoin","round"),t.appendChild(e)}return h.setAttribute("shape-rendering","crispEdges"),h.setAttribute("d",d),h.setAttribute("stroke","transparent"),h.setAttribute("fill",l),t.appendChild(h),t.setAttribute("viewBox",`0 0 ${a} ${n}`),t.style.width="1em",t.style.verticalAlign="middle",t}case"Script":const i=document.createElement("div");return i.style.display="inline-flex",i.style.fontSize="0.5em",i.style.flexDirection="column",i.style.verticalAlign="top",i.appendChild(Qr(e.sup,t,r)),i.appendChild(Qr(e.sub,t,r)),i}};class ei{option;element;constructor(e){this.option=Zr(e),this.element=document.createElement("div")}resize(e,t){}destroy(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild)}clear(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild)}hide(){this.element.style.visibility="hidden"}show(){this.element.style.visibility="showing"}render(e,t,r){Nr(r)&&this.clear();const i=new jt(e),a=new DocumentFragment,n=((e,t,r)=>Ot(e.filter(e=>"Bitmap"!==e.tag||(e.normal_bitmap.close(),e.flashing_bitmap?.close(),!1)),t,r))(i.parse(Kt(t,this.option.replace.drcs)),r,zt).map(e=>{const t=document.createElement("div");t.style.display="inline-block",e.highlight&&(t.style.border="1px solid white");for(const i of e.spans){const e=document.createElement("div");switch(e.style.display="inline-block",i.tag){case"Normal":for(const t of i.text)e.appendChild(Qr(t,r,this.option));break;case"Ruby":{const t=document.createElement("span");for(const e of i.ruby)t.appendChild(Qr(e,r,this.option));const a=document.createElement("rt");a.append(t);const n=document.createElement("span");for(const e of i.text)n.appendChild(Qr(e,r,this.option));const s=document.createElement("ruby");s.appendChild(n),s.appendChild(a),e.appendChild(s);break}default:throw new A(i,"Undefined Region Type in HTMLFragmentRenderer")}t.appendChild(e)}return t});for(const e of n.slice(0,-1))e.style.marginRight="0.5em";for(const e of n)a.appendChild(e);this.clear(),this.element.appendChild(a)}onAttach(e){}onDetach(){}onContainerResize(e,t){return!1}onVideoResize(e,t){return!1}onPlay(){}onPause(){}onSeeking(){this.clear()}getPresentationElement(){return this.element}}const ti=(e,...t)=>{const r=[e];let i=32;for(let e of t.toReversed()){r.unshift(i);do{r.unshift(48|e%10),e=Math.floor(e/10)}while(0!==e);i=59}return r.unshift(155),Uint8Array.from(r).buffer};class ri{encodeTokenHandler=this.encodeToken.bind(this);encodeToken(e){switch(e.tag){case"Character":return this.encodeCharacter(e);case"DRCS":return this.encodeDRCS(e);case"Bitmap":return this.encodeBitmap(e);case"Mosaic":return this.encodeMosaic(e);default:return this.encodeControl(e)}}encodeControl(e){switch(e.tag){case"Null":return Uint8Array.from([0]).buffer;case"Bell":return Uint8Array.from([7]).buffer;case"ActivePositionBackward":return Uint8Array.from([8]).buffer;case"ActivePositionForward":return Uint8Array.from([9]).buffer;case"ActivePositionDown":return Uint8Array.from([10]).buffer;case"ActivePositionUp":return Uint8Array.from([11]).buffer;case"ClearScreen":return Uint8Array.from([12]).buffer;case"ActivePositionReturn":return Uint8Array.from([13]).buffer;case"ParameterizedActivePositionForward":return Uint8Array.from([22,64|e.x]).buffer;case"Cancel":return Uint8Array.from([24]).buffer;case"ActivePositionSet":return Uint8Array.from([28,64|e.y,64|e.x]).buffer;case"RecordSeparator":return Uint8Array.from([30]).buffer;case"UnitSeparator":return Uint8Array.from([31]).buffer;case"Space":return Uint8Array.from([32]).buffer;case"Delete":return Uint8Array.from([ot]).buffer;case"BlackForeground":return Uint8Array.from([128]).buffer;case"RedForeground":return Uint8Array.from([129]).buffer;case"GreenForeground":return Uint8Array.from([130]).buffer;case"YellowForeground":return Uint8Array.from([131]).buffer;case"BlueForeground":return Uint8Array.from([132]).buffer;case"MagentaForeground":return Uint8Array.from([133]).buffer;case"CyanForeground":return Uint8Array.from([134]).buffer;case"WhiteForeground":return Uint8Array.from([135]).buffer;case"SmallSize":return Uint8Array.from([136]).buffer;case"MiddleSize":return Uint8Array.from([137]).buffer;case"NormalSize":return Uint8Array.from([138]).buffer;case"CharacterSizeControl":return Uint8Array.from([139,e.type]).buffer;case"ColorControlForeground":return Uint8Array.from([ct,64|e.color]).buffer;case"ColorControlBackground":return Uint8Array.from([ct,80|e.color]).buffer;case"ColorControlHalfForeground":return Uint8Array.from([ct,96|e.color]).buffer;case"ColorControlHalfBackground":return Uint8Array.from([ct,112|e.color]).buffer;case"PalletControl":return Uint8Array.from([ct,32,64|e.pallet]).buffer;case"FlashingControl":return Uint8Array.from([145,e.type]).buffer;case"ConcealmentMode":case"SingleConcealmentMode":return Uint8Array.from([146,e.type]).buffer;case"ReplacingConcealmentMode":return Uint8Array.from([146,32,e.type]).buffer;case"PatternPolarityControl":return Uint8Array.from([147,e.type]).buffer;case"WritingModeModification":return Uint8Array.from([148,e.type]).buffer;case"HilightingCharacterBlock":return Uint8Array.from([151,64|e.enclosure]).buffer;case"RepeatCharacter":return Uint8Array.from([152,64|e.repeat]).buffer;case"StartLining":return Uint8Array.from([154]).buffer;case"StopLining":return Uint8Array.from([153]).buffer;case"TimeControlWait":return Uint8Array.from([157,32,64|10*e.seconds]).buffer;case"TimeControlMode":return Uint8Array.from([157,40,e.type]).buffer;case"SetWritingFormat":return ti(83,e.format);case"SetDisplayFormat":return ti(86,e.horizontal,e.vertical);case"SetDisplayPosition":return ti(95,e.horizontal,e.vertical);case"CharacterCompositionDotDesignation":return ti(87,e.horizontal,e.vertical);case"SetHorizontalSpacing":return ti(88,e.spacing);case"SetVerticalSpacing":return ti(89,e.spacing);case"ActiveCoordinatePositionSet":return ti(97,e.x,e.y);case"RasterColourCommand":return ti(110,e.color);case"OrnamentControlNone":return ti(99,0);case"OrnamentControlHemming":return ti(99,1,e.color);case"OrnamentControlShade":return ti(99,2,e.color);case"OrnamentControlHollow":return ti(99,3);case"BuiltinSoundReplay":return ti(104,e.sound);default:throw new A(e,"Unexpeced ARIBB24Token in encodeControl)")}}}const ii=(...e)=>{if(!e)return new ArrayBuffer(0);const t=e.reduce((e,t)=>e+t.byteLength,0),r=new Uint8Array(t);for(let t=0,i=0;t<e.length;i+=e[t].byteLength,t++)r.set(new Uint8Array(e[t]),i);return r.buffer};class ai extends ri{current_drcs_code=60416;drcs_units=[];drcs_md5_to_code=new Map;encoder=new TextEncoder;encodeCharacter({character:e}){return this.encoder.encode(e).buffer}encode(e){const t=ii(...e.map(this.encodeTokenHandler));return[...this.drcs_units,It(t)]}encodeControl(e){switch(e.tag){case"Null":case"Bell":case"ActivePositionBackward":case"ActivePositionForward":case"ActivePositionDown":case"ActivePositionUp":case"ClearScreen":case"ActivePositionReturn":case"ParameterizedActivePositionForward":case"Cancel":case"ActivePositionSet":case"RecordSeparator":case"UnitSeparator":case"Space":case"Delete":return super.encodeControl(e);default:return ii(Uint8Array.from([194]).buffer,super.encodeControl(e))}}encodeDRCS(e){const t=nt(e.binary);if(!this.drcs_md5_to_code.has(t)){if(this.current_drcs_code>63743)return this.encoder.encode("〓");const r=Uint8Array.from([1,(65280&this.current_drcs_code)>>8,255&this.current_drcs_code,1,0,2**e.depth-2,e.width,e.width]).buffer;this.drcs_units.push(Rt(ii(r,e.binary),2)),this.drcs_md5_to_code.set(t,this.current_drcs_code),this.current_drcs_code++}const r=this.drcs_md5_to_code.get(t);return""===e.combining?this.encoder.encode(String.fromCodePoint(r)).buffer:ii(this.encoder.encode(String.fromCodePoint(r)).buffer,this.encodeCharacter(k(e.combining)))}encodeBitmap(e){throw new m("Bitmap is Not Implemented")}encodeMosaic(e){throw new m("Mozaic Character is Not Implemented")}}const ni=new Map([["０","0"],["１","1"],["２","2"],["３","3"],["４","4"],["５","5"],["６","6"],["７","7"],["８","8"],["９","9"],["ａ","a"],["ｂ","b"],["ｃ","c"],["ｄ","d"],["ｅ","e"],["ｆ","f"],["ｇ","g"],["ｈ","h"],["ｉ","i"],["ｊ","h"],["ｋ","k"],["ｌ","l"],["ｍ","m"],["ｎ","n"],["ｏ","o"],["ｐ","p"],["ｑ","q"],["ｒ","r"],["ｓ","s"],["ｔ","t"],["ｕ","u"],["ｖ","v"],["ｗ","w"],["ｘ","x"],["ｙ","y"],["ｚ","z"],["Ａ","A"],["Ｂ","B"],["Ｃ","C"],["Ｄ","D"],["Ｅ","E"],["Ｆ","F"],["Ｇ","G"],["Ｈ","H"],["Ｉ","I"],["Ｊ","J"],["Ｋ","K"],["Ｌ","L"],["Ｍ","M"],["Ｎ","N"],["Ｏ","O"],["Ｐ","P"],["Ｑ","Q"],["Ｒ","R"],["Ｓ","S"],["Ｔ","T"],["Ｕ","U"],["Ｖ","V"],["Ｗ","W"],["Ｘ","X"],["Ｙ","Y"],["Ｚ","Z"],["　"," "],["！","!"],["＂",'"'],["＃","#"],["＄","$"],["％","%"],["＆","&"],["＇","'"],["（","("],["）",")"],["＊","*"],["＋","+"],["，",","],["－","-"],["．","."],["／","/"],["：",":"],["；",";"],["＜","<"],["＝","="],["＞",">"],["？","?"],["＠","@"],["［","["],["＼","\\"],["］","]"],["＾","^"],["＿","_"],["｀","`"],["｛","{"],["｜","|"],["｝","}"],["～","~"],["ー","ｰ"],["、","､"],["。","｡"],["・","･"],["「","｢"],["」","｣"],["｟","⦅"],["｠","⦆"],["￠","¢"],["￡","£"],["￢","¬"],["￣","¯"],["￤","¦"],["￥","¥"],["￦","₩"],["│","￨"],["←","￩"],["↑","￪"],["→","￫"],["↓","￬"],["■","￭"],["○","￮"],["ア","ｱ"],["イ","ｲ"],["ウ","ｳ"],["エ","ｴ"],["オ","ｵ"],["カ","ｶ"],["キ","ｷ"],["ク","ｸ"],["ケ","ｹ"],["コ","ｺ"],["サ","ｻ"],["シ","ｼ"],["ス","ｽ"],["セ","ｾ"],["ソ","ｿ"],["タ","ﾀ"],["チ","ﾁ"],["ツ","ﾂ"],["テ","ﾃ"],["ト","ﾄ"],["ナ","ﾅ"],["ニ","ﾆ"],["ヌ","ﾇ"],["ネ","ﾈ"],["ノ","ﾉ"],["ハ","ﾊ"],["ヒ","ﾋ"],["フ","ﾌ"],["ヘ","ﾍ"],["ホ","ﾎ"],["マ","ﾏ"],["ミ","ﾐ"],["ム","ﾑ"],["メ","ﾒ"],["モ","ﾓ"],["ヤ","ﾔ"],["ユ","ﾕ"],["ヨ","ﾖ"],["ラ","ﾗ"],["リ","ﾘ"],["ル","ﾙ"],["レ","ﾚ"],["ロ","ﾛ"],["ワ","ﾜ"],["ヲ","ｦ"],["ン","ﾝ"],["ヴ","ｳﾞ"],["ガ","ｶﾞ"],["ギ","ｷﾞ"],["グ","ｸﾞ"],["ゲ","ｹﾞ"],["ゴ","ｺﾞ"],["ザ","ｻﾞ"],["ジ","ｼﾞ"],["ズ","ｽﾞ"],["ゼ","ｾﾞ"],["ゾ","ｿﾞ"],["ダ","ﾀﾞ"],["ヂ","ﾁﾞ"],["ヅ","ﾂﾞ"],["デ","ﾃﾞ"],["ド","ﾄﾞ"],["バ","ﾊﾞ"],["ビ","ﾋﾞ"],["ブ","ﾌﾞ"],["ベ","ﾍﾞ"],["ボ","ﾎﾞ"],["パ","ﾊﾟ"],["ピ","ﾋﾟ"],["プ","ﾌﾟ"],["ペ","ﾍﾟ"],["ポ","ﾎﾟ"],["ァ","ｧ"],["ィ","ｨ"],["ゥ","ｩ"],["ェ","ｪ"],["ォ","ｫ"],["ャ","ｬ"],["ュ","ｭ"],["ョ","ｮ"],["ッ","ｯ"]]),si=new Map([...Array.from(pt.entries()).map(([e,t])=>[t,[e]]),...Array.from(pt.entries()).filter(([e,t])=>ni.has(t)).map(([e,t])=>[ni.get(t),[e]])]),oi=new Map([...Array.from(qe.entries()).map(([e,t])=>[t,[e]]),...Array.from(qe.entries()).filter(([e,t])=>ni.has(t)).map(([e,t])=>[ni.get(t),[e]])]),ci=new Map([...Array.from(gt.entries()).map(([e,t])=>[t,[e]]),...Array.from(gt.entries()).filter(([e,t])=>ni.has(t)).map(([e,t])=>[ni.get(t),[e]])]),li=new Map([...Array.from(mt.entries()).map(([e,t])=>[t,[(65280&e)>>8,255&e]]),...Array.from(bt.entries()).map(([e,t])=>[t,[(65280&e)>>8,255&e]])]);class di extends ri{static KANJI=new Map;static ASCII=structuredClone(oi);static HIRAGANA=structuredClone(si);static KATAKANA=structuredClone(ci);static{const e=new TextDecoder("euc-jp",{fatal:!0});for(let t=33;t<117;t++)for(let r=33;r<127;r++)try{const i=e.decode(Uint8Array.from([128|t,128|r]));di.KANJI.set(i,[t,r])}catch(e){}for(const[e,t]of li.entries())di.KANJI.set(e,t)}mode="MACRO0";drcs_md5_to_code=new Map;current_drcs_code=[33,33];drcs_units=[];encode(e){const t=ii(Uint8Array.from([st,ut]).buffer,...e.map(this.encodeTokenHandler));return[...this.drcs_units,It(t)]}encodeCharacter({character:e}){if(di.ASCII.has(e))switch(this.mode){case"MACRO0":return Uint8Array.from([...di.ASCII.get(e).map(e=>128|e)]).buffer;case"MACRO1":return this.mode="MACRO0",Uint8Array.from([29,96,st,ut,...di.ASCII.get(e).map(e=>128|e)]).buffer;default:throw new A(this.mode,"Unexpected mode in ARIBB24JapaneseJIS8Encoder")}else{if(di.HIRAGANA.has(e))return Uint8Array.from([25,...di.HIRAGANA.get(e)]).buffer;if(!di.KATAKANA.has(e)){if(di.KANJI.has(e))return Uint8Array.from(di.KANJI.get(e)).buffer;throw new w("Unsupported Character in JIS8 Encoder")}switch(this.mode){case"MACRO0":return this.mode="MACRO1",Uint8Array.from([29,97,st,ut,...di.KATAKANA.get(e).map(e=>128|e)]).buffer;case"MACRO1":return Uint8Array.from([...di.KATAKANA.get(e).map(e=>128|e)]).buffer;default:throw new A(this.mode,"Unexpected mode in ARIBB24JapaneseJIS8Encoder")}}}encodeDRCS(e){const t=nt(e.binary);if(!this.drcs_md5_to_code.has(t)){if(127===this.current_drcs_code[0]&&127===this.current_drcs_code[1])return Uint8Array.from(di.KANJI.get("〓")).buffer;const r=Uint8Array.from([1,this.current_drcs_code[0],this.current_drcs_code[1],1,0,2**e.depth-2,e.width,e.width]).buffer;this.drcs_units.push(Rt(ii(r,e.binary),2)),this.drcs_md5_to_code.set(t,structuredClone(this.current_drcs_code)),this.current_drcs_code[1]++,this.current_drcs_code[1]>127&&(this.current_drcs_code[0]++,this.current_drcs_code[1]=0)}return this.mode="MACRO0",Uint8Array.from([st,36,41,32,64,...this.drcs_md5_to_code.get(t).map(e=>128|e),29,96,st,ut])}encodeBitmap(e){throw new m("Bitmap is Not Implemented")}encodeMosaic(e){throw new m("Mozaic Character is Not Implemented")}}const hi=188,ui=2**33,fi=e=>!!(64&e[1]),pi=e=>(31&e[1])<<8|e[2],gi=e=>!!(32&e[3]),mi=e=>gi(e)?e[4]:0;class bi extends TransformStream{constructor(e,t){let r=new Uint8Array;super({transform(e,t){{const t=r;r=new Uint8Array(r.byteLength+e.byteLength),r.set(t,0),r.set(e,t.byteLength)}for(let e=0;e<r.byteLength;e++)if(71===r[e]){if(e+hi>r.byteLength)return void(r=r.slice(e));t.enqueue(r.slice(e,e+hi)),e+=187}r=new Uint8Array}},e,t)}}const wi=e=>(15&e[1])<<8|e[2],Fi=(e,t=0,r=e.byteLength)=>{let i=4294967295;for(let a=t;a<r;a++)for(let t=7;t>=0;t--){const r=2147483648&i?1:0;i<<=1,r^(e[a]&1<<t)>>t&&(i^=79764919),i&=4294967295}return i};class Ai{accendant=new Uint8Array;*feed(e){let t=4+(gi(e)?1+mi(e):0);if(fi(e)&&(t+=1),0==this.accendant.byteLength){if(!fi(e))return;t+=(e=>e[4+(gi(e)?1+mi(e):0)])(e)}else{const r=t+Math.max(0,3+wi(this.accendant)-this.accendant.length);if(r>hi){const r=this.accendant;return this.accendant=new Uint8Array(this.accendant.byteLength+(hi-t)),this.accendant.set(r,0),void this.accendant.set(e.slice(t),r.byteLength)}{const i=new Uint8Array(this.accendant.byteLength+(r-t));i.set(this.accendant,0),i.set(e.slice(t,r),this.accendant.byteLength),this.accendant=new Uint8Array,yield i,t=r}}if(fi(e))for(;t<hi&&255!==e[t];){const r=t+Math.max(0,3+wi(e.slice(t)));if(r>hi){this.accendant=e.slice(t);break}yield e.slice(t,r),t=r}}}const Ui=e=>{const t=[],r=3+wi(e)-4;for(let i=8;i<r;i+=4){const r=e[i+0]<<8|e[i+1],a=(31&e[i+2])<<8|e[i+3];0!==r&&t.push({program_number:r,program_map_PID:a})}return t},yi=e=>{const t=[],r=(15&e[10])<<8|e[11],i=3+wi(e)-4;let a=12+r;for(;a<i;){const r=e[a+0],i=(31&e[a+1])<<8|e[a+2],n=(15&e[a+3])<<8|e[a+4];let s=null;switch(r){case 1:case 2:case 27:case 36:s="VIDEO";break;case 3:case 4:case 15:case 17:s="AUDIO"}let o=a+5;for(;o<a+5+n;){const t=e[o+0],i=e[o+1];if(82===t){const t=e[o+2];6===r&&48===t?s="ARIBB24_CAPTION":6===r&&56===t&&(s="ARIBB24_SUPERIMPOSE")}o+=2+i}null!=s&&t.push({type:s,elementary_PID:i}),a+=5+n}return t},Ci=6,Si=e=>e[4]<<8|e[5],ki=e=>{const t=(e=>e[3])(e);return 188!==t&&190!==t&&191!==t&&240!==t&&241!==t&&255!==t&&242!==t&&248!==t},vi=e=>!!ki(e)&&!!(128&e[Ci+1]),Ti=e=>{if(!vi(e))return null;let t=0;return t*=8,t+=(14&e[Ci+3+0])>>1,t*=256,t+=255&e[Ci+3+1],t*=128,t+=(254&e[Ci+3+2])>>1,t*=256,t+=255&e[Ci+3+3],t*=128,t+=(254&e[Ci+3+4])>>1,t},Mi=e=>{if(!(e=>!!ki(e)&&!!(64&e[Ci+1]))(e))return null;const t=vi(e)?5:0;let r=0;return r*=8,r+=(14&e[Ci+3+t+0])>>1,r*=256,r+=255&e[Ci+3+t+1],r*=128,r+=(254&e[Ci+3+t+2])>>1,r*=256,r+=255&e[Ci+3+t+3],r*=128,r+=(254&e[Ci+3+t+4])>>1,r},_i=e=>ki(e)?3+e[Ci+2]:0;class Di{accendant=new Uint8Array;*feed(e){const t=e.slice(4+(gi(e)?1+mi(e):0));if(fi(e))this.accendant.byteLength>0&&0===Si(this.accendant)&&(yield this.accendant),this.accendant=t;else if(this.accendant.byteLength>0){const e=this.accendant;this.accendant=new Uint8Array(this.accendant.byteLength+t.byteLength),this.accendant.set(e,0),this.accendant.set(t,e.byteLength)}var r;r=this.accendant,0!==Si(r)&&r.byteLength>=Ci+Si(r)&&(yield this.accendant.slice(0,Ci+Si(this.accendant)),this.accendant=new Uint8Array)}}async function*Ii(e,t){const r=e.pipeThrough(new bi),i=new Ai,a=new Ai,n=new Di,s=new Map;let o=null,c=null,l="NONE"===(t?.offset??"BOTH")?0:null;const d=r.getReader();for(;;){const{value:e,done:r}=await d.read();if(r)return;const h=pi(e);if(0===h)for(const r of i.feed(e)){if(0!==Fi(r))continue;const e=t?.serviceId??null;o=Ui(r).find(({program_number:t})=>null==e||e===t)?.program_map_PID??null}else if(h===o)for(const r of a.feed(e)){if(0!==Fi(r))continue;const e=yi(r);c=e.find(e=>"Superimpose"===t?.type?"ARIBB24_SUPERIMPOSE"===e.type:"ARIBB24_CAPTION"===e.type)?.elementary_PID??null;for(const r of e){const e=("VIDEO"===t?.offset||"BOTH"===t?.offset||null==t?.offset)&&"VIDEO"===r.type,i=("AUDIO"===t?.offset||"BOTH"===t?.offset||null==t?.offset)&&"AUDIO"===r.type;(e||i)&&(s.has(r.elementary_PID)||s.set(r.elementary_PID,new Di))}}else if(s.has(h)&&null==l)for(const t of s.get(h).feed(e)){const e=Ti(t);null!=e&&(l??=e)}else if(h===c)for(const t of n.feed(e)){if(null==l)continue;const e=t.slice(Ci+_i(t)),r=Dt(new Uint8Array(e).buffer);if(null==r)continue;const i=Et(r.data);null!=i&&(yield{tag:r.tag,pts:(ui+Ti(t)-l)%ui/9e4,dts:(ui+(Mi(t)??Ti(t))-l)%ui/9e4,data:i})}}}class Ri{buffers=[];build(){return ii(...this.buffers)}write(e){this.buffers.push(e)}writeU8(e){const t=new DataView(new ArrayBuffer(1));t.setUint8(0,e),this.buffers.push(t.buffer)}writeU16(e){const t=new DataView(new ArrayBuffer(2));t.setUint16(0,e,!1),this.buffers.push(t.buffer)}writeU24(e){const t=new DataView(new ArrayBuffer(3));t.setUint16(0,(16776960&e)>>8,!1),t.setUint8(2,255&e),this.buffers.push(t.buffer)}writeU32(e){const t=new DataView(new ArrayBuffer(4));t.setUint32(0,e,!1),this.buffers.push(t.buffer)}}const Bi=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920],xi=(e,t=0,r)=>{null==r&&(r=e.length);let i=0;for(let a=t;a<r;a++)i=65535&(i<<8^Bi[255&(i>>8^e[a])]);return i},Ei=e=>{switch(e.tag){case"Statement":return 32;case"DRCS":return 2===e.bytes?49:48;case"Bitmap":return 53;default:throw new A(e,"Unexpected Data Unit in STD-B24 ARIB Caption")}},Ni=e=>{const t=new Ri;for(const r of e.units)t.writeU8(31),t.writeU8(Ei(r)),t.writeU24(r.data.byteLength),t.write(r.data);const r=t.build();switch(e.tag){case"CaptionManagement":{const t=new Ri;for(const r of e.languages)t.writeU8(r.lang<<5|16|r.displayMode),12!==r.displayMode&&13!==r.displayMode&&14!==r.displayMode||t.writeU8(r.displayConditionDesignation),t.writeU8(r.iso_639_language_code.charCodeAt(0)),t.writeU8(r.iso_639_language_code.charCodeAt(1)),t.writeU8(r.iso_639_language_code.charCodeAt(2)),t.writeU8(r.format<<4|r.TCS<<2|r.rollup);const i=t.build(),a=new Ri;if(a.writeU8(e.timeControlMode<<6|63),2===e.timeControlMode){const t=Math.floor(e.offsetTime[0]/10)<<4|e.offsetTime[0]%10,r=Math.floor(e.offsetTime[1]/10)<<4|e.offsetTime[1]%10,i=Math.floor(e.offsetTime[2]/10)<<4|e.offsetTime[2]%10,n=Math.floor(e.offsetTime[3]/100)<<4|Math.floor(e.offsetTime[3]/10)%10,s=Math.floor(e.offsetTime[3]%10)<<4|15;a.writeU8(t),a.writeU8(r),a.writeU8(i),a.writeU8(n),a.writeU8(s)}a.writeU8(e.languages.length),a.write(i),a.writeU24(r.byteLength),a.write(r);const n=a.build(),s=new Ri;return s.writeU8(e.group<<7),s.writeU8(0),s.writeU8(0),s.writeU16(n.byteLength),s.write(n),s.writeU16(xi(new Uint8Array(s.build()))),s.build()}case"CaptionStatement":{const t=new Ri;if(t.writeU8(e.timeControlMode<<6|63),1===e.timeControlMode||2===e.timeControlMode){const r=Math.floor(e.presentationStartTime[0]/10)<<4|e.presentationStartTime[0]%10,i=Math.floor(e.presentationStartTime[1]/10)<<4|e.presentationStartTime[1]%10,a=Math.floor(e.presentationStartTime[2]/10)<<4|e.presentationStartTime[2]%10,n=Math.floor(e.presentationStartTime[2]/100)<<4|e.presentationStartTime[2]/10%10,s=Math.floor(e.presentationStartTime[2]%10)<<4|15;t.writeU8(r),t.writeU8(i),t.writeU8(a),t.writeU8(n),t.writeU8(s)}t.writeU24(r.byteLength),t.write(r);const i=t.build(),a=new Ri;return a.writeU8(e.group<<7|e.lang+1<<2),a.writeU8(0),a.writeU8(0),a.writeU16(i.byteLength),a.write(i),a.writeU16(xi(new Uint8Array(a.build()))),a.build()}default:throw new A(e,"Unexpected STD-B24 ARIB Caption Content")}},Li=e=>{const t=new Uint8Array(3+e.data.byteLength);switch(e.tag){case"Caption":return t[0]=128,t[1]=255,t[2]=0,t.set(new Uint8Array(e.data),3),t.buffer;case"Superimpose":return t[0]=129,t[1]=255,t[2]=0,t.set(new Uint8Array(e.data),3),t.buffer;default:throw new A(e,"Unexpected ARIB Caption Type")}},$i=e=>{switch(e.tag){case"Statement":return 32;case"DRCS":return 2===e.bytes?49:48;case"Bitmap":return 53;default:throw new A(e,"Unexpected Data Unit in STD-B24 ARIB Caption")}},Pi=e=>{const t=new Ri;for(const r of e.units)t.writeU8(31),t.writeU8($i(r)),t.writeU24(r.data.byteLength),t.write(r.data);const r=t.build();switch(e.tag){case"CaptionManagement":{const t=new Ri;if(1!==e.languages.length)throw new b("ARIB STD-B36 must only one language");for(const r of e.languages)t.writeU8(16|r.displayMode),t.writeU8(0),t.writeU8(r.iso_639_language_code.charCodeAt(0)),t.writeU8(r.iso_639_language_code.charCodeAt(1)),t.writeU8(r.iso_639_language_code.charCodeAt(2)),t.writeU8(r.format<<4|r.TCS<<2|r.rollup);const r=t.build(),i=new Ri;if(i.writeU8(63),0!==e.timeControlMode)throw new b("TimeControlMode (TMD) must be 0 (FREE)");i.writeU8(0),i.writeU8(0),i.writeU8(0),i.writeU8(0),i.writeU8(15),i.writeU8(0),i.write(r);const a=i.build(),n=new Ri;return n.writeU8(0),n.writeU8(0),n.writeU8(0),n.writeU16(a.byteLength),n.write(a),n.build()}case"CaptionStatement":{const t=new Ri;if(t.writeU8(63),0!==e.timeControlMode)throw new b("TimeControlMode (TMD) must be 0 (FREE)");t.writeU8(0),t.writeU8(0),t.writeU8(0),t.writeU8(0),t.writeU8(15),t.writeU24(r.byteLength),t.write(r);const i=t.build(),a=new Ri;return a.writeU8(4),a.writeU8(0),a.writeU8(0),a.writeU16(i.byteLength),a.write(i),a.build()}default:throw new A(e,"Unexpected STD-B24 ARIB Caption Content")}},zi=new TextDecoder("shift-jis",{fatal:!0}),Oi=new Map;for(const[e,t]of[[0,128],[161,223]])for(let r=e;r<t;r++){const e=[r],t=Uint8Array.from(e);try{Oi.set(zi.decode(t),e)}catch(e){}}for(const[e,t]of[[129,159],[224,239]])for(let r=e;r<t;r++){for(let e=64;e<=126;e++){const t=[r,e],i=Uint8Array.from(t);try{Oi.set(zi.decode(i),t)}catch(e){}}for(let e=128;e<=252;e++){const t=[r,e],i=Uint8Array.from(t);try{Oi.set(zi.decode(i),t)}catch(e){}}}const Hi=e=>{const t=256,r=new Ri;for(let t=0;t<e.label.length;t++)r.writeU8(e.label.charCodeAt(t));for(let i=e.label.length;i<t;i++)r.writeU8(32);const i=new Ri;{const t=Array.from(e.broadcasterIdentification);if(t.some(e=>!Oi.has(e)))throw new b("broadcasterIdentification cannot convert to shift-jis");const r=t.flatMap(e=>Oi.get(e));if(r.length>6)throw new b("broadcasterIdentification byteLength exceeded");for(;r.length<6;)r.push(" ".charCodeAt(0));i.write(Uint8Array.from(r).buffer)}{const t=Array.from(e.materialNumber);if(t.some(e=>!Oi.has(e)))throw new b("materialNumber cannot convert to shift-jis");const r=t.flatMap(e=>Oi.get(e));if(r.length>27)throw new b("materialNumber byteLength exceeded");for(;r.length<27;)r.push(" ".charCodeAt(0));i.write(Uint8Array.from(r).buffer)}{const t=Array.from(e.programTitle);if(t.some(e=>!Oi.has(e)))throw new b("programTitle cannot convert to shift-jis");const r=t.flatMap(e=>Oi.get(e));if(r.length>40)throw new b("programTitle byteLength exceeded");for(;r.length<40;)r.push(" ".charCodeAt(0));i.write(Uint8Array.from(r).buffer)}{const t=Array.from(e.programSubtitle);if(t.some(e=>!Oi.has(e)))throw new b("programSubtitle cannot convert to shift-jis");const r=t.flatMap(e=>Oi.get(e));if(r.length>40)throw new b("programSubtitle byteLength exceeded");for(;r.length<40;)r.push(" ".charCodeAt(0));i.write(Uint8Array.from(r).buffer)}if(i.writeU8(e.programMaterialType.charCodeAt(0)),i.writeU8(e.registrationMode.charCodeAt(0)),3!==e.languageCode.length)throw new b("languageCode length must be 3");if(/[^a-z]/.test(e.languageCode))throw new b("languageCode length must lowercase");for(let t=0;t<3;t++)i.writeU8(e.languageCode.charCodeAt(t));for(let t=0;t<2;t++)i.writeU8(e.displayMode.charCodeAt(t));i.writeU8(e.programType.charCodeAt(0)),i.writeU8((e.sound?"*":" ").charCodeAt(0));{const t=e.totalPages.toString(10).padStart(4,"0");for(let e=0;e<4;e++)i.writeU8(t.charCodeAt(e))}{const t=e.totalBytes.toString(10).padStart(8,"0");for(let e=0;e<8;e++)i.writeU8(t.charCodeAt(e))}i.writeU8((e.untime?"*":" ").charCodeAt(0));for(let t=0;t<2;t++)i.writeU8(e.realtimeTimingType.charCodeAt(t));switch(i.writeU8(e.timingUnitType.charCodeAt(0)),e.timingUnitType){case sr:{const t=rr(e.initialTime).replaceAll(/[:;]/g,"");for(let e=0;e<8;e++)i.writeU8(t.charCodeAt(e));i.writeU8("F".charCodeAt(0));break}case nr:{const t=Math.ceil(100*e.initialTime)%100,r=Math.floor(e.initialTime)%60,a=Math.floor((e.initialTime-r)/60)%60,n=`${Math.floor((e.initialTime-r-60*a)/3600).toString(10).padStart(2,"0")}${a.toString(10).padStart(2,"0")}${r.toString(10).padStart(2,"0")}${t.toString(10).padStart(2,"0")}`;for(let e=0;e<8;e++)i.writeU8(n.charCodeAt(e));i.writeU8("0".charCodeAt(0));break}}i.writeU8(e.syncronizationMode.charCodeAt(0));for(let t=0;t<2;t++)i.writeU8(e.timeControlMode.charCodeAt(t));for(let t=0;t<8;t++)i.writeU8((e.extensible[t]?"*":" ").charCodeAt(0));for(let t=0;t<8;t++)i.writeU8((e.compatible[t]?"*":" ").charCodeAt(0));if(null==e.expireDate)for(let e=0;e<8;e++)i.writeU8(" ".charCodeAt(0));else{const t=`${e.expireDate[0].toString(10).padStart(4,"0")}${e.expireDate[1].toString(10).padStart(2,"0")}${e.expireDate[2].toString(10).padStart(2,"0")}`;for(let e=0;e<8;e++)i.writeU8(t.charCodeAt(e))}{const t=Array.from(e.author);if(t.some(e=>!Oi.has(e)))throw new b("author cannot convert to shift-jis");const r=t.flatMap(e=>Oi.get(e));if(r.length>20)throw new b("author byteLength exceeded");for(;r.length<20;)r.push(" ".charCodeAt(0));i.write(Uint8Array.from(r).buffer)}if(null!=e.creationDateTime){const t=`${e.creationDateTime[0].toString(10).padStart(4,"0")}${e.creationDateTime[1].toString(10).padStart(2,"0")}${e.creationDateTime[2].toString(10).padStart(2,"0")}${e.creationDateTime[3].toString(10).padStart(2,"0")}${e.creationDateTime[4].toString(10).padStart(2,"0")}`;for(let e=0;e<12;e++)i.writeU8(t.charCodeAt(e))}else for(let e=0;e<12;e++)i.writeU8(" ".charCodeAt(0));if(null!=e.broadcastStartDate){const t=`${e.broadcastStartDate[0].toString(10).padStart(4,"0")}${e.broadcastStartDate[1].toString(10).padStart(2,"0")}${e.broadcastStartDate[2].toString(10).padStart(2,"0")}`;for(let e=0;e<8;e++)i.writeU8(t.charCodeAt(e))}else for(let e=0;e<8;e++)i.writeU8(" ".charCodeAt(0));if(null!=e.broadcastEndDate){const t=`${e.broadcastEndDate[0].toString(10).padStart(4,"0")}${e.broadcastEndDate[1].toString(10).padStart(2,"0")}${e.broadcastEndDate[2].toString(10).padStart(2,"0")}`;for(let e=0;e<8;e++)i.writeU8(t.charCodeAt(e))}else for(let e=0;e<8;e++)i.writeU8(" ".charCodeAt(0));for(let t=0;t<7;t++)i.writeU8((e.broadcastDaysOfWeek[t]?"*":" ").charCodeAt(0));if(null!=e.broadcastStartTime){const t=`${e.broadcastStartTime[0].toString(10).padStart(2,"0")}${e.broadcastStartTime[1].toString(10).padStart(2,"0")}${e.broadcastStartTime[2].toString(10).padStart(2,"0")}`;for(let e=0;e<6;e++)i.writeU8(t.charCodeAt(e))}else for(let e=0;e<6;e++)i.writeU8(" ".charCodeAt(0));if(null!=e.broadcastEndTime){const t=`${e.broadcastEndTime[0].toString(10).padStart(2,"0")}${e.broadcastEndTime[1].toString(10).padStart(2,"0")}${e.broadcastEndTime[2].toString(10).padStart(2,"0")}`;for(let e=0;e<6;e++)i.writeU8(t.charCodeAt(e))}else for(let e=0;e<6;e++)i.writeU8(" ".charCodeAt(0));{const t=Array.from(e.memo);if(t.some(e=>!Oi.has(e)))throw new b("memo cannot convert to shift-jis");const r=t.flatMap(e=>Oi.get(e));if(r.length>60)throw new b("memo byteLength exceeded");for(;r.length<60;)r.push(" ".charCodeAt(0));i.write(Uint8Array.from(r).buffer)}for(let e=0;e<45;e++)i.writeU8(" ".charCodeAt(0));i.writeU8((e.completed?"*":" ").charCodeAt(0)),i.writeU8((e.usersAreaUsed?"*":" ").charCodeAt(0)),e.usersAreaUsed&&(i.writeU8(e.writingFormatConversionMode),i.writeU8(e.drcsConversionMode<<6|63));const a=i.build();r.writeU32(a.byteLength),r.write(a),r.write(new ArrayBuffer(Math.floor((4+a.byteLength+255)/t)*t-(4+a.byteLength)));for(const i of e.pages){const e=new Ri;for(let t=0;t<6;t++)e.writeU8(i.pageNumber.charCodeAt(t));e.writeU8(i.pageMaterialType.charCodeAt(0));for(let t=0;t<2;t++)e.writeU8(i.displayTimingType.charCodeAt(t));for(let t=0;t<1;t++)e.writeU8(i.timingUnitType.charCodeAt(t));switch(i.timingUnitType){case sr:{const t=rr(i.displayTiming).replaceAll(/[:;]/g,"");for(let r=0;r<8;r++)e.writeU8(t.charCodeAt(r));e.writeU8("F".charCodeAt(0));break}case nr:{const t=Math.round(100*i.displayTiming)%100,r=Math.floor(i.displayTiming)%60,a=Math.floor((i.displayTiming-r)/60)%60,n=`${Math.floor((i.displayTiming-r-60*a)/3600).toString(10).padStart(2,"0")}${a.toString(10).padStart(2,"0")}${r.toString(10).padStart(2,"0")}${t.toString(10).padStart(2,"0")}`;for(let t=0;t<8;t++)e.writeU8(n.charCodeAt(t));e.writeU8("0".charCodeAt(0));break}}if(i.clearTiming===Number.POSITIVE_INFINITY)for(let t=0;t<9;t++)e.writeU8(" ".charCodeAt(0));else switch(i.timingUnitType){case sr:{const t=rr(i.clearTiming).replaceAll(/[:;]/g,"");for(let r=0;r<8;r++)e.writeU8(t.charCodeAt(r));e.writeU8("F".charCodeAt(0));break}case nr:{const t=Math.round(100*i.clearTiming)%100,r=Math.floor(i.clearTiming)%60,a=Math.floor((i.clearTiming-r)/60)%60,n=`${Math.floor((i.clearTiming-r-60*a)/3600).toString(10).padStart(2,"0")}${a.toString(10).padStart(2,"0")}${r.toString(10).padStart(2,"0")}${t.toString(10).padStart(2,"0")}`;for(let t=0;t<8;t++)e.writeU8(n.charCodeAt(t));e.writeU8("0".charCodeAt(0));break}}for(let t=0;t<2;t++)e.writeU8(i.timeControlMode.charCodeAt(t));for(let t=0;t<3;t++)e.writeU8((i.clearScreen?"OFF":"   ").charCodeAt(t));for(let t=0;t<3;t++)e.writeU8(i.displayFormat.charCodeAt(t));for(let t=0;t<1;t++)e.writeU8(i.displayAspectRatio.charCodeAt(t));if(null==i.displayWindowArea)for(let t=0;t<16;t++)e.writeU8(" ".charCodeAt(0));else{const t=i.displayWindowArea[0][0].toString(10).padStart(4,"0"),r=i.displayWindowArea[0][1].toString(10).padStart(4,"0"),a=i.displayWindowArea[1][0].toString(10).padStart(4,"0"),n=i.displayWindowArea[1][1].toString(10).padStart(4,"0");for(let r=0;r<4;r++)e.writeU8(t.charCodeAt(r));for(let t=0;t<4;t++)e.writeU8(r.charCodeAt(t));for(let t=0;t<4;t++)e.writeU8(a.charCodeAt(t));for(let t=0;t<4;t++)e.writeU8(n.charCodeAt(t))}e.writeU8(i.scrollType.charCodeAt(0)),e.writeU8(i.scrollDirectionType.charCodeAt(0)),e.writeU8((i.sound?"*":" ").charCodeAt(0));{const t=i.pageDataBytes.toString(10).padStart(5,"0");for(let r=0;r<5;r++)e.writeU8(t.charCodeAt(r))}for(let t=0;t<3;t++)e.writeU8((i.deleted?"ERS":"   ").charCodeAt(t));{const t=Array.from(i.memo);if(t.some(e=>!Oi.has(e)))throw new b("memo cannot convert to shift-jis");const r=t.flatMap(e=>Oi.get(e));if(r.length>20)throw new b("memo byteLength exceeded");for(;r.length<20;)r.push(" ".charCodeAt(0));e.write(Uint8Array.from(r).buffer)}for(let t=0;t<32;t++)e.writeU8(" ".charCodeAt(0));e.writeU8((i.completed?"*":" ").charCodeAt(0)),e.writeU8((i.usersAreaUsed?"*":" ").charCodeAt(0)),i.usersAreaUsed&&(e.writeU8(i.writingFormatConversionMode),e.writeU8(i.drcsConversionMode<<6|63));const a=e.build(),n=Pi(i.management),s="ReservedPage"!==i.tag?Pi(i.statement):new ArrayBuffer(0),o=3+a.byteLength+(3+n.byteLength)+("ReservedPage"!==i.tag?4+s.byteLength:0);r.writeU32(o),r.writeU8(42),r.writeU16(a.byteLength),r.write(a),r.writeU8(58),r.writeU16(n.byteLength),r.write(n),"ActualPage"===i.tag&&(r.writeU8(74),r.writeU24(s.byteLength),r.write(s)),r.write(new ArrayBuffer(Math.floor((4+o+255)/t)*t-(4+o)))}return r.build()};return t})());